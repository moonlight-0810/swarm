<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwarmChemistry - Cloud Edition</title>
    
    <!-- ONNX.js for AI embedding generation -->
    <script src="https://cdn.jsdelivr.net/npm/onnxjs/dist/onnx.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            background: #0a0a0a;
            color: #7fb069;
            min-height: 100vh;
            overflow-x: auto;
            image-rendering: pixelated;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 255, 198, 0.1) 0%, transparent 50%);
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #c8526d, #7d5fb8, #5b8fd8, #5fbfa3);
            background-size: 400% 400%;
            animation: gradientShift 3s ease infinite;
            padding: 20px;
            border: 3px solid #7fb069;
            border-radius: 0;
            box-shadow: 
                0 0 0 3px #c8526d,
                0 0 0 6px #7d5fb8,
                0 0 20px rgba(127, 176, 105, 0.3);
            position: relative;
        }
        
        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #000000;
            border: 3px solid #5fbfa3;
            padding: 8px 12px;
            border-radius: 0;
            z-index: 100;
            box-shadow: 
                0 0 0 3px #c8526d,
                0 0 15px rgba(95, 191, 163, 0.3);
        }
        
        .language-selector select {
            background: #000000;
            color: #7fb069;
            border: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            outline: none;
        }
        
        .language-selector select option {
            background: #000000;
            color: #7fb069;
            padding: 5px;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            color: #ffffff;
            text-shadow: 
                2px 2px 0px #000000,
                4px 4px 0px #c8526d,
                6px 6px 0px #7d5fb8;
            font-weight: 700;
            letter-spacing: 2px;
        }
        
        .concept-header-btn {
            background: linear-gradient(45deg, #c8526d, #7d5fb8) !important;
            border: 3px solid #7fb069 !important;
            color: #ffffff !important;
            padding: 15px 25px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            font-family: 'JetBrains Mono', monospace !important;
            text-transform: uppercase !important;
            letter-spacing: 2px !important;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: conceptHeaderPulse 3s ease-in-out infinite;
            box-shadow: 
                0 4px 0 #6a4c96,
                0 8px 15px rgba(200, 82, 109, 0.25) !important;
        }
        
        .concept-header-btn:hover {
            transform: translateY(-3px) scale(1.05) !important;
            box-shadow: 
                0 7px 0 #6a4c96,
                0 15px 25px rgba(200, 82, 109, 0.4) !important;
            animation: none !important;
        }
        
        .concept-header-btn:active {
            transform: translateY(1px) scale(1.02) !important;
            box-shadow: 
                0 3px 0 #6a4c96,
                0 6px 12px rgba(200, 82, 109, 0.3) !important;
        }
        
        @keyframes conceptHeaderPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 0 #6a4c96, 0 8px 15px rgba(200, 82, 109, 0.25);
            }
            50% { 
                transform: scale(1.03);
                box-shadow: 0 6px 0 #6a4c96, 0 12px 20px rgba(200, 82, 109, 0.35);
            }
        }
        
        .header p {
            font-size: 1.1em;
            color: #ffffff;
            text-shadow: 1px 1px 0px #000000;
            font-weight: 600;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 650px 1fr;
            gap: 30px;
            align-items: start;
        }
        
        .canvas-section {
            background: #1a1a1a;
            border: 4px solid #7fb069;
            padding: 25px;
            box-shadow: 
                0 0 0 4px #c8526d,
                0 0 0 8px #7d5fb8,
                0 0 30px rgba(127, 176, 105, 0.2);
            position: relative;
        }
        
        .canvas-section::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            background: linear-gradient(45deg, #c8526d, #7d5fb8, #5b8fd8, #5fbfa3);
            z-index: -1;
            border-radius: 0;
        }
        
        .controls-section {
            background: #1a1a1a;
            border: 4px solid #c8526d;
            padding: 25px;
            box-shadow: 
                0 0 0 4px #7fb069,
                0 0 0 8px #7d5fb8,
                0 0 30px rgba(200, 82, 109, 0.2);
            height: 850px;
            overflow-y: auto;
            position: relative;
        }
        
        .controls-section::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            background: linear-gradient(135deg, #7d5fb8, #5b8fd8, #5fbfa3, #c8526d);
            z-index: -1;
        }
        
        canvas {
            border: 4px solid #5fbfa3;
            background: #000;
            display: block;
            margin: 0 auto;
            box-shadow: 
                0 0 0 4px #5b8fd8,
                0 0 20px rgba(95, 191, 163, 0.3),
                inset 0 0 50px rgba(95, 191, 163, 0.05);
            image-rendering: pixelated;
        }
        
        .canvas-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #7d5fb8;
            position: relative;
        }
        
        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .control-group::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #c8526d, #7d5fb8, #5b8fd8, #5fbfa3);
            animation: gradientShift 2s ease infinite;
        }
        
        .control-group h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #5fbfa3;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 0px #000000;
        }
        
        /* 新的主标题样式（原意识语） */
        .step-main-title {
            margin: 0 0 12px 0 !important;
            font-size: 20px !important;
            color: #c8526d !important;
            font-weight: 700 !important;
            font-style: normal !important;
            text-shadow: 2px 2px 0px #000000 !important;
            border-left: 4px solid #c8526d !important;
            padding-left: 12px !important;
            animation: mainTitlePulse 3s ease-in-out infinite !important;
            text-transform: none !important;
            letter-spacing: 0.5px !important;
            line-height: 1.3 !important;
        }
        
        /* 新的副标题样式（原主标题） */
        .step-subtitle {
            margin: 0 0 20px 0;
            font-size: 16px;
            color: #5fbfa3;
            font-weight: 600;
            font-style: normal;
            text-shadow: 1px 1px 0px #000000;
            line-height: 1.4;
            opacity: 0.9;
        }
        
        @keyframes mainTitlePulse {
            0%, 100% { opacity: 0.85; }
            50% { opacity: 1.0; }
        }
        
        /* 分隔线样式 */
        .section-divider {
            display: flex;
            align-items: center;
            margin: 30px 0;
            gap: 15px;
        }
        
        .divider-line {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent, #7d5fb8, transparent);
        }
        
        .divider-text {
            color: #7d5fb8;
            font-weight: 700;
            font-size: 14px;
            padding: 8px 15px;
            background: #1a1a1a;
            border: 2px solid #7d5fb8;
            border-radius: 0;
            text-shadow: 1px 1px 0px #000000;
            letter-spacing: 1px;
        }
        
        /* 彩色按钮样式 */
        button {
            border: 3px solid;
            color: #000000;
            padding: 12px 20px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            text-shadow: none;
        }
        
        /* 默认按钮 - 绿色 */
        button {
            background: #5fbfa3;
            border-color: #7fb069;
            box-shadow: 
                0 4px 0 #4da382,
                0 8px 15px rgba(95, 191, 163, 0.25);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 0 #4da382,
                0 12px 20px rgba(95, 191, 163, 0.35);
        }
        
        button:active {
            transform: translateY(2px);
            box-shadow: 
                0 2px 0 #4da382,
                0 4px 10px rgba(95, 191, 163, 0.25);
        }
        
        /* Canvas控制按钮 - 不同颜色 */
        .canvas-controls button:nth-child(1) {
            background: #c8526d;
            border-color: #d45675;
            color: #ffffff;
            box-shadow: 
                0 4px 0 #a3425c,
                0 8px 15px rgba(200, 82, 109, 0.25);
        }
        
        .canvas-controls button:nth-child(1):hover {
            box-shadow: 
                0 6px 0 #a3425c,
                0 12px 20px rgba(200, 82, 109, 0.35);
        }
        
        .canvas-controls button:nth-child(2) {
            background: #d2a841;
            border-color: #d4b246;
            color: #000000;
            box-shadow: 
                0 4px 0 #a88735,
                0 8px 15px rgba(210, 168, 65, 0.25);
        }
        
        .canvas-controls button:nth-child(2):hover {
            box-shadow: 
                0 6px 0 #a88735,
                0 12px 20px rgba(210, 168, 65, 0.35);
        }
        
        .canvas-controls button:nth-child(3) {
            background: #5b8fd8;
            border-color: #6b9ddb;
            color: #ffffff;
            box-shadow: 
                0 4px 0 #4a76b0,
                0 8px 15px rgba(91, 143, 216, 0.25);
        }
        
        .canvas-controls button:nth-child(3):hover {
            box-shadow: 
                0 6px 0 #4a76b0,
                0 12px 20px rgba(91, 143, 216, 0.35);
        }
        
        .canvas-controls .sync-button {
            background: linear-gradient(45deg, #c8526d, #7d5fb8) !important;
            border-color: #7fb069 !important;
            color: #ffffff !important;
            font-weight: 700 !important;
            font-size: 14px !important;
            padding: 12px 20px !important;
            animation: pulse 2s ease-in-out infinite !important;
            box-shadow: 
                0 4px 0 #6a4c96,
                0 8px 20px rgba(200, 82, 109, 0.3) !important;
        }
        
        .canvas-controls .sync-button:hover {
            animation: none !important;
            transform: translateY(-3px) !important;
            box-shadow: 
                0 7px 0 #6a4c96,
                0 15px 25px rgba(200, 82, 109, 0.4) !important;
        }
        
        .canvas-controls .sync-button:active {
            transform: translateY(2px) !important;
            box-shadow: 
                0 2px 0 #6a4c96,
                0 4px 10px rgba(200, 82, 109, 0.25) !important;
        }
        
        /* 预设按钮网格 */
        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .preset-buttons button:nth-child(odd) {
            background: #c8526d;
            border-color: #d45675;
            color: #ffffff;
            box-shadow: 
                0 4px 0 #a3425c,
                0 8px 15px rgba(200, 82, 109, 0.25);
        }
        
        .preset-buttons button:nth-child(even) {
            background: #7d5fb8;
            border-color: #8c6ec4;
            color: #ffffff;
            box-shadow: 
                0 4px 0 #6a4c96,
                0 8px 15px rgba(125, 95, 184, 0.25);
        }
        
        .preset-buttons button:nth-child(3n) {
            background: #5b8fd8;
            border-color: #6b9ddb;
            color: #ffffff;
            box-shadow: 
                0 4px 0 #4a76b0,
                0 8px 15px rgba(91, 143, 216, 0.25);
        }
        
        .preset-buttons button:nth-child(4n) {
            background: #5fbfa3;
            border-color: #7fb069;
            color: #000000;
            box-shadow: 
                0 4px 0 #4da382,
                0 8px 15px rgba(95, 191, 163, 0.25);
        }
        
        .preset-buttons button:nth-child(5n) {
            background: #d2a841;
            border-color: #d4b246;
            color: #000000;
            box-shadow: 
                0 4px 0 #a88735,
                0 8px 15px rgba(210, 168, 65, 0.25);
        }
        
        /* 同步按钮特殊样式 */
        .sync-button {
            background: linear-gradient(45deg, #c8526d, #7d5fb8) !important;
            border-color: #7fb069 !important;
            color: #ffffff !important;
            font-weight: 700 !important;
            font-size: 16px !important;
            padding: 15px 30px !important;
            animation: pulse 2s ease-in-out infinite !important;
            box-shadow: 
                0 4px 0 #6a4c96,
                0 8px 20px rgba(200, 82, 109, 0.3) !important;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .sync-button:hover {
            animation: none !important;
            transform: translateY(-3px) !important;
            box-shadow: 
                0 7px 0 #6a4c96,
                0 15px 25px rgba(200, 82, 109, 0.4) !important;
        }
        
        .population-display {
            background: #000000;
            border: 3px solid #7fb069;
            padding: 15px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 10px;
            white-space: pre-line;
            line-height: 1.4;
            color: #7fb069;
            box-shadow: 
                0 0 0 3px #c8526d,
                inset 0 0 20px rgba(127, 176, 105, 0.05);
        }
        
        /* 状态消息样式 */
        .sync-status, .parse-status {
            margin-top: 15px;
            padding: 12px;
            border: 3px solid;
            font-size: 14px;
            text-align: center;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sync-status.success, .parse-status.success {
            background: #000000;
            border-color: #7fb069;
            color: #7fb069;
            box-shadow: 0 0 20px rgba(127, 176, 105, 0.3);
        }
        
        .sync-status.error, .parse-status.error {
            background: #000000;
            border-color: #c8526d;
            color: #c8526d;
            box-shadow: 0 0 20px rgba(200, 82, 109, 0.3);
        }
        
        .sync-status.info, .parse-status.info {
            background: #000000;
            border-color: #5b8fd8;
            color: #5b8fd8;
            box-shadow: 0 0 20px rgba(91, 143, 216, 0.3);
        }
        
        /* 参数输入样式 */
        .parameter-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            margin-bottom: 15px;
            background: #000000;
            border: 3px solid #7d5fb8;
            color: #7fb069;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            resize: vertical;
            box-shadow: 
                0 0 0 3px #c8526d,
                inset 0 0 20px rgba(125, 95, 184, 0.05);
        }
        
        .parameter-input::placeholder {
            color: #666666;
        }
        
        .parameter-input:focus {
            outline: none;
            border-color: #7fb069;
            box-shadow: 
                0 0 0 3px #c8526d,
                0 0 30px rgba(127, 176, 105, 0.3),
                inset 0 0 20px rgba(127, 176, 105, 0.05);
        }
        
        .parameter-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .parameter-controls button:nth-child(1) {
            background: #5fbfa3;
            border-color: #7fb069;
            color: #000000;
        }
        
        .parameter-controls button:nth-child(2) {
            background: #c8526d;
            border-color: #d45675;
            color: #ffffff;
        }
        
        /* AI Prompt区域样式 */
        .ai-prompt-section {
            padding: 20px 0;
            margin-top: 15px;
        }
        
        .ai-prompt-label {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #c8526d;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 0px #000000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-prompt-input-wrapper {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: stretch;
        }
        
        .ai-prompt-input {
            flex: 1;
            padding: 15px 20px;
            background: #1a1a1a;
            border: 3px solid #7d5fb8;
            color: #7fb069;
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            font-weight: 600;
            border-radius: 0;
            box-shadow: 
                0 0 0 3px #5b8fd8,
                inset 0 0 20px rgba(125, 95, 184, 0.1);
            transition: all 0.3s ease;
        }
        
        .ai-prompt-input:focus {
            outline: none;
            border-color: #5fbfa3;
            box-shadow: 
                0 0 0 3px #c8526d,
                0 0 25px rgba(95, 191, 163, 0.35),
                inset 0 0 20px rgba(95, 191, 163, 0.05);
            transform: translateY(-2px);
        }
        
        .ai-prompt-input::placeholder {
            color: #666666;
            font-style: italic;
        }
        
        .ai-generate-btn {
            background: linear-gradient(45deg, #c8526d, #7d5fb8, #5b8fd8) !important;
            border: 3px solid #5fbfa3 !important;
            color: #ffffff !important;
            padding: 15px 25px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            font-family: 'JetBrains Mono', monospace !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: aiGeneratePulse 2s ease-in-out infinite;
            box-shadow: 
                0 4px 0 #5e4a7a,
                0 8px 20px rgba(200, 82, 109, 0.25) !important;
            min-width: 130px;
        }
        
        .ai-generate-btn:hover {
            animation: none !important;
            transform: translateY(-3px) scale(1.05) !important;
            box-shadow: 
                0 7px 0 #5e4a7a,
                0 15px 30px rgba(200, 82, 109, 0.4) !important;
        }
        
        .ai-generate-btn:active {
            transform: translateY(1px) scale(1.02) !important;
            box-shadow: 
                0 3px 0 #5e4a7a,
                0 6px 15px rgba(200, 82, 109, 0.3) !important;
        }
        
        @keyframes aiGeneratePulse {
            0%, 100% { 
                transform: scale(1);
                background: linear-gradient(45deg, #c8526d, #7d5fb8, #5b8fd8);
            }
            50% { 
                transform: scale(1.02);
                background: linear-gradient(45deg, #7d5fb8, #5b8fd8, #5fbfa3);
            }
        }
        

        
        .ai-prompt-status {
            margin-top: 15px;
            padding: 12px;
            border: 3px solid;
            font-size: 14px;
            text-align: center;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .ai-prompt-status.loading {
            background: #000000;
            border-color: #5b8fd8;
            color: #5b8fd8;
            box-shadow: 0 0 20px rgba(91, 143, 216, 0.3);
            animation: loadingPulse 1.5s ease-in-out infinite;
        }
        
        .ai-prompt-status.success {
            background: #000000;
            border-color: #5fbfa3;
            color: #5fbfa3;
            box-shadow: 0 0 20px rgba(95, 191, 163, 0.3);
        }
        
        .ai-prompt-status.error {
            background: #000000;
            border-color: #c8526d;
            color: #c8526d;
            box-shadow: 0 0 20px rgba(200, 82, 109, 0.3);
        }
        
        @keyframes loadingPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1.0; }
        }

        /* 参数调试器样式 */
        .parameter-debugger {
            background: #000000;
            border: 3px solid #5b8fd8;
            padding: 15px;
            margin-top: 10px;
            box-shadow: 
                0 0 0 3px #5fbfa3,
                inset 0 0 20px rgba(91, 143, 216, 0.05);
        }
        
        .debugger-subtitle {
            margin: 0 0 20px 0;
            font-size: 16px;
            color: #5b8fd8;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 1px 1px 0px #000000;
        }
        
        .population-selector {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .population-selector label {
            font-weight: 700;
            color: #5fbfa3;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 1px 1px 0px #000000;
        }
        
        .population-selector select {
            background: #000000;
            border: 3px solid #7d5fb8;
            color: #7fb069;
            padding: 8px 12px;
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            min-width: 200px;
            box-shadow: 
                0 0 0 3px #c8526d,
                0 0 15px rgba(125, 95, 184, 0.2);
        }
        
        .population-selector select option {
            background: #000000;
            color: #7fb069;
        }
        
        .population-selector select:focus {
            outline: none;
            border-color: #7fb069;
            box-shadow: 
                0 0 0 3px #c8526d,
                0 0 25px rgba(127, 176, 105, 0.3);
        }
        
        .population-info {
            font-size: 12px;
            color: #7d5fb8;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .parameter-sliders {
            display: grid;
            gap: 15px;
        }
        
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            background: rgba(125, 95, 184, 0.05);
            border: 2px solid #7d5fb8;
        }
        
        .slider-group label {
            font-size: 13px;
            font-weight: 700;
            color: #5fbfa3;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .slider-group input[type="range"] {
            width: 100%;
            height: 8px;
            background: #000000;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            border: 2px solid #c8526d;
            box-shadow: inset 0 0 10px rgba(200, 82, 109, 0.2);
        }
        
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #7fb069;
            cursor: pointer;
            border: 3px solid #ffffff;
            box-shadow: 
                0 0 0 2px #000000,
                0 0 15px rgba(127, 176, 105, 0.5);
        }
        
        .slider-group input[type="range"]::-webkit-slider-thumb:hover {
            background: #5fbfa3;
            transform: scale(1.2);
        }
        
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #7fb069;
            cursor: pointer;
            border: 3px solid #ffffff;
            box-shadow: 
                0 0 0 2px #000000,
                0 0 15px rgba(127, 176, 105, 0.5);
        }
        
        .slider-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #d2a841;
            font-weight: 700;
            min-width: 60px;
            text-align: right;
            text-shadow: 1px 1px 0px #000000;
        }
        
        .debugger-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #c8526d;
        }
        
        .debugger-controls button {
            background: #d2a841;
            border-color: #d4b246;
            color: #000000;
            padding: 12px 25px;
            font-size: 14px;
            font-weight: 700;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 550px 1fr;
                gap: 20px;
            }
            
            .controls-section {
                max-height: none;
            }
            
            canvas {
                max-width: 100%;
                height: auto;
            }
        }
        
        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .controls-section {
                max-height: none;
            }
            
            canvas {
                max-width: 100%;
                height: auto;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .header-content {
                gap: 20px;
            }
            
            .concept-header-btn {
                padding: 12px 20px !important;
                font-size: 14px !important;
            }
            
            .preset-buttons {
                grid-template-columns: 1fr;
            }
            
            canvas {
                max-width: 100%;
                height: auto;
            }
            
            /* 移动端标题样式调整 */
            .step-main-title {
                font-size: 18px !important;
                line-height: 1.2 !important;
            }
            
            .step-subtitle {
                font-size: 15px;
                line-height: 1.3;
            }
            
            /* AI Prompt区域移动端适配 */
            .ai-prompt-input-wrapper {
                flex-direction: column;
                gap: 10px;
            }
            
            .ai-prompt-input {
                font-size: 14px;
                padding: 12px 15px;
            }
            
            .ai-generate-btn {
                padding: 12px 20px !important;
                font-size: 14px !important;
                min-width: auto !important;
            }
        }
        
        @media (max-width: 480px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .concept-header-btn {
                padding: 10px 18px !important;
                font-size: 13px !important;
                letter-spacing: 1px !important;
            }
            
            /* 超小屏幕标题样式调整 */
            .step-main-title {
                font-size: 16px !important;
                padding-left: 8px !important;
                border-left-width: 3px !important;
            }
            
            .step-subtitle {
                font-size: 14px;
            }
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: #000000;
            border: 2px solid #8338ec;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #ff006e;
            border: 2px solid #000000;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #00ff00;
        }
        
        /* 文字选择样式 */
        ::selection {
            background: #ff006e;
            color: #ffffff;
        }
        
        /* 像素化效果 */
        .pixel-border {
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        /* 概念文字全屏显示样式 */
        .concept-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.95) 0%, 
                rgba(131, 56, 236, 0.15) 25%, 
                rgba(255, 0, 110, 0.1) 50%, 
                rgba(58, 134, 255, 0.15) 75%, 
                rgba(0, 0, 0, 0.95) 100%);
            backdrop-filter: blur(10px);
            z-index: 1000;
            overflow-y: auto;
            cursor: pointer;
            transition: opacity 0.5s ease;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px 0;
        }
        
        .concept-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .concept-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 40px;
            text-align: center;
            pointer-events: none;
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .concept-dual-text {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            margin-bottom: 40px;
        }
        
        .concept-text {
            font-family: 'JetBrains Mono', 'Georgia', serif;
            font-size: 16px;
            line-height: 1.8;
            color: #ffffff;
            text-shadow: 
                1px 1px 0px #000000,
                2px 2px 5px rgba(0, 255, 0, 0.3);
            flex: 1;
        }
        
        .concept-text-en {
            border-right: 3px solid #5fbfa3;
            padding-right: 30px;
            flex: 2;
        }
        
        .concept-text-zh {
            border-left: 3px solid #c8526d;
            padding-left: 30px;
            flex: 1;
        }
        
        .concept-text p {
            margin-bottom: 25px;
            text-align: justify;
            text-justify: inter-word;
        }
        
        .concept-lang-label {
            font-size: 14px;
            font-weight: 700;
            color: #7d5fb8;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 
                1px 1px 0px #000000,
                2px 2px 5px rgba(125, 95, 184, 0.3);
        }
        
        .concept-text strong {
            color: #5fbfa3;
            font-weight: 700;
            text-shadow: 
                1px 1px 0px #000000,
                2px 2px 8px rgba(95, 191, 163, 0.35);
        }
        
        .concept-footer {
            border-top: 3px solid #7d5fb8;
            padding-top: 25px;
            margin-top: 30px;
            position: relative;
        }
        
        .concept-footer::before {
            content: '';
            position: absolute;
            top: -3px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #c8526d, #7d5fb8, #5b8fd8, #5fbfa3);
            animation: gradientShift 2s ease infinite;
        }
        
        .concept-footer p {
            font-size: 14px;
            color: #c8526d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 
                1px 1px 0px #000000,
                2px 2px 5px rgba(200, 82, 109, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* 响应式设计 - 概念文字 */
        @media (max-width: 1024px) {
            .concept-dual-text {
                flex-direction: column;
                gap: 30px;
            }
            
            .concept-text-en {
                border-right: none;
                border-bottom: 3px solid #5fbfa3;
                padding-right: 0;
                padding-bottom: 20px;
            }
            
            .concept-text-zh {
                border-left: none;
                border-top: 3px solid #c8526d;
                padding-left: 0;
                padding-top: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .concept-overlay {
                padding: 10px 0;
            }
            
            .concept-content {
                padding: 40px 20px;
                max-width: 95%;
                min-height: auto;
                justify-content: flex-start;
            }
            
            .concept-text {
                font-size: 14px;
                line-height: 1.6;
            }
            
            .concept-footer p {
                font-size: 12px;
            }
            
            .concept-dual-text {
                gap: 25px;
            }
        }
        
        @media (max-width: 480px) {
            .concept-overlay {
                padding: 5px 0;
            }
            
            .concept-content {
                padding: 30px 15px;
                min-height: auto;
                justify-content: flex-start;
            }
            
            .concept-text {
                font-size: 13px;
                line-height: 1.5;
            }
            
            .concept-dual-text {
                gap: 20px;
            }
            
            .concept-lang-label {
                font-size: 12px;
                margin-bottom: 15px;
            }
        }
        
        
        .livestream-wrapper {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 宽高比 */
            margin-bottom: 15px;
            overflow: hidden;
            border: 3px solid #5fbfa3;
            box-shadow: 
                0 0 0 3px #5b8fd8,
                inset 0 0 20px rgba(95, 191, 163, 0.05);
        }
        
        .livestream-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            background: #000000;
        }
        
        .livestream-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: opacity 0.3s ease;
        }
        
        .livestream-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .overlay-content {
            text-align: center;
            color: #7fb069;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .overlay-content h4 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #c8526d;
            text-shadow: 2px 2px 0px #000000;
        }
        
        .overlay-content p {
            font-size: 14px;
            margin-bottom: 20px;
            color: #5fbfa3;
        }
        
        .play-livestream-btn {
            background: linear-gradient(45deg, #c8526d, #7d5fb8) !important;
            border: 3px solid #7fb069 !important;
            color: #ffffff !important;
            padding: 15px 25px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            border-radius: 0 !important;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .play-livestream-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 0 #6a4c96,
                0 12px 20px rgba(200, 82, 109, 0.35);
            animation: none;
        }
        

        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* 同步确认对话框样式 */
        .sync-confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }
        
        .sync-confirm-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .sync-confirm-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1b69 50%, #1a1a1a 100%);
            border: 4px solid #06ffa5;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 
                0 0 0 4px #ff006e,
                0 0 0 8px #8338ec,
                0 0 50px rgba(6, 255, 165, 0.5);
            position: relative;
        }
        
        .sync-confirm-header h3 {
            color: #06ffa5;
            font-size: 24px;
            margin: 0 0 15px 0;
            text-align: center;
            text-shadow: 2px 2px 0px #000000;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }
        
        .sync-confirm-header p {
            color: #ffffff;
            font-size: 16px;
            text-align: center;
            margin: 0 0 25px 0;
            line-height: 1.5;
            text-shadow: 1px 1px 0px #000000;
        }
        
        .creation-preview {
            background: #000000;
            border: 3px solid #8338ec;
            padding: 20px;
            margin: 20px 0;
            box-shadow: inset 0 0 20px rgba(131, 56, 236, 0.2);
        }
        
        .creation-preview p {
            color: #ff006e;
            font-weight: 700;
            margin: 0 0 15px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .creation-stats {
            color: #00ff00;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .naming-section {
            margin: 25px 0;
        }
        
        .naming-section label {
            display: block;
            color: #06ffa5;
            font-weight: 700;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .creation-name-input {
            width: 100%;
            padding: 15px;
            background: #000000;
            border: 3px solid #ff006e;
            color: #00ff00;
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            box-shadow: inset 0 0 20px rgba(255, 0, 110, 0.2);
        }
        
        .creation-name-input:focus {
            outline: none;
            border-color: #06ffa5;
            box-shadow: 
                inset 0 0 20px rgba(6, 255, 165, 0.2),
                0 0 25px rgba(6, 255, 165, 0.5);
        }
        
        .sync-confirm-footer {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .cancel-btn {
            background: #000000 !important;
            border: 3px solid #ff006e !important;
            color: #ff006e !important;
            padding: 15px 25px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            font-family: 'JetBrains Mono', monospace !important;
            text-transform: uppercase !important;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 0 #cc0055 !important;
        }
        
        .cancel-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 0 #cc0055, 0 10px 20px rgba(255, 0, 110, 0.4) !important;
        }
        
        .confirm-btn {
            background: linear-gradient(45deg, #06ffa5, #3a86ff) !important;
            border: 3px solid #00ff00 !important;
            color: #000000 !important;
            padding: 15px 25px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            font-family: 'JetBrains Mono', monospace !important;
            text-transform: uppercase !important;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: confirmPulse 2s ease-in-out infinite;
            box-shadow: 0 4px 0 #00cc82 !important;
        }
        
        .confirm-btn:hover {
            animation: none !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 0 #00cc82, 0 10px 20px rgba(6, 255, 165, 0.6) !important;
        }
        
        @keyframes confirmPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* 同步结果展示样式 */
        .sync-result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }
        
        .sync-result-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .sync-result-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f3460 50%, #1a1a1a 100%);
            border: 4px solid #3a86ff;
            padding: 40px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 
                0 0 0 4px #06ffa5,
                0 0 0 8px #ff006e,
                0 0 60px rgba(58, 134, 255, 0.6);
            position: relative;
        }
        
        .sync-result-header h3 {
            color: #3a86ff;
            font-size: 28px;
            margin: 0 0 20px 0;
            text-align: center;
            text-shadow: 2px 2px 0px #000000;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }
        
        .digital-monument {
            background: #000000;
            border: 3px solid #06ffa5;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 
                0 0 0 3px #3a86ff,
                inset 0 0 30px rgba(6, 255, 165, 0.2);
        }
        
        .monument-title {
            color: #06ffa5;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            margin: 0 0 20px 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 0px #000000;
        }
        
        .monument-content {
            color: #ffffff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.8;
            text-align: center;
        }
        
        .monument-content .creation-name {
            color: #ff006e;
            font-size: 18px;
            font-weight: 700;
            margin: 10px 0;
            text-shadow: 1px 1px 0px #000000;
        }
        
        .sync-result-footer {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .close-result-btn {
            background: #000000 !important;
            border: 3px solid #3a86ff !important;
            color: #3a86ff !important;
            padding: 15px 25px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            font-family: 'JetBrains Mono', monospace !important;
            text-transform: uppercase !important;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 0 #2e6bcc !important;
        }
        
        .close-result-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 0 #2e6bcc, 0 10px 20px rgba(58, 134, 255, 0.4) !important;
        }
        
        .create-another-btn {
            background: linear-gradient(45deg, #ff006e, #8338ec) !important;
            border: 3px solid #00ff00 !important;
            color: #ffffff !important;
            padding: 15px 25px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            font-family: 'JetBrains Mono', monospace !important;
            text-transform: uppercase !important;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 0 #662dbc !important;
        }
        
        .create-another-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 0 #662dbc, 0 10px 20px rgba(255, 0, 110, 0.6) !important;
        }
    </style>
</head>
<body>
    <!-- 概念文字全屏显示 -->
    <div id="conceptOverlay" class="concept-overlay">
        <div class="concept-content">
            <div class="concept-dual-text">
                <!-- 英文版本 -->
                <div class="concept-text concept-text-en">
                    <div class="concept-lang-label">English</div>
                    <p>In contemporary 'post-anthropocentrism' thought, many view humans as the primary destroyers of nature, prompting a deep reflection on the environmental impacts of human activities. However, this critique often becomes extreme, overlooking the unique role and responsibility humans may have in the natural order. Since the Industrial Revolution, issues such as climate change and biodiversity loss have intensified, forcing us to redefine our relationship with nature.</p>
                    
                    <p>Yet, <strong>humans are not merely creators of ecological crises—we also have the ability to repair and reshape the world. Human consciousness, as a singular point in natural evolution, possesses the power to predict, create, and reflect.</strong> As philosopher Hans Jonas suggested, technological progress amplifies the impact of human actions, thus increasing our ethical responsibility. We are capable not only of destroying nature but also of creating new orders.</p>
                    
                    <p>In this project, you will become a <strong>'rule setter', intervening in the evolution of a complex system to shape a dynamic natural order.</strong> You can design and adjust parameters, placing them within a grand evolutionary landscape, and collaborate with players from around the world to shape the future of ecological order. This is not just a technical computation—it represents how collective consciousness can intervene in the generation of natural order, reminding us that through the fusion of consciousness and technology, we have the power to restore nature and create a new future.</p>
                </div>
                
                <!-- 中文版本 -->
                <div class="concept-text concept-text-zh">
                    <div class="concept-lang-label">中文</div>
                    <p>在当代'去人类中心主义'思潮中，很多人认为人类是自然的破坏者，这促使我们深刻反思人类活动对环境的影响。然而，这种批判往往过于极端，忽视了人类在自然秩序中独特的角色和责任。自工业革命以来，气候变化、生物多样性丧失等问题不断加剧，迫使我们重新定义与自然的关系。</p>
                    
                    <p><strong>但人类并非仅是生态危机的制造者，我们同样具备修复和重塑的能力。人类意识作为自然演化中的奇点，具备预测、创造和反思的力量。</strong>正如哲学家汉斯·约纳斯所说，技术的进步扩大了人类行为的影响，也意味着我们肩负更大的伦理责任。我们不仅可以破坏自然，更能创造新秩序。</p>
                    
                    <p>在这个项目中，你将成为<strong>'规则设定者'，通过干预复杂系统的演化，塑造一个动态的自然秩序。</strong>你可以设计并调整参数，将其放入一个宏大的演化景观中，与来自世界各地的其他玩家共同塑造未来的生态秩序。这不仅仅是技术的运算，它代表了群体意识如何共同介入自然秩序的生成，让我们重新认识到：通过意识与技术的结合，我们有能力修复自然，创造一个全新的未来。</p>
                </div>
            </div>
            
            <div class="concept-footer">
                <p data-lang-key="click_to_continue">点击屏幕任意位置继续 / Click anywhere to continue</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="language-selector">
                <select id="languageSelect" onchange="switchLanguage(this.value)">
                    <option value="en">EN</option>
                    <option value="zh">中文</option>
                </select>
            </div>
            <div class="header-content">
                <h1 data-lang-key="main_title">Create Your Own Life Rules!</h1>
                <button onclick="showConcept()" class="concept-header-btn" data-lang-key="concept_btn">Concept</button>
            </div>
        </div>
        
        <div class="main-layout">
            <div class="canvas-section">
                <canvas id="swarmCanvas" width="600" height="600"></canvas>
                <div class="canvas-controls">
                    <button onclick="startSimulation()" data-lang-key="btn_start">Start</button>
                    <button onclick="pauseSimulation()" data-lang-key="btn_pause">Pause</button>
                    <button onclick="resetView()" data-lang-key="btn_reset">Reset</button>
                    <button class="sync-button" onclick="syncToUnity()" data-lang-key="btn_sync">Sync to the Living World</button>
                </div>
                <div id="syncStatus" class="sync-status" style="display: none;"></div>
            </div>
            
            <div class="controls-section">
                <div class="control-group">
                    <h3 class="step-main-title" data-lang-key="step1_caption">1. You are the observer, witnessing existing orders.</h3>
                    <p class="step-subtitle" data-lang-key="step1_title">Click the button to try the classic digital life example.</p>
                    <div class="preset-buttons">
                        <button onclick="loadPreset('uzushio')" data-lang-key="preset_uzushio">Uzushio</button>
                        <button onclick="loadPreset('insurmountable_wall')" data-lang-key="preset_wall">Insurmountable Wall</button>
                        <button onclick="loadPreset('cell_with_two_nuclei')" data-lang-key="preset_cell">Cell with Two Nuclei</button>
                        <button onclick="loadPreset('multicellularity')" data-lang-key="preset_multi">Multicellularity</button>
                        <button onclick="loadPreset('jelly_fish')" data-lang-key="preset_jelly">Jelly Fish</button>
                        <button onclick="loadPreset('playing_catch')" data-lang-key="preset_catch">Playing Catch</button>
                        <button onclick="loadPreset('pulsating_eye')" data-lang-key="preset_eye">Pulsating Eye</button>
                        <button onclick="loadPreset('fast_walker_slow_follower')" data-lang-key="preset_walker">Fast Walker & Slow Follower</button>
                        <button onclick="loadPreset('swinger')" data-lang-key="preset_swinger">Swinger</button>
                        <button onclick="loadPreset('rotary')" data-lang-key="preset_rotary">Rotary</button>
                        <button onclick="loadPreset('wedding_ring')" data-lang-key="preset_ring">Wedding Ring</button>
                        <button onclick="loadPreset('linear_oscillator')" data-lang-key="preset_oscillator">Linear Oscillator</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3 class="step-main-title" data-lang-key="step2_caption">2. You are the rule setter, intervening in the laws of natural evolution, giving behavioral meaning to "life".</h3>
                    <p class="step-subtitle" data-lang-key="step2_title">Use the visual controls below to intuitively adjust parameters and fine-tune each population, or manually modify parameter text for precise control.</p>
                    
                    <!-- AI Prompt可选功能 -->
                    <div class="ai-optional-section">
                        <p class="ai-optional-description" data-lang-key="ai_optional_description">(Optional) You can conceptualize the digital life you want to generate. Describe your vision in natural language, and AI will attempt to provide creative inspiration for your digital life creation.</p>
                        
                        <div class="ai-prompt-section">
                            <h4 class="ai-prompt-label" data-lang-key="ai_prompt_label">🌟 Describe Your Vision</h4>
                            <div class="ai-prompt-input-wrapper">
                                <input type="text" id="aiPromptInput" class="ai-prompt-input" 
                                       data-lang-key="ai_prompt_placeholder" 
                                       placeholder="e.g., a glowing jellyfish, an explosion of joy, flowing like water..." 
                                       autocomplete="off">
                                <button onclick="generateFromPrompt()" class="ai-generate-btn" data-lang-key="btn_generate">✨ Generate</button>
                            </div>

                            <div id="aiPromptStatus" class="ai-prompt-status" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <!-- 分隔线 -->
                    <div class="section-divider">
                        <div class="divider-line"></div>
                        <span class="divider-text" data-lang-key="divider_or">OR</span>
                        <div class="divider-line"></div>
                    </div>
                    
                    <div class="parameter-debugger">
                        <h4 class="debugger-subtitle" data-lang-key="debugger_subtitle">Fine-tune Parameters with Visual Controls</h4>
                        <div class="population-selector">
                            <label for="populationSelect" data-lang-key="select_population">Select Population:</label>
                            <select id="populationSelect" onchange="selectPopulation()">
                                <option value="" data-lang-key="please_select">Please select population...</option>
                            </select>
                            <span id="populationInfo" class="population-info"></span>
                        </div>
                        
                        <div id="parameterSliders" class="parameter-sliders" style="display: none;">
                            <div class="slider-group">
                                <label data-lang-key="particle_count">Particle Count:</label>
                                <input type="range" id="slider_particleCount" min="1" max="500" step="1" oninput="updateParameter('particleCount', this.value)">
                                <span id="value_particleCount" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label data-lang-key="neighborhood_radius">Neighborhood Radius:</label>
                                <input type="range" id="slider_neighborhoodRadius" min="10" max="400" step="0.1" oninput="updateParameter('neighborhoodRadius', this.value)">
                                <span id="value_neighborhoodRadius" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label data-lang-key="normal_speed">Normal Speed:</label>
                                <input type="range" id="slider_normalSpeed" min="0" max="25" step="0.01" oninput="updateParameter('normalSpeed', this.value)">
                                <span id="value_normalSpeed" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label data-lang-key="max_speed">Max Speed:</label>
                                <input type="range" id="slider_maxSpeed" min="0" max="50" step="0.01" oninput="updateParameter('maxSpeed', this.value)">
                                <span id="value_maxSpeed" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label data-lang-key="cohesion_c1">Cohesion C1:</label>
                                <input type="range" id="slider_c1" min="0" max="1" step="0.01" oninput="updateParameter('c1', this.value)">
                                <span id="value_c1" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label data-lang-key="alignment_c2">Alignment C2:</label>
                                <input type="range" id="slider_c2" min="0" max="1" step="0.01" oninput="updateParameter('c2', this.value)">
                                <span id="value_c2" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label data-lang-key="separation_c3">Separation C3:</label>
                                <input type="range" id="slider_c3" min="0" max="100" step="0.01" oninput="updateParameter('c3', this.value)">
                                <span id="value_c3" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label data-lang-key="randomness_c4">Randomness C4:</label>
                                <input type="range" id="slider_c4" min="0" max="1" step="0.01" oninput="updateParameter('c4', this.value)">
                                <span id="value_c4" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label data-lang-key="speed_control_c5">Speed Control C5:</label>
                                <input type="range" id="slider_c5" min="0" max="1" step="0.01" oninput="updateParameter('c5', this.value)">
                                <span id="value_c5" class="slider-value">0</span>
                            </div>
                            
                            <div class="debugger-controls">
                                <button onclick="resetSelectedPopulation()" data-lang-key="btn_reset_params">Reset Parameters</button>
                            </div>
                        </div>
                    </div>
                    
                    <textarea id="parameterInput" class="parameter-input" data-lang-key="param_placeholder" placeholder="Enter parameter format, example:
48 * (150.39, 15.89, 23.54, 0.74, 0.45, 62.65, 0.33, 0.13)
152 * (217.14, 12.13, 12.42, 0.59, 0.98, 14.06, 0.04, 0.65)
14 * (248.54, 5.85, 22.26, 0.43, 0.11, 17.14, 0.06, 0.68)
31 * (141.53, 2.91, 4.86, 0.92, 0.03, 21.87, 0.28, 0.2)"></textarea>
                    <div class="parameter-controls">
                        <button onclick="parseCustomParameters()" data-lang-key="btn_parse">Parse Parameters</button>
                        <button onclick="clearParameters()" data-lang-key="btn_clear">Clear Input</button>
                    </div>
                    <div id="parseStatus" class="parse-status" style="display: none;"></div>
                </div>
                

                
                <div class="control-group">
                    <h3 class="step-main-title" data-lang-key="step3_caption">3. You are the constructor, deploying your consciousness into a larger ecosystem.</h3>
                    <p class="step-subtitle" data-lang-key="step3_title">Ready? Click the "Sync to the Living World" button on the left to upload your created digital life into a larger world!</p>
                    <div class="bilibili-livestream-container">
                        <div class="livestream-wrapper" id="livestreamWrapper">
                            <iframe 
                                id="bilibiliFrame" 
                                src="https://player.livepush.io/live/em2skFpl0x-JHsX3" 
                                width="640" 
                                height="480" 
                                allowFullScreen="1" 
                                frameBorder="0">
                            </iframe>
                            <div class="livestream-overlay" id="livestreamOverlay">
                                <div class="overlay-content">
                                    <h4 data-lang-key="live_title">Live Stream</h4>
                                    <p data-lang-key="live_description">Click the button below to start watching the live stream</p>
                                    <button onclick="startLivestream()" class="play-livestream-btn" data-lang-key="btn_start_stream">▶️ Start</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 同步确认对话框 -->
    <div id="syncConfirmOverlay" class="sync-confirm-overlay hidden">
        <div class="sync-confirm-content">
            <div class="sync-confirm-header">
                <h3 data-lang-key="sync_confirm_title">✨ Ready to Deploy Your Consciousness?</h3>
                <p data-lang-key="sync_confirm_subtitle">You are about to send your digital life creation into the larger ecosystem. Your name will be inscribed in its evolutionary rules.</p>
            </div>
            
            <div class="sync-confirm-body">
                <div class="creation-preview" id="creationPreview">
                    <p data-lang-key="creation_summary">Your Creation Summary:</p>
                    <div class="creation-stats" id="creationStats"></div>
                </div>
                
                <div class="naming-section">
                    <label for="creationName" data-lang-key="creation_name_label">Give your creation a name (optional):</label>
                    <input type="text" id="creationName" class="creation-name-input" data-lang-key="creation_name_placeholder" placeholder="e.g., Jellywalker, Cosmic Dance, ..." maxlength="50">
                </div>
            </div>
            
            <div class="sync-confirm-footer">
                <button onclick="cancelSync()" class="cancel-btn" data-lang-key="btn_cancel">Cancel</button>
                <button onclick="confirmSync()" class="confirm-btn" data-lang-key="btn_confirm_sync">🚀 Deploy to Living World</button>
            </div>
        </div>
    </div>

    <!-- 同步成功展示区域 -->
    <div id="syncResultOverlay" class="sync-result-overlay hidden">
        <div class="sync-result-content">
            <div class="sync-result-header">
                <h3 data-lang-key="sync_success_title">✅ Consciousness Successfully Deployed</h3>
            </div>
            
            <div class="sync-result-body">
                <div class="digital-monument" id="digitalMonument">
                    <div class="monument-title" data-lang-key="monument_title">🏛️ Digital Monument</div>
                    <div class="monument-content" id="monumentContent"></div>
                </div>
            </div>
            
            <div class="sync-result-footer">
                <button onclick="closeSyncResult()" class="close-result-btn" data-lang-key="btn_close">Close</button>
                <button onclick="createAnother()" class="create-another-btn" data-lang-key="btn_create_another">Create Another</button>
            </div>
        </div>
    </div>

    <script>
        // SwarmChemistry Cloud Edition - Algorithm implementation consistent with original Java version
        
        // 语言系统
        let currentLanguage = 'en';
        
        const translations = {
            en: {
                main_title: "Create Your Own Life Rules!",
                concept_btn: "Concept",
                btn_start: "Start",
                btn_pause: "Pause", 
                btn_reset: "Reset",
                btn_sync: "Sync to the Living World",
                ai_optional_description: "(Optional) You can conceptualize the digital life you want to generate. Describe your vision in natural language, and AI will attempt to provide creative inspiration for your digital life creation.",
                ai_prompt_label: "🌟 Describe Your Vision",
                ai_prompt_placeholder: "e.g., a glowing jellyfish, an explosion of joy, flowing like water...",
                btn_generate: "✨ Generate",
                step1_title: "Click the button to try the classic digital life example.",
                step1_caption: "1. You are the observer, witnessing existing orders.",
                step2_title: "Use the visual controls below to intuitively adjust parameters and fine-tune each population, or manually modify parameter text for precise control.",
                step2_caption: "2. You are the rule setter, intervening in the laws of natural evolution, giving behavioral meaning to \"life\".",
                step3_title: "Ready? Click the \"Sync to the Living World\" button on the left to upload your created digital life into a larger world!",
                step3_caption: "3. You are the constructor, deploying your consciousness into a larger ecosystem.",
                preset_uzushio: "Uzushio",
                preset_wall: "Insurmountable Wall",
                preset_cell: "Cell with Two Nuclei",
                preset_multi: "Multicellularity",
                preset_jelly: "Jelly Fish",
                preset_catch: "Playing Catch",
                preset_eye: "Pulsating Eye",
                preset_walker: "Fast Walker & Slow Follower",
                preset_swinger: "Swinger",
                preset_rotary: "Rotary",
                preset_ring: "Wedding Ring",
                preset_oscillator: "Linear Oscillator",
                param_placeholder: "Enter parameter format, example:\n48 * (150.39, 15.89, 23.54, 0.74, 0.45, 62.65, 0.33, 0.13)\n152 * (217.14, 12.13, 12.42, 0.59, 0.98, 14.06, 0.04, 0.65)\n14 * (248.54, 5.85, 22.26, 0.43, 0.11, 17.14, 0.06, 0.68)\n31 * (141.53, 2.91, 4.86, 0.92, 0.03, 21.87, 0.28, 0.2)",
                btn_parse: "Parse Parameters",
                btn_clear: "Clear Input",
                select_population: "Select Population:",
                please_select: "Please select population...",
                particle_count: "Particle Count:",
                neighborhood_radius: "Neighborhood Radius:",
                normal_speed: "Normal Speed:",
                max_speed: "Max Speed:",
                cohesion_c1: "Cohesion C1:",
                alignment_c2: "Alignment C2:",
                separation_c3: "Separation C3:",
                randomness_c4: "Randomness C4:",
                speed_control_c5: "Speed Control C5:",
                btn_reset_params: "Reset Parameters",
                btn_start_stream: "▶️ Start",
                click_to_continue: "Click anywhere to continue",
                concept_p1: "In contemporary 'post-anthropocentrism' thought, many view humans as the primary destroyers of nature, prompting a deep reflection on the environmental impacts of human activities. However, this critique often becomes extreme, overlooking the unique role and responsibility humans may have in the natural order. Since the Industrial Revolution, issues such as climate change and biodiversity loss have intensified, forcing us to redefine our relationship with nature.",
                concept_p2: "Yet, humans are not merely creators of ecological crises—we also have the ability to repair and reshape the world. Human consciousness, as a singular point in natural evolution, possesses the power to predict, create, and reflect. As philosopher Hans Jonas suggested, technological progress amplifies the impact of human actions, thus increasing our ethical responsibility. We are capable not only of destroying nature but also of creating new orders.",
                concept_p3: "In this project, you will become a 'rule setter', intervening in the evolution of a complex system to shape a dynamic natural order. You can design and adjust parameters, placing them within a grand evolutionary landscape, and collaborate with players from around the world to shape the future of ecological order. This is not just a technical computation—it represents how collective consciousness can intervene in the generation of natural order, reminding us that through the fusion of consciousness and technology, we have the power to restore nature and create a new future.",
                sync_confirm_title: "✨ Ready to Deploy Your Consciousness?",
                sync_confirm_subtitle: "You are about to send your digital life creation into the larger ecosystem. Your name will be inscribed in its evolutionary rules.",
                creation_summary: "Your Creation Summary:",
                creation_name_label: "Give your creation a name (optional):",
                creation_name_placeholder: "e.g., Jellywalker, Cosmic Dance, ...",
                btn_cancel: "Cancel",
                btn_confirm_sync: "🚀 Deploy to Living World",
                sync_success_title: "✅ Consciousness Successfully Deployed",
                monument_title: "🏛️ Digital Monument",
                btn_close: "Close",
                btn_create_another: "Create Another",
                divider_or: "OR",
                debugger_subtitle: "Fine-tune Parameters with Visual Controls",
                live_title: "Live Stream",
                live_description: "Click the button below to start watching the live stream"
            },
            zh: {
                main_title: "创造你的生命规则！",
                concept_btn: "理念",
                btn_start: "开始",
                btn_pause: "暂停",
                btn_reset: "重置",
                btn_sync: "同步到生命世界",
                ai_optional_description: "（可选）你可以对想要生成的数字生命进行构想，用自然语言描述你的创意愿景，AI将尝试为你的数字生命创作提供灵感启发。",
                ai_prompt_label: "🌟 描述你的想象",
                ai_prompt_placeholder: "例如：一朵发光的水母、一阵欢乐的爆发、如水般流动...（支持中英文输入）",
                btn_generate: "✨ 生成",
                step1_title: "点击按钮尝试经典的数字生命样例。",
                step1_caption: "1. 你是观察者，见证既有的秩序。",
                step2_title: "使用下方可视化控件直观地调整参数并精细调节每个种群，或手动修改参数文本进行精确控制。",
                step2_caption: "2. 你是规则设定者，干预自然演化的法则，赋予\"生命\"行为意义。",
                step3_title: "准备好了吗？点击左侧\"同步到生命世界\"按钮，将你创造的数字生命上传到更大的世界中！",
                step3_caption: "3. 你是建构者，将你的意识投放到更大的生态系统中。",
                preset_uzushio: "漩涡",
                preset_wall: "不可逾越之壁",
                preset_cell: "双核细胞",
                preset_multi: "多细胞性",
                preset_jelly: "水母",
                preset_catch: "追逐游戏",
                preset_eye: "脉动之眼",
                preset_walker: "快行者慢跟随者",
                preset_swinger: "摆动者",
                preset_rotary: "旋转体",
                preset_ring: "婚戒",
                preset_oscillator: "线性振荡器",
                param_placeholder: "输入参数格式，例如：\n48 * (150.39, 15.89, 23.54, 0.74, 0.45, 62.65, 0.33, 0.13)\n152 * (217.14, 12.13, 12.42, 0.59, 0.98, 14.06, 0.04, 0.65)\n14 * (248.54, 5.85, 22.26, 0.43, 0.11, 17.14, 0.06, 0.68)\n31 * (141.53, 2.91, 4.86, 0.92, 0.03, 21.87, 0.28, 0.2)",
                btn_parse: "解析参数",
                btn_clear: "清空输入",
                select_population: "选择种群：",
                please_select: "请选择种群...",
                particle_count: "粒子数量：",
                neighborhood_radius: "邻域半径：",
                normal_speed: "正常速度：",
                max_speed: "最大速度：",
                cohesion_c1: "聚集力 C1：",
                alignment_c2: "对齐力 C2：",
                separation_c3: "分离力 C3：",
                randomness_c4: "随机性 C4：",
                speed_control_c5: "速度控制 C5：",
                btn_reset_params: "重置参数",
                btn_start_stream: "▶️ 开始",
                click_to_continue: "点击屏幕任意位置继续",
                concept_p1: "在当代'去人类中心主义'思潮中，很多人认为人类是自然的破坏者，这促使我们深刻反思人类活动对环境的影响。然而，这种批判往往过于极端，忽视了人类在自然秩序中独特的角色和责任。自工业革命以来，气候变化、生物多样性丧失等问题不断加剧，迫使我们重新定义与自然的关系。",
                concept_p2: "但人类并非仅是生态危机的制造者，我们同样具备修复和重塑的能力。人类意识作为自然演化中的奇点，具备预测、创造和反思的力量。正如哲学家汉斯·约纳斯所说，技术的进步扩大了人类行为的影响，也意味着我们肩负更大的伦理责任。我们不仅可以破坏自然，更能创造新秩序。",
                concept_p3: "在这个项目中，你将成为'规则设定者'，通过干预复杂系统的演化，塑造一个动态的自然秩序。你可以设计并调整参数，将其放入一个宏大的演化景观中，与来自世界各地的其他玩家共同塑造未来的生态秩序。这不仅仅是技术的运算，它代表了群体意识如何共同介入自然秩序的生成，让我们重新认识到：通过意识与技术的结合，我们有能力修复自然，创造一个全新的未来。",
                sync_confirm_title: "✨ 准备好部署你的意识了吗？",
                sync_confirm_subtitle: "你即将将你的数字生命创造发送到更大的生态系统中。你的名字将被铭刻在它的演化规则中。",
                creation_summary: "你的创造总结：",
                creation_name_label: "给你的创造起个名字（可选）：",
                creation_name_placeholder: "例如：水母行者、宇宙舞蹈、...",
                btn_cancel: "取消",
                btn_confirm_sync: "🚀 部署到生命世界",
                sync_success_title: "✅ 意识成功部署",
                monument_title: "🏛️ 数字纪念碑",
                btn_close: "关闭",
                btn_create_another: "再创造一个",
                divider_or: "或者",
                debugger_subtitle: "使用可视化控件精细调节参数",
                live_title: "在线直播",
                live_description: "点击下方按钮开始观看直播"
            }
        };
        
        // Global variables
        let canvas, ctx;
        let individuals = [];
        let animationId;
        let isRunning = false;
        let mouseX = -1, mouseY = -1;
        let mouseInfluence = false;
        
        // 同步配置 - 使用当前域名
        const SYNC_CONFIG = {
            serverUrl: window.location.origin + '/api',
            enabled: true
        };
        
        // AI语义匹配系统
        class AISemanticMatcher {
            constructor() {
                this.model = null;
                this.promptDatabase = [];
                this.isLoading = false;
                this.fallbackEmbeddings = true; // 使用简化的embedding作为fallback
                this.translationDict = this.initializeTranslationDict();
            }
            
            // 初始化中英文翻译字典
            initializeTranslationDict() {
                return {
                    // 基础形容词
                    '红色': 'red', '红': 'red', '红的': 'red', '鲜红': 'red', '深红': 'red',
                    '发光': 'glowing', '发光的': 'glowing', '闪闪发光': 'glowing', '闪亮': 'glowing', 
                    '光亮': 'glowing', '发亮': 'glowing', '亮闪闪': 'glowing',
                    '分叉': 'branching', '分叉的': 'branching', '分支': 'branching', '分支的': 'branching',
                    '分岔': 'branching', '树状': 'branching',
                    '美丽': 'beautiful', '美丽的': 'beautiful', '漂亮': 'beautiful', '漂亮的': 'beautiful',
                    '好看': 'beautiful', '优美': 'beautiful',
                    '明亮': 'bright', '明亮的': 'bright', '亮': 'bright', '亮的': 'bright',
                    '鲜艳': 'bright', '耀眼': 'bright', '璀璨': 'bright',
                    '流动': 'flowing', '流动的': 'flowing', '流淌': 'flowing', '流淌的': 'flowing',
                    '流畅': 'flowing', '流体': 'flowing',
                    '跳舞': 'dancing', '舞蹈': 'dancing', '跳舞的': 'dancing', '舞动': 'dancing',
                    '摇摆': 'dancing', '律动': 'dancing',
                    '爆炸': 'explosion', '爆发': 'explosion', '爆炸的': 'explosion', '爆发的': 'explosion',
                    '炸裂': 'explosion', '迸发': 'explosion', '突发': 'explosion',
                    '欢乐': 'joy', '快乐': 'joy', '喜悦': 'joy', '开心': 'joy',
                    '愉快': 'joy', '高兴': 'joy', '兴奋': 'joy',
                    '动态': 'dynamic', '动态的': 'dynamic', '活跃': 'dynamic', '活跃的': 'dynamic',
                    '生动': 'dynamic', '活力': 'dynamic', '有活力': 'dynamic',
                    '有机': 'organic', '有机的': 'organic', '自然': 'organic', '自然的': 'organic',
                    '天然': 'organic', '原生': 'organic',
                    '神经': 'neural', '神经的': 'neural', '神经元': 'neuron', '神经网络': 'neural',
                    
                    // 基础名词
                    '花': 'flower', '花朵': 'flower', '鲜花': 'flower',
                    '水母': 'jellyfish', '海蜇': 'jellyfish',
                    '神经元': 'neuron', '神经细胞': 'neuron', '脑细胞': 'neuron',
                    '粒子': 'particles', '颗粒': 'particles', '微粒': 'particles',
                    '水': 'water', '液体': 'liquid', '流体': 'fluid',
                    '光': 'light', '光线': 'light', '光芒': 'light',
                    '能量': 'energy', '力量': 'energy', '动力': 'energy',
                    '生命': 'life', '生物': 'life', '生灵': 'life',
                    '大脑': 'brain', '头脑': 'brain', '脑': 'brain',
                    '网络': 'network', '网': 'network',
                    '细胞': 'cell', '细胞群': 'cells',
                    '星星': 'stars', '恒星': 'stars', '星体': 'stars',
                    '烟花': 'fireworks', '焰火': 'fireworks',
                    '云': 'cloud', '云朵': 'cloud', '云彩': 'cloud',
                    '波浪': 'waves', '波': 'waves', '浪': 'waves',
                    '螺旋': 'spiral', '漩涡': 'spiral', '旋涡': 'spiral',
                    '群体': 'swarm', '集群': 'swarm', '群': 'swarm',
                    
                    // 动词
                    '流动': 'flowing', '流': 'flowing', '流淌': 'flowing',
                    '跳舞': 'dancing', '舞蹈': 'dancing', '摆动': 'swinging',
                    '旋转': 'rotating', '转动': 'rotating', '转': 'rotating',
                    '闪烁': 'flickering', '闪': 'flickering', '闪闪': 'flickering',
                    '移动': 'moving', '运动': 'moving', '游动': 'swimming',
                    '飞行': 'flying', '飞': 'flying', '飞舞': 'flying',
                    '聚集': 'gathering', '聚合': 'gathering', '聚拢': 'gathering',
                    '分散': 'scattering', '散开': 'scattering', '扩散': 'spreading',
                    '振荡': 'oscillating', '摆动': 'oscillating', '震动': 'vibrating',
                    '脉动': 'pulsating', '跳动': 'pulsating', '律动': 'pulsating',
                    
                    // 常见搭配词组
                    '像': 'like', '如同': 'like', '好像': 'like', '类似': 'like',
                    '一个': 'a', '一朵': 'a', '一只': 'a', '一群': 'a',
                    '的': '', '地': '', '得': '', // 中文助词，翻译时可以忽略
                    
                    // 特殊表达
                    '如水般': 'like water', '像水一样': 'like water',
                    '如花般': 'like flower', '像花一样': 'like flower',
                    '星空般': 'like stars', '像星空一样': 'like stars',
                    '梦幻般': 'dreamy', '梦幻的': 'dreamy',
                    '魔法般': 'magical', '魔法的': 'magical',
                    '童话般': 'fairytale', '童话的': 'fairytale'
                };
            }
            
            // 翻译中文prompt为英文
            translateChineseToEnglish(chineseText) {
                if (!chineseText || typeof chineseText !== 'string') {
                    return chineseText;
                }
                
                // 检测是否包含中文字符
                const hasChinese = /[\u4e00-\u9fff]/.test(chineseText);
                if (!hasChinese) {
                    return chineseText; // 如果没有中文，直接返回
                }
                
                let translatedText = chineseText.toLowerCase();
                
                // 首先处理较长的词组，避免被部分匹配覆盖
                const sortedKeys = Object.keys(this.translationDict).sort((a, b) => b.length - a.length);
                
                for (const chineseWord of sortedKeys) {
                    const englishWord = this.translationDict[chineseWord];
                    if (englishWord && translatedText.includes(chineseWord)) {
                        // 使用全局替换
                        const regex = new RegExp(chineseWord, 'g');
                        translatedText = translatedText.replace(regex, englishWord);
                    }
                }
                
                // 清理多余的空格
                translatedText = translatedText.replace(/\s+/g, ' ').trim();
                
                // 如果翻译后还有中文字符，说明有些词没有翻译
                const stillHasChinese = /[\u4e00-\u9fff]/.test(translatedText);
                if (stillHasChinese) {
                    console.log(`⚠️ 部分中文未能翻译: "${chineseText}" -> "${translatedText}"`);
                    
                    // 尝试语义推断（简单的关键词匹配）
                    if (translatedText.includes('花') || translatedText.includes('朵')) {
                        translatedText += ' flower';
                    }
                    if (translatedText.includes('水') || translatedText.includes('液')) {
                        translatedText += ' water';
                    }
                    if (translatedText.includes('光') || translatedText.includes('亮')) {
                        translatedText += ' light';
                    }
                }
                
                console.log(`🔤 翻译: "${chineseText}" -> "${translatedText}"`);
                return translatedText;
            }
            
            // 初始化：加载prompt数据库
            async initialize() {
                console.log('🤖 Initializing AI Semantic Matcher...');
                
                try {
                    // 加载prompt数据库
                    const response = await fetch('public/embeddings_compact.json');
                    if (response.ok) {
                        this.promptDatabase = await response.json();
                        console.log(`📚 Loaded ${this.promptDatabase.length} prompts from database`);
                    } else {
                        console.warn('⚠️ Failed to load embeddings, using fallback');
                        this.loadFallbackData();
                    }
                    
                    // 尝试加载ONNX模型（可选）
                    await this.loadONNXModel();
                    
                } catch (error) {
                    console.warn('⚠️ AI initialization failed, using fallback:', error);
                    this.loadFallbackData();
                }
                
                console.log('✅ AI Semantic Matcher ready');
            }
            
            // 加载fallback数据
            loadFallbackData() {
                this.promptDatabase = [
                    {
                        "prompt": "a red flower",
                        "embedding": null, // 将使用简化计算
                        "params": [
                            "70 * (100.14, 11.41, 20.83, 0.97, 0.15, 10.42, 0.24, 0.94)",
                            "163 * (279.75, 16.41, 32.35, 0.96, 0.22, 90.17, 0.16, 0.51)",
                            "161 * (240.26, 18.84, 24.18, 0.51, 0.67, 91.49, 0.21, 0.20)"
                        ]
                    },
                    {
                        "prompt": "a glowing jellyfish",
                        "embedding": null,
                        "params": [
                            "69 * (206.41, 14.66, 30.80, 0.71, 0.11, 62.76, 0.46, 0.73)",
                            "195 * (153.73, 11.85, 26.23, 0.82, 0.75, 82.60, 0.30, 0.67)",
                            "69 * (222.62, 14.14, 28.03, 0.37, 0.55, 65.61, 0.24, 0.79)",
                            "180 * (236.14, 18.23, 35.16, 0.42, 0.53, 63.33, 0.42, 0.97)"
                        ]
                    },
                    {
                        "prompt": "a branching neuron",
                        "embedding": null,
                        "params": [
                            "61 * (300.00, 10.00, 29.57, 0.52, 0.69, 90.58, 0.47, 0.56)",
                            "184 * (217.62, 12.22, 24.21, 0.66, 0.83, 95.68, 0.20, 0.60)",
                            "76 * (181.22, 17.13, 38.32, 0.69, 0.29, 90.32, 0.18, 0.19)"
                        ]
                    }
                ];
            }
            
            // 尝试加载ONNX模型
            async loadONNXModel() {
                try {
                    if (typeof onnx === 'undefined') {
                        console.log('📱 ONNX.js not available, using text-based matching');
                        return;
                    }
                    
                    // 这里可以加载MiniLM的ONNX模型
                    // 由于模型文件较大，目前使用简化的文本匹配
                    console.log('🧠 ONNX model loading skipped for now (using text-based matching)');
                    
                } catch (error) {
                    console.warn('⚠️ ONNX model loading failed:', error);
                }
            }
            
            // 改进的文本特征提取算法
            extractSimpleFeatures(text) {
                const features = [];
                const normalizedText = text.toLowerCase().trim();
                
                // 关键词匹配权重 - 直接匹配完整词汇
                const keywordFeatures = {};
                const allWords = normalizedText.split(/\s+/);
                
                // 为每个数据库中的prompt创建特征词典
                const promptKeywords = {
                    'red': 5.0, 'flower': 10.0, 'red flower': 15.0,
                    'glowing': 5.0, 'jellyfish': 10.0, 'glowing jellyfish': 15.0,
                    'branching': 5.0, 'neuron': 10.0, 'branching neuron': 15.0,
                    'dancing': 3.0, 'particles': 3.0, 'dance': 3.0, 'flow': 3.0,
                    'bright': 2.0, 'light': 2.0, 'glow': 2.0, 'shine': 2.0,
                    'water': 3.0, 'fluid': 3.0, 'liquid': 3.0, 'flowing': 3.0,
                    'neural': 4.0, 'brain': 4.0, 'nerve': 4.0, 'synapse': 4.0,
                    'nature': 2.0, 'organic': 2.0, 'living': 2.0, 'life': 2.0,
                    'explosion': 3.0, 'burst': 3.0, 'energy': 3.0, 'dynamic': 3.0
                };
                
                // 计算关键词匹配分数
                let totalKeywordScore = 0;
                for (const [keyword, weight] of Object.entries(promptKeywords)) {
                    if (normalizedText.includes(keyword)) {
                        totalKeywordScore += weight;
                        // 完整短语匹配给更高分数
                        if (keyword.includes(' ') && normalizedText.includes(keyword)) {
                            totalKeywordScore += weight * 0.5; // 额外奖励
                        }
                    }
                }
                features.push(totalKeywordScore);
                
                // 词汇重叠特征 - 计算与已知prompt的词汇重叠度
                const knownPhrases = ['a red flower', 'a glowing jellyfish', 'a branching neuron'];
                knownPhrases.forEach(phrase => {
                    const phraseWords = phrase.toLowerCase().split(/\s+/);
                    const overlapCount = phraseWords.filter(word => allWords.includes(word)).length;
                    const overlapRatio = overlapCount / phraseWords.length;
                    features.push(overlapRatio * 10); // 放大重叠分数
                });
                
                // 文本长度特征
                features.push(normalizedText.length / 20); // 归一化长度
                features.push(allWords.length / 5); // 归一化词数
                
                // 字符n-gram特征（2-gram和3-gram）
                const ngramScores = {};
                const targetNgrams = [
                    // 从已知prompt提取的重要n-gram
                    'fl', 'lo', 'ow', 'er', 're', 'ed', // flower, red相关
                    'gl', 'je', 'el', 'ly', 'fi', 'sh', // jellyfish, glowing相关
                    'br', 'an', 'ch', 'ne', 'ur', 'on', // branching, neuron相关
                    'red', 'low', 'ing', 'ell', 'ish', 'ran', 'eur', 'ron' // 3-gram
                ];
                
                targetNgrams.forEach(ngram => {
                    const count = (normalizedText.match(new RegExp(ngram, 'g')) || []).length;
                    features.push(count);
                });
                
                // 填充到固定维度
                while (features.length < 30) {
                    features.push(0);
                }
                
                return features.slice(0, 30); // 减少维度，专注关键特征
            }
            
            // 余弦相似度计算
            cosineSimilarity(vec1, vec2) {
                if (vec1.length !== vec2.length) {
                    return 0;
                }
                
                let dotProduct = 0;
                let norm1 = 0;
                let norm2 = 0;
                
                for (let i = 0; i < vec1.length; i++) {
                    dotProduct += vec1[i] * vec2[i];
                    norm1 += vec1[i] * vec1[i];
                    norm2 += vec2[i] * vec2[i];
                }
                
                if (norm1 === 0 || norm2 === 0) {
                    return 0;
                }
                
                return dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2));
            }
            
            // 简单字符串相似度计算（Levenshtein距离）
            levenshteinSimilarity(str1, str2) {
                const matrix = [];
                const len1 = str1.length;
                const len2 = str2.length;
                
                for (let i = 0; i <= len2; i++) {
                    matrix[i] = [i];
                }
                for (let j = 0; j <= len1; j++) {
                    matrix[0][j] = j;
                }
                
                for (let i = 1; i <= len2; i++) {
                    for (let j = 1; j <= len1; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }
                
                const maxLen = Math.max(len1, len2);
                return maxLen === 0 ? 1 : (maxLen - matrix[len2][len1]) / maxLen;
            }
            
            // 综合相似度计算
            calculateSimilarity(inputPrompt, dbPrompt) {
                const input = inputPrompt.toLowerCase().trim();
                const db = dbPrompt.toLowerCase().trim();
                
                // 1. 直接字符串匹配
                if (input === db) return 1.0;
                
                // 2. 包含关系匹配
                if (db.includes(input) || input.includes(db)) {
                    const includeScore = Math.min(input.length, db.length) / Math.max(input.length, db.length);
                    return 0.7 + includeScore * 0.3; // 0.7-1.0区间
                }
                
                // 3. 关键词匹配（改进版）
                const inputWords = input.split(/\s+/);
                const dbWords = db.split(/\s+/);
                
                let keywordMatches = 0;
                let totalKeywords = 0;
                let exactMatches = 0;
                
                inputWords.forEach(word => {
                    if (word.length > 1) { // 降低词长要求
                        totalKeywords++;
                        // 检查完全匹配
                        if (dbWords.includes(word)) {
                            keywordMatches++;
                            exactMatches++;
                        } else {
                            // 检查部分匹配
                            if (dbWords.some(dbWord => dbWord.includes(word) || word.includes(dbWord))) {
                                keywordMatches += 0.7; // 部分匹配给较低分数
                            }
                        }
                    }
                });
                
                if (totalKeywords > 0) {
                    const keywordScore = keywordMatches / totalKeywords;
                    const exactScore = exactMatches / totalKeywords;
                    
                    // 如果有完全匹配的关键词，给更高分数
                    if (exactScore > 0) {
                        return 0.5 + (keywordScore * 0.4) + (exactScore * 0.1);
                    } else if (keywordScore > 0.3) { // 降低阈值
                        return 0.3 + keywordScore * 0.4; // 0.3-0.7区间
                    }
                }
                
                // 4. 语义相关性检测（新增）
                const semanticScore = this.calculateSemanticSimilarity(input, db);
                if (semanticScore > 0.1) {
                    return semanticScore;
                }
                
                // 5. 编辑距离相似度
                const editSimilarity = this.levenshteinSimilarity(input, db);
                return editSimilarity * 0.3; // 0-0.3区间
            }
            
            // 新增：语义相关性计算
            calculateSemanticSimilarity(input, db) {
                // 定义语义相关词组
                const semanticGroups = [
                    ['flower', 'bloom', 'petal', 'rose', 'garden', 'plant', 'blossom'],
                    ['jellyfish', 'ocean', 'sea', 'marine', 'tentacle', 'float', 'swim'],
                    ['neuron', 'brain', 'neural', 'synapse', 'nerve', 'mind', 'cognitive'],
                    ['light', 'glow', 'bright', 'shine', 'radiant', 'luminous', 'illuminate'],
                    ['water', 'flow', 'liquid', 'stream', 'fluid', 'wave', 'current'],
                    ['dance', 'move', 'motion', 'rhythm', 'swing', 'sway', 'dynamic'],
                    ['particle', 'dot', 'point', 'element', 'unit', 'piece'],
                    ['energy', 'power', 'force', 'vibrant', 'active', 'dynamic'],
                    ['explosion', 'burst', 'blast', 'eruption', 'sudden', 'rapid'],
                    ['joy', 'happy', 'cheerful', 'bright', 'positive', 'celebration']
                ];
                
                const inputWords = input.split(/\s+/);
                const dbWords = db.split(/\s+/);
                
                let semanticMatches = 0;
                let totalGroups = 0;
                
                semanticGroups.forEach(group => {
                    const inputInGroup = inputWords.some(word => group.includes(word));
                    const dbInGroup = dbWords.some(word => group.includes(word));
                    
                    if (inputInGroup || dbInGroup) {
                        totalGroups++;
                        if (inputInGroup && dbInGroup) {
                            semanticMatches++;
                        }
                    }
                });
                
                return totalGroups > 0 ? (semanticMatches / totalGroups) * 0.4 : 0; // 最高0.4分
            }
            
            // 查找最相似的prompt
            async findBestMatch(inputPrompt) {
                if (this.promptDatabase.length === 0) {
                    throw new Error('Prompt database not loaded');
                }
                
                // 先翻译输入的prompt（如果是中文）
                const originalPrompt = inputPrompt;
                const translatedPrompt = this.translateChineseToEnglish(inputPrompt);
                
                // 如果翻译了，显示翻译结果
                if (translatedPrompt !== originalPrompt) {
                    console.log(`🔤 Input translated: "${originalPrompt}" -> "${translatedPrompt}"`);
                }
                
                let bestMatch = null;
                let bestScore = -1;
                const debugResults = [];
                
                for (const dbPrompt of this.promptDatabase) {
                    // 使用翻译后的prompt进行相似度计算
                    const similarity = this.calculateSimilarity(translatedPrompt, dbPrompt.prompt);
                    
                    debugResults.push({
                        prompt: dbPrompt.prompt,
                        similarity: similarity
                    });
                    
                    if (similarity > bestScore) {
                        bestScore = similarity;
                        bestMatch = {
                            prompt: dbPrompt.prompt,
                            params: dbPrompt.params,
                            similarity: similarity,
                            originalInput: originalPrompt,
                            translatedInput: translatedPrompt
                        };
                    }
                }
                
                // 调试输出
                console.log('🔍 Similarity Debug Results for:');
                console.log(`   Original: "${originalPrompt}"`);
                if (translatedPrompt !== originalPrompt) {
                    console.log(`   Translated: "${translatedPrompt}"`);
                }
                debugResults.sort((a, b) => b.similarity - a.similarity);
                debugResults.forEach((result, index) => {
                    console.log(`${index + 1}. "${result.prompt}": ${(result.similarity * 100).toFixed(1)}%`);
                });
                
                return bestMatch;
            }
        }
        
        // 全局AI匹配器实例
        let aiMatcher = null;
        
        // SwarmParameters类 - 与原始版本完全一致
        class SwarmParameters {
            constructor(neighborhoodRadius = 50, normalSpeed = 2, maxSpeed = 5, 
                        c1 = 0.5, c2 = 0.5, c3 = 10, c4 = 0.1, c5 = 0.5) {
                this.neighborhoodRadius = neighborhoodRadius;
                this.normalSpeed = normalSpeed;
                this.maxSpeed = maxSpeed;
                this.c1 = c1; // 聚集力
                this.c2 = c2; // 对齐力
                this.c3 = c3; // 分离力
                this.c4 = c4; // 随机性
                this.c5 = c5; // 速度调节
            }
            
            // 根据Java版本的颜色计算规则
            getColor() {
                // 增强颜色对比度和可见度
                const r = Math.floor((this.c1 / 1.0) * 255);  // 移除0.8系数，增强亮度
                const g = Math.floor((this.c2 / 1.0) * 255);  // 移除0.8系数，增强亮度
                const b = Math.floor((this.c3 / 100.0) * 255); // 移除0.8系数，增强亮度
                
                // 确保最小亮度，避免全黑色
                const minBrightness = 50;
                const finalR = Math.max(r, minBrightness);
                const finalG = Math.max(g, minBrightness);
                const finalB = Math.max(b, minBrightness);
                
                return `rgb(${finalR}, ${finalG}, ${finalB})`;
            }
            
            clone() {
                return new SwarmParameters(
                    this.neighborhoodRadius, this.normalSpeed, this.maxSpeed,
                    this.c1, this.c2, this.c3, this.c4, this.c5
                );
            }
            
            toString() {
                return `(${this.neighborhoodRadius.toFixed(2)}, ${this.normalSpeed.toFixed(2)}, ${this.maxSpeed.toFixed(2)}, ${this.c1.toFixed(2)}, ${this.c2.toFixed(2)}, ${this.c3.toFixed(2)}, ${this.c4.toFixed(2)}, ${this.c5.toFixed(2)})`;
            }
        }
        
        // SwarmIndividual类 - 与原始版本完全一致
        class SwarmIndividual {
            constructor(x, y, dx = 0, dy = 0, parameters) {
                this.x = x;
                this.y = y;
                this.dx = dx;
                this.dy = dy;
                this.dx2 = dx; // 用于速度调节的临时变量
                this.dy2 = dy;
                this.parameters = parameters;
            }
            
            // 加速度计算
            accelerate(ax, ay, maxSpeed) {
                this.dx2 += ax;
                this.dy2 += ay;
                
                // 限制最大速度
                const speed = Math.sqrt(this.dx2 * this.dx2 + this.dy2 * this.dy2);
                if (speed > maxSpeed) {
                    this.dx2 = (this.dx2 / speed) * maxSpeed;
                    this.dy2 = (this.dy2 / speed) * maxSpeed;
                }
            }
            
            // 移动
            move() {
                this.dx = this.dx2;
                this.dy = this.dy2;
                
                this.x += this.dx;
                this.y += this.dy;
            }
            
            // 边界处理
            wrapAround(width, height) {
                if (this.x < 0) this.x = width;
                if (this.x > width) this.x = 0;
                if (this.y < 0) this.y = height;
                if (this.y > height) this.y = 0;
            }
        }
        
        // 概念文字显示控制
        let isConceptVisible = true; // 页面加载时默认显示
        
        // 显示概念文字
        function showConcept() {
            const overlay = document.getElementById('conceptOverlay');
            overlay.classList.remove('hidden');
            isConceptVisible = true;
            console.log('📖 Concept overlay shown');
        }
        
        // 隐藏概念文字
        function hideConcept() {
            const overlay = document.getElementById('conceptOverlay');
            overlay.classList.add('hidden');
            isConceptVisible = false;
            console.log('📖 Concept overlay hidden');
        }
        
        // 语言切换功能
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('swarm_language', lang);
            updatePageTexts();
            console.log(`🌐 Language switched to: ${lang}`);
        }
        
        // 更新页面文本
        function updatePageTexts() {
            const elements = document.querySelectorAll('[data-lang-key]');
            elements.forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    if (element.tagName === 'TEXTAREA') {
                        element.placeholder = translations[currentLanguage][key];
                    } else {
                        element.textContent = translations[currentLanguage][key];
                    }
                }
            });
            
            // 更新种群选择器的选项
            updatePopulationSelectorText();
        }
        
        // 初始化语言设置
        function initializeLanguage() {
            // 从本地存储获取语言设置，默认为英文
            const savedLanguage = localStorage.getItem('swarm_language') || 'en';
            currentLanguage = savedLanguage;
            
            // 设置语言选择器的值
            const languageSelect = document.getElementById('languageSelect');
            if (languageSelect) {
                languageSelect.value = currentLanguage;
            }
            
            // 更新页面文本
            updatePageTexts();
        }
        
        // 更新种群选择器文本
        function updatePopulationSelectorText() {
            const selector = document.getElementById('populationSelect');
            if (!selector) return;
            
            // 更新默认选项
            const defaultOption = selector.querySelector('option[value=""]');
            if (defaultOption && translations[currentLanguage]['please_select']) {
                defaultOption.textContent = translations[currentLanguage]['please_select'];
            }
        }
        
        // AI Prompt相关的交互函数
        
        // 显示AI状态
        function showAIStatus(message, type) {
            const statusDiv = document.getElementById('aiPromptStatus');
            statusDiv.textContent = message;
            statusDiv.className = `ai-prompt-status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // 主要的生成函数
        async function generateFromPrompt() {
            const input = document.getElementById('aiPromptInput');
            const promptText = input.value.trim();
            
            if (!promptText) {
                showAIStatus('Please enter a prompt! / 请输入描述！', 'error');
                return;
            }
            

            
            try {
                // 确保AI匹配器已初始化
                if (!aiMatcher) {
                    aiMatcher = new AISemanticMatcher();
                    await aiMatcher.initialize();
                }
                
                // 查找最佳匹配
                const match = await aiMatcher.findBestMatch(promptText);
                
                if (match && match.similarity > 0.05) { // 降低相似度阈值到5%
                    // 直接应用匹配到的参数，不显示匹配信息
                    await applyMatchedParameters(match.params, promptText);
                    
                    console.log(`🎯 Applied parameters from "${match.prompt}" with ${Math.round(match.similarity * 100)}% similarity`);
                    
                } else {
                    // 使用默认的演示参数，但不显示错误信息
                    console.log(`💡 Using creative default parameters for: "${promptText}"`);
                    
                    const defaultParams = [
                        "50 * (150.0, 12.0, 25.0, 0.5, 0.5, 50.0, 0.1, 0.5)",
                        "30 * (200.0, 8.0, 20.0, 0.8, 0.3, 30.0, 0.2, 0.7)"
                    ];
                    await applyMatchedParameters(defaultParams, promptText);
                }
                
            } catch (error) {
                console.error('❌ AI generation failed:', error);
                showAIStatus('❌ Generation failed / ❌ 生成失败', 'error');
            }
        }
        
        // 应用匹配到的参数
        async function applyMatchedParameters(paramStrings, originalPrompt) {
            try {
                // 清空现有个体
                individuals = [];
                
                // 解析并应用参数
                const centerX = 600 / 2;
                const centerY = 600 / 2;
                const spawnRadius = 80;
                
                paramStrings.forEach(paramStr => {
                    // 解析格式: "count * (param1, param2, ...)"
                    const match = paramStr.trim().match(/(\d+)\s*\*\s*\(([^)]+)\)/);
                    if (match) {
                        const count = parseInt(match[1]);
                        const params = match[2].split(',').map(p => parseFloat(p.trim()));
                        
                        if (params.length === 8) {
                            const swarmParams = new SwarmParameters(
                                params[0], params[1], params[2],
                                params[3], params[4], params[5],
                                params[6], params[7]
                            );
                            
                            // 生成个体
                            for (let i = 0; i < count; i++) {
                                const angle = Math.random() * 2 * Math.PI;
                                const radius = Math.random() * spawnRadius;
                                
                                const x = centerX + Math.cos(angle) * radius;
                                const y = centerY + Math.sin(angle) * radius;
                                
                                const individual = new SwarmIndividual(
                                    x, y,
                                    (Math.random() - 0.5) * 2,
                                    (Math.random() - 0.5) * 2,
                                    swarmParams
                                );
                                individuals.push(individual);
                            }
                        }
                    }
                });
                
                // 更新参数显示
                updatePopulationDisplay();
                
                // 自动开始模拟
                if (!isRunning) {
                    startSimulation();
                }
                
                console.log(`🎨 Generated ${individuals.length} particles for "${originalPrompt}"`);
                
            } catch (error) {
                console.error('❌ Failed to apply parameters:', error);
                throw error;
            }
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('swarmCanvas');
            ctx = canvas.getContext('2d');
            
            // 设置高DPI支持
            const dpr = window.devicePixelRatio || 1;
            const displayWidth = 600;
            const displayHeight = 600;
            
            canvas.width = displayWidth * dpr;
            canvas.height = displayHeight * dpr;
            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';
            ctx.scale(dpr, dpr);
            
            // 初始化语言系统
            initializeLanguage();
            
            setupEventListeners();
            setupConceptOverlay(); // 设置概念文字叠加层
            setupDialogOverlays(); // 设置对话框叠加层
            initializeSwarm();
            animate();
            
            // 初始化AI匹配器（异步）
            setTimeout(async () => {
                try {
                    aiMatcher = new AISemanticMatcher();
                    await aiMatcher.initialize();
                    console.log('🤖 AI Semantic Matcher initialized');
                } catch (error) {
                    console.warn('⚠️ AI Matcher initialization failed:', error);
                }
            }, 1000);
            
            // 设置Enter键快捷方式
            const promptInput = document.getElementById('aiPromptInput');
            if (promptInput) {
                promptInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        generateFromPrompt();
                    }
                });
            }
            
            console.log('🎮 SwarmChemistry Cloud Edition initialized');
            console.log('🖼️ Canvas size: 600x600');
            console.log('🌐 Server URL:', SYNC_CONFIG.serverUrl);
            console.log('🌍 Language:', currentLanguage);
        });
        
        // 概念文字叠加层设置
        function setupConceptOverlay() {
            const overlay = document.getElementById('conceptOverlay');
            
            // 页面加载时显示概念文字
            showConcept();
            
            // 点击叠加层任意位置关闭
            overlay.addEventListener('click', (e) => {
                if (isConceptVisible) {
                    hideConcept();
                }
            });
            
            // 防止内容区域点击事件冒泡
            const content = overlay.querySelector('.concept-content');
            if (content) {
                content.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
            
            // ESC键关闭概念文字和对话框
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (isConceptVisible) {
                        hideConcept();
                    } else {
                        // 检查并关闭其他对话框
                        const syncConfirm = document.getElementById('syncConfirmOverlay');
                        const syncResult = document.getElementById('syncResultOverlay');
                        
                        if (!syncConfirm.classList.contains('hidden')) {
                            cancelSync();
                        } else if (!syncResult.classList.contains('hidden')) {
                            closeSyncResult();
                        }
                    }
                }
            });
        }
        
        // 对话框叠加层设置
        function setupDialogOverlays() {
            // 同步确认对话框
            const syncConfirmOverlay = document.getElementById('syncConfirmOverlay');
            syncConfirmOverlay.addEventListener('click', (e) => {
                if (e.target === syncConfirmOverlay) {
                    cancelSync();
                }
            });
            
            // 防止内容区域点击事件冒泡
            const syncConfirmContent = syncConfirmOverlay.querySelector('.sync-confirm-content');
            if (syncConfirmContent) {
                syncConfirmContent.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
            
            // 同步结果对话框
            const syncResultOverlay = document.getElementById('syncResultOverlay');
            syncResultOverlay.addEventListener('click', (e) => {
                if (e.target === syncResultOverlay) {
                    closeSyncResult();
                }
            });
            
            // 防止内容区域点击事件冒泡
            const syncResultContent = syncResultOverlay.querySelector('.sync-result-content');
            if (syncResultContent) {
                syncResultContent.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        }
        
        // 事件监听器设置
        function setupEventListeners() {
            // 鼠标事件
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
            });
            
            canvas.addEventListener('mouseenter', () => {
                mouseInfluence = true;
            });
            
            canvas.addEventListener('mouseleave', () => {
                mouseInfluence = false;
            });
            
            // 键盘事件
            document.addEventListener('keydown', (e) => {
                // 检查是否在输入框中
                const activeElement = document.activeElement;
                const isInInput = activeElement && (
                    activeElement.tagName === 'INPUT' || 
                    activeElement.tagName === 'TEXTAREA' ||
                    activeElement.contentEditable === 'true'
                );
                
                // 只有不在输入框中时才响应空格键
                if (e.key === ' ' && !isInInput) {
                    e.preventDefault();
                    togglePlayPause();
                }
            });
        }
        
        // 种群初始化 - 与原始版本完全一致
        function initializeSwarm() {
            individuals = [];
            
            // 创建多个不同参数的种群 - 使用原始默认参数
            const populations = [
                { count: 49, params: new SwarmParameters(184.07, 12.64, 38.49, 0.67, 0.31, 63.78, 0.11, 0.21) },
                { count: 67, params: new SwarmParameters(177.92, 15.66, 11.05, 0.85, 0.41, 51.77, 0.09, 0.86) },
                { count: 58, params: new SwarmParameters(177.92, 15.66, 11.05, 0.85, 0.41, 51.77, 0.03, 0.86) },
                { count: 10, params: new SwarmParameters(298.48, 0.65, 19.27, 0.84, 0.11, 83.18, 0.24, 0.5) },
                { count: 37, params: new SwarmParameters(81.6, 18.34, 27.3, 0.94, 0.17, 3.41, 0.2, 0.9) },
                { count: 1, params: new SwarmParameters(274.4, 3.33, 7.42, 0.9, 0.19, 7.37, 0.43, 0.17) },
                { count: 12, params: new SwarmParameters(203.64, 3.33, 7.42, 0.9, 0.19, 7.37, 0.43, 0.17) }
            ];
            
            // 计算画布中心点 - 适应新尺寸
            const centerX = 600 / 2;
            const centerY = 600 / 2;
            const spawnRadius = 80; // 稍微增大生成半径
            
            populations.forEach(pop => {
                for (let i = 0; i < pop.count; i++) {
                    // 在圆形区域内随机生成位置
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * spawnRadius;
                    
                    const x = centerX + Math.cos(angle) * radius;
                    const y = centerY + Math.sin(angle) * radius;
                    
                    const individual = new SwarmIndividual(
                        x, y,
                        (Math.random() - 0.5) * 2, // 初始速度
                        (Math.random() - 0.5) * 2,
                        pop.params.clone()
                    );
                    individuals.push(individual);
                }
            });
            
            updatePopulationDisplay();
        }
        
        // 核心群体行为算法 - 与Java版本完全一致
        function simulateSwarmBehavior() {
            const mouseAgent = mouseInfluence ? {
                x: mouseX,
                y: mouseY,
                dx: 0,
                dy: 0
            } : null;
            
            individuals.forEach(individual => {
                const neighbors = findNeighbors(individual, mouseAgent);
                const params = individual.parameters;
                
                let ax = 0, ay = 0;
                
                if (neighbors.length === 0) {
                    // 无邻居时随机移动 - 与Java版本一致
                    ax = Math.random() - 0.5;
                    ay = Math.random() - 0.5;
                } else {
                    // 计算邻居中心和平均速度
                    let centerX = 0, centerY = 0;
                    let avgDx = 0, avgDy = 0;
                    
                    neighbors.forEach(neighbor => {
                        centerX += neighbor.x;
                        centerY += neighbor.y;
                        avgDx += neighbor.dx || 0;
                        avgDy += neighbor.dy || 0;
                    });
                    
                    centerX /= neighbors.length;
                    centerY /= neighbors.length;
                    avgDx /= neighbors.length;
                    avgDy /= neighbors.length;
                    
                    // c1: 聚集行为 - 与Java版本完全一致
                    ax += (centerX - individual.x) * params.c1;
                    ay += (centerY - individual.y) * params.c1;
                    
                    // c2: 对齐行为 - 与Java版本完全一致
                    ax += (avgDx - individual.dx) * params.c2;
                    ay += (avgDy - individual.dy) * params.c2;
                    
                    // c3: 分离行为 - 与Java版本完全一致
                    neighbors.forEach(neighbor => {
                        const dx = individual.x - neighbor.x;
                        const dy = individual.y - neighbor.y;
                        let distSq = dx * dx + dy * dy;
                        
                        if (distSq === 0) distSq = 0.001; // 与Java版本一致的处理
                        ax += (dx / distSq) * params.c3;
                        ay += (dy / distSq) * params.c3;
                    });
                    
                    // c4: 随机性 - 与Java版本完全一致
                    if (Math.random() < params.c4) {
                        ax += Math.random() * 10 - 5;
                        ay += Math.random() * 10 - 5;
                    }
                }
                
                // 使用原始最大速度参数
                individual.accelerate(ax, ay, params.maxSpeed);
                
                // c5: 速度调节 - 与Java版本完全一致
                const currentSpeed = Math.sqrt(individual.dx2 * individual.dx2 + individual.dy2 * individual.dy2);
                if (currentSpeed === 0) {
                    // 避免除零错误
                    individual.accelerate(0, 0, params.maxSpeed);
                } else {
                    const speedDiff = params.normalSpeed - currentSpeed;
                    individual.accelerate(
                        (individual.dx2 / currentSpeed) * speedDiff * params.c5,
                        (individual.dy2 / currentSpeed) * speedDiff * params.c5,
                        params.maxSpeed
                    );
                }
            });
        }
        
        // 查找邻居 - 与Java版本完全一致
        function findNeighbors(individual, mouseAgent = null) {
            const neighbors = [];
            const radiusSq = individual.parameters.neighborhoodRadius * individual.parameters.neighborhoodRadius;
            
            // 查找其他个体邻居
            individuals.forEach(other => {
                if (other !== individual) {
                    const dx = individual.x - other.x;
                    const dy = individual.y - other.y;
                    const distSq = dx * dx + dy * dy;
                    
                    if (distSq < radiusSq) {
                        neighbors.push(other);
                    }
                }
            });
            
            // 鼠标影响 - 与Java版本一致的权重
            if (mouseAgent) {
                const dx = individual.x - mouseAgent.x;
                const dy = individual.y - mouseAgent.y;
                const distSq = dx * dx + dy * dy;
                
                if (distSq < radiusSq) {
                    // Java版本使用weightOfMouseCursor = 20
                    for (let i = 0; i < 20; i++) {
                        neighbors.push(mouseAgent);
                    }
                }
            }
            
            return neighbors;
        }
        
        // 更新
        function update() {
            if (!isRunning) return;
            
            simulateSwarmBehavior();
            
            individuals.forEach(individual => {
                individual.move();
                individual.wrapAround(600, 600); // 使用固定画布尺寸
            });
        }
        
        // 渲染
        function render() {
            // 完全清空画布
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, 600, 600); // 使用固定画布尺寸
            
            // 绘制个体
            individuals.forEach(individual => {
                const color = individual.parameters.getColor();
                
                // 绘制个体
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(individual.x, individual.y, 3, 0, Math.PI * 2);
                ctx.fill();
                
                // 绘制方向指示
                const speed = Math.sqrt(individual.dx * individual.dx + individual.dy * individual.dy);
                if (speed > 0.05) {
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(individual.x, individual.y);
                    ctx.lineTo(
                        individual.x + (individual.dx / speed) * 6,
                        individual.y + (individual.dy / speed) * 6
                    );
                    ctx.stroke();
                }
            });
            
            // 绘制鼠标影响范围
            if (mouseInfluence && mouseX >= 0) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(mouseX, mouseY, 50, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
        
        // 帧率控制变量
        let targetFPS = 30; // 可调节的目标帧率
        let lastFrameTime = 0;
        
        // 动画循环
        function animate(currentTime = 0) {
            // 帧率控制
            if (currentTime - lastFrameTime >= 1000 / targetFPS) {
                update();
                render();
                lastFrameTime = currentTime;
            }
            requestAnimationFrame(animate);
        }
        
        // 参数调试器相关变量
        let currentPopulations = [];
        let selectedPopulationIndex = -1;
        let originalParameters = null;
        let selectedPopulationIndividuals = []; // 新增：存储选中种群的个体引用
        
        // 统计和显示种群信息
        function updatePopulationDisplay() {
            const populationStats = new Map();
            
            individuals.forEach(individual => {
                const paramStr = individual.parameters.toString();
                if (populationStats.has(paramStr)) {
                    populationStats.set(paramStr, populationStats.get(paramStr) + 1);
                } else {
                    populationStats.set(paramStr, 1);
                }
            });
            
            // 构建参数输入栏的同步文本
            let parameterText = '';
            
            // 更新种群列表用于调试器
            currentPopulations = [];
            
            let index = 1;
            populationStats.forEach((count, params) => {
                parameterText += `${count} * ${params}\n`;
                
                // 解析参数用于调试器
                const match = params.match(/\(([^)]+)\)/);
                if (match) {
                    const paramValues = match[1].split(',').map(p => parseFloat(p.trim()));
                    currentPopulations.push({
                        index: index,
                        count: count,
                        paramString: params, // 添加参数字符串用于匹配
                        parameters: {
                            neighborhoodRadius: paramValues[0],
                            normalSpeed: paramValues[1],
                            maxSpeed: paramValues[2],
                            c1: paramValues[3],
                            c2: paramValues[4],
                            c3: paramValues[5],
                            c4: paramValues[6],
                            c5: paramValues[7]
                        }
                    });
                }
                index++;
            });
            
            // 实时同步到参数输入栏（仅在有个体时）
            const parameterInput = document.getElementById('parameterInput');
            if (parameterInput && individuals.length > 0) {
                parameterInput.value = parameterText.trim();
            }
            
            // 更新调试器的种群选择器
            updatePopulationSelector();
        }
        
        // 更新种群选择器
        function updatePopulationSelector() {
            const selector = document.getElementById('populationSelect');
            if (!selector) return;
            
            // 清空现有选项
            selector.innerHTML = '<option value="">Please select population...</option>';
            
            // 添加种群选项
            currentPopulations.forEach((pop, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Population ${pop.index} (${pop.count} particles)`;
                selector.appendChild(option);
            });
            
            // 如果之前有选中的种群，尝试保持选中状态
            if (selectedPopulationIndex >= 0 && selectedPopulationIndex < currentPopulations.length) {
                selector.value = selectedPopulationIndex;
            } else {
                selectedPopulationIndex = -1;
                selectedPopulationIndividuals = [];
                document.getElementById('parameterSliders').style.display = 'none';
            }
        }
        
        // 选择种群
        function selectPopulation() {
            const selector = document.getElementById('populationSelect');
            const index = parseInt(selector.value);
            
            if (isNaN(index) || index < 0 || index >= currentPopulations.length) {
                selectedPopulationIndex = -1;
                selectedPopulationIndividuals = [];
                document.getElementById('parameterSliders').style.display = 'none';
                document.getElementById('populationInfo').textContent = '';
                return;
            }
            
            selectedPopulationIndex = index;
            const population = currentPopulations[index];
            originalParameters = { ...population.parameters };
            
            // 保存原始粒子数
            if (!population.originalCount) {
                population.originalCount = population.count;
            }
            
            // 找到属于该种群的所有个体
            selectedPopulationIndividuals = [];
            individuals.forEach(individual => {
                if (individual.parameters.toString() === population.paramString) {
                    selectedPopulationIndividuals.push(individual);
                }
            });
            
            // 显示种群信息
            document.getElementById('populationInfo').textContent = 
                `${selectedPopulationIndividuals.length} particles`;
            
            // 更新滑块值
            updateSliders(population.parameters);
            
            // 显示滑块区域
            document.getElementById('parameterSliders').style.display = 'block';
            
            console.log(`🎯 Selected population ${population.index} with ${selectedPopulationIndividuals.length} particles`);
        }
        
        // 更新滑块显示
        function updateSliders(params) {
            // 先设置粒子数
            const particleCountSlider = document.getElementById('slider_particleCount');
            const particleCountValue = document.getElementById('value_particleCount');
            if (particleCountSlider && particleCountValue) {
                const currentCount = selectedPopulationIndividuals.length;
                particleCountSlider.value = currentCount;
                particleCountValue.textContent = currentCount;
            }
            
            const paramNames = ['neighborhoodRadius', 'normalSpeed', 'maxSpeed', 'c1', 'c2', 'c3', 'c4', 'c5'];
            
            paramNames.forEach(name => {
                const slider = document.getElementById(`slider_${name}`);
                const valueSpan = document.getElementById(`value_${name}`);
                
                if (slider && valueSpan) {
                    slider.value = params[name];
                    valueSpan.textContent = params[name].toFixed(2);
                }
            });
        }
        
        // 更新单个参数
        function updateParameter(paramName, value) {
            if (selectedPopulationIndex < 0) return;
            
            if (paramName === 'particleCount') {
                updateParticleCount(parseInt(value));
                return;
            }
            
            if (selectedPopulationIndividuals.length === 0) return;
            
            const numValue = parseFloat(value);
            const valueSpan = document.getElementById(`value_${paramName}`);
            if (valueSpan) {
                valueSpan.textContent = numValue.toFixed(2);
            }
            
            // 更新当前种群参数
            currentPopulations[selectedPopulationIndex].parameters[paramName] = numValue;
            
            // 实时应用到个体
            applyParameterChanges();
        }
        
        // 更新粒子数量
        function updateParticleCount(newCount) {
            if (selectedPopulationIndex < 0 || newCount < 1) return;
            
            const valueSpan = document.getElementById('value_particleCount');
            if (valueSpan) {
                valueSpan.textContent = newCount;
            }
            
            const currentCount = selectedPopulationIndividuals.length;
            const population = currentPopulations[selectedPopulationIndex];
            
            if (newCount > currentCount) {
                // 增加粒子
                const addCount = newCount - currentCount;
                const centerX = 600 / 2;
                const centerY = 600 / 2;
                const spawnRadius = 80;
                
                // 获取当前种群的参数
                const targetParams = population.parameters;
                const swarmParams = new SwarmParameters(
                    targetParams.neighborhoodRadius,
                    targetParams.normalSpeed,
                    targetParams.maxSpeed,
                    targetParams.c1,
                    targetParams.c2,
                    targetParams.c3,
                    targetParams.c4,
                    targetParams.c5
                );
                
                for (let i = 0; i < addCount; i++) {
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * spawnRadius;
                    
                    const x = centerX + Math.cos(angle) * radius;
                    const y = centerY + Math.sin(angle) * radius;
                    
                    const newIndividual = new SwarmIndividual(
                        x, y,
                        (Math.random() - 0.5) * 2,
                        (Math.random() - 0.5) * 2,
                        swarmParams
                    );
                    
                    individuals.push(newIndividual);
                    selectedPopulationIndividuals.push(newIndividual);
                }
                
                console.log(`➕ Added ${addCount} particles to population ${population.index}`);
                
            } else if (newCount < currentCount) {
                // 减少粒子
                const removeCount = currentCount - newCount;
                
                for (let i = 0; i < removeCount; i++) {
                    const individualToRemove = selectedPopulationIndividuals.pop();
                    if (individualToRemove) {
                        const index = individuals.indexOf(individualToRemove);
                        if (index > -1) {
                            individuals.splice(index, 1);
                        }
                    }
                }
                
                console.log(`➖ Removed ${removeCount} particles from population ${population.index}`);
            }
            
            // 更新种群计数
            population.count = newCount;
            
            // 更新显示（仅更新参数输入框，不重建种群列表）
            updateParameterInputOnly();
            
            // 更新种群信息显示
            document.getElementById('populationInfo').textContent = 
                `${selectedPopulationIndividuals.length} particles`;
            
            console.log(`🔢 Updated particle count to ${newCount} for population ${population.index}`);
        }
        
        // 应用参数更改
        function applyParameterChanges() {
            if (selectedPopulationIndex < 0 || selectedPopulationIndividuals.length === 0) return;
            
            const targetParams = currentPopulations[selectedPopulationIndex].parameters;
            
            // 直接更新选中种群的所有个体
            selectedPopulationIndividuals.forEach(individual => {
                individual.parameters.neighborhoodRadius = targetParams.neighborhoodRadius;
                individual.parameters.normalSpeed = targetParams.normalSpeed;
                individual.parameters.maxSpeed = targetParams.maxSpeed;
                individual.parameters.c1 = targetParams.c1;
                individual.parameters.c2 = targetParams.c2;
                individual.parameters.c3 = targetParams.c3;
                individual.parameters.c4 = targetParams.c4;
                individual.parameters.c5 = targetParams.c5;
                
                // 强制清除任何可能的颜色缓存
                if (individual.parameters._cachedColor) {
                    delete individual.parameters._cachedColor;
                }
            });
            
            // 更新显示（但不重新构建种群列表，避免循环）
            updateParameterInputOnly();
            
            // 添加颜色调试信息
            if (selectedPopulationIndividuals.length > 0) {
                const sampleColor = selectedPopulationIndividuals[0].parameters.getColor();
                console.log(`🎨 Color updated for ${selectedPopulationIndividuals.length} particles`);
                console.log(`🎨 New color: ${sampleColor} (c1=${targetParams.c1.toFixed(2)}, c2=${targetParams.c2.toFixed(2)}, c3=${targetParams.c3.toFixed(2)})`);
            }
            
            console.log(`🔧 Applied parameter changes to ${selectedPopulationIndividuals.length} particles`);
        }
        
        // 仅更新参数输入框，不重建种群列表
        function updateParameterInputOnly() {
            const populationStats = new Map();
            
            individuals.forEach(individual => {
                const paramStr = individual.parameters.toString();
                if (populationStats.has(paramStr)) {
                    populationStats.set(paramStr, populationStats.get(paramStr) + 1);
                } else {
                    populationStats.set(paramStr, 1);
                }
            });
            
            // 构建参数输入栏的同步文本
            let parameterText = '';
            
            let index = 1;
            populationStats.forEach((count, params) => {
                parameterText += `${count} * ${params}\n`;
                index++;
            });
            
            // 实时同步到参数输入栏
            const parameterInput = document.getElementById('parameterInput');
            if (parameterInput && individuals.length > 0) {
                parameterInput.value = parameterText.trim();
            }
        }
        
        // 重置选中种群参数
        function resetSelectedPopulation() {
            if (selectedPopulationIndex < 0 || !originalParameters) return;
            
            // 恢复原始参数
            currentPopulations[selectedPopulationIndex].parameters = { ...originalParameters };
            
            // 恢复原始粒子数
            const population = currentPopulations[selectedPopulationIndex];
            const originalCount = population.originalCount || population.count;
            if (originalCount !== selectedPopulationIndividuals.length) {
                updateParticleCount(originalCount);
            }
            
            // 更新滑块显示
            updateSliders(originalParameters);
            
            // 应用更改（如果还有粒子的话）
            if (selectedPopulationIndividuals.length > 0) {
                applyParameterChanges();
            }
            
            console.log(`🔄 Reset parameters and particle count for population ${currentPopulations[selectedPopulationIndex].index}`);
        }
        
        // 预设配置 - 经典SwarmChemistry预设
        const presets = {
            uzushio: [
                { count: 49, params: [184.07, 12.64, 38.49, 0.67, 0.31, 63.78, 0.11, 0.21] },
                { count: 67, params: [177.92, 15.66, 11.05, 0.85, 0.41, 51.77, 0.09, 0.86] },
                { count: 58, params: [177.92, 15.66, 11.05, 0.85, 0.41, 51.77, 0.03, 0.86] },
                { count: 10, params: [298.48, 0.65, 19.27, 0.84, 0.11, 83.18, 0.24, 0.5] },
                { count: 37, params: [81.6, 18.34, 27.3, 0.94, 0.17, 3.41, 0.2, 0.9] },
                { count: 1, params: [274.4, 3.33, 7.42, 0.9, 0.19, 7.37, 0.43, 0.17] },
                { count: 12, params: [203.64, 3.33, 7.42, 0.9, 0.19, 7.37, 0.43, 0.17] }
            ],
            insurmountable_wall: [
                { count: 42, params: [52.57, 9.91, 20.42, 0.32, 0.76, 1.8, 0.01, 0.64] },
                { count: 25, params: [84.87, 8.82, 24.98, 0.91, 0.44, 40.97, 0.18, 0.6] },
                { count: 45, params: [220.42, 4.65, 7.53, 0.96, 0.35, 46.18, 0.25, 1.0] },
                { count: 49, params: [279.64, 10.29, 35.95, 0.37, 0.49, 38.09, 0.32, 0.89] }
            ],
            cell_with_two_nuclei: [
                { count: 41, params: [249.84, 4.85, 28.73, 0.34, 0.45, 14.44, 0.09, 0.82] },
                { count: 26, params: [277.87, 15.02, 35.48, 0.68, 0.05, 82.96, 0.46, 0.9] },
                { count: 30, params: [277.87, 15.02, 24.44, 0.68, 0.05, 82.96, 0.43, 0.9] },
                { count: 28, params: [110.8, 16.12, 38.6, 0.18, 0.34, 14.3, 0.01, 0.01] },
                { count: 48, params: [83.79, 13.29, 7.54, 0.08, 0.79, 1.07, 0.15, 0.45] },
                { count: 74, params: [269.64, 6.62, 34.69, 0.36, 0.5, 30.2, 0.03, 0.23] }
            ],
            multicellularity: [
                { count: 99, params: [19.8, 15.73, 2.61, 0.85, 0.64, 10.51, 0.17, 0.06] },
                { count: 48, params: [300.0, 14.63, 0.0, 0.48, 0.81, 90.27, 0.25, 0.78] },
                { count: 37, params: [275.18, 16.9, 7.05, 0.48, 0.81, 90.27, 0.17, 0.85] },
                { count: 8, params: [159.59, 2.09, 24.19, 0.96, 0.59, 76.03, 0.01, 0.07] },
                { count: 42, params: [73.07, 1.82, 2.36, 0.27, 0.61, 40.55, 0.22, 0.86] }
            ],
            jelly_fish: [
                { count: 134, params: [262.65, 12.01, 25.87, 0.97, 1.0, 56.35, 0.26, 0.61] },
                { count: 67, params: [288.17, 6.19, 23.37, 0.95, 1.0, 1.31, 0.1, 0.9] },
                { count: 68, params: [150.5, 12.97, 15.87, 0.46, 0.39, 57.95, 0.17, 0.48] }
            ],
            playing_catch: [
                { count: 76, params: [84.06, 0.09, 9.89, 0.33, 0.32, 15.66, 0.22, 0.68] },
                { count: 100, params: [158.86, 18.4, 24.98, 0.3, 0.3, 1.72, 0.06, 0.37] }
            ],
            pulsating_eye: [
                { count: 102, params: [293.86, 17.06, 38.3, 0.81, 0.05, 0.83, 0.2, 0.9] },
                { count: 124, params: [226.18, 19.27, 24.57, 0.95, 0.84, 13.09, 0.07, 0.8] },
                { count: 74, params: [49.98, 8.44, 4.39, 0.92, 0.14, 96.92, 0.13, 0.51] }
            ],
            fast_walker_slow_follower: [
                { count: 67, params: [216.35, 11.75, 7.7, 0.83, 0.97, 97.31, 0.02, 0.38] },
                { count: 29, params: [254.64, 7.28, 7.0, 0.95, 0.11, 22.41, 0.43, 0.31] },
                { count: 13, params: [105.4, 3.55, 5.24, 0.34, 0.18, 23.53, 0.39, 0.24] }
            ],
            swinger: [
                { count: 48, params: [150.39, 15.89, 23.54, 0.74, 0.45, 62.65, 0.33, 0.13] },
                { count: 152, params: [217.14, 12.13, 12.42, 0.59, 0.98, 14.06, 0.04, 0.65] },
                { count: 14, params: [248.54, 5.85, 22.26, 0.43, 0.11, 17.14, 0.06, 0.68] },
                { count: 31, params: [141.53, 2.91, 4.86, 0.92, 0.03, 21.87, 0.28, 0.2] }
            ],
            rotary: [
                { count: 29, params: [122.13, 19.19, 17.98, 0.65, 0.44, 19.88, 0.46, 0.2] },
                { count: 51, params: [299.13, 0.79, 38.71, 0.25, 0.18, 86.49, 0.38, 0.43] },
                { count: 10, params: [252.92, 19.99, 10.21, 0.23, 0.17, 1.22, 0.28, 0.92] }
            ],
            wedding_ring: [
                { count: 24, params: [220.51, 13.88, 3.47, 0.46, 0.38, 6.23, 0.19, 0.68] },
                { count: 13, params: [64.07, 1.4, 19.7, 0.88, 0.27, 0.36, 0.47, 0.72] },
                { count: 35, params: [117.53, 7.31, 21.72, 0.3, 0.5, 98.69, 0.03, 0.29] }
            ],
            linear_oscillator: [
                { count: 133, params: [214.41, 17.93, 35.14, 0.64, 0.13, 0.29, 0.08, 0.97] },
                { count: 24, params: [253.6, 7.19, 15.51, 0.82, 0.33, 32.65, 0.34, 0.56] }
            ]
        };
        
        // 加载预设
        function loadPreset(presetName) {
            if (!presets[presetName]) {
                console.error('未找到预设:', presetName);
                return;
            }
            
            individuals = [];
            const presetData = presets[presetName];
            
            // 计算画布中心点 - 适应新尺寸
            const centerX = 600 / 2;
            const centerY = 600 / 2;
            const spawnRadius = 80;
            
            presetData.forEach((pop, index) => {
                const params = new SwarmParameters(
                    pop.params[0], pop.params[1], pop.params[2],
                    pop.params[3], pop.params[4], pop.params[5],
                    pop.params[6], pop.params[7]
                );
                
                // 生成个体
                for (let i = 0; i < pop.count; i++) {
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * spawnRadius;
                    
                    const x = centerX + Math.cos(angle) * radius;
                    const y = centerY + Math.sin(angle) * radius;
                    
                    individuals.push(new SwarmIndividual(
                        x, y,
                        (Math.random() - 0.5) * 2,
                        (Math.random() - 0.5) * 2,
                        params
                    ));
                }
            });
            
            updatePopulationDisplay();
            
            if (!isRunning) {
                startSimulation();
            }
            
            console.log(`🎯 Loaded preset: ${presetName}, Total particles: ${individuals.length}`);
        }
        
        // 控制函数
        function startSimulation() {
            isRunning = true;
        }
        
        function pauseSimulation() {
            isRunning = false;
        }
        
        function clearCanvas() {
            pauseSimulation();
            individuals = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updatePopulationDisplay();
        }
        
        function resetView() {
            initializeSwarm();
        }
        
        function togglePlayPause() {
            if (isRunning) {
                pauseSimulation();
            } else {
                startSimulation();
            }
        }
        
        // 解析自定义参数
        function parseCustomParameters() {
            const input = document.getElementById('parameterInput').value.trim();
            
            if (!input) {
                showParseStatus('Please enter parameters! / 请输入参数！', 'error');
                return;
            }
            
            showParseStatus('🔍 Parsing parameters... / 正在解析参数...', 'info');
            
            try {
                const lines = input.split('\n').filter(line => line.trim());
                individuals = [];
                let totalParsed = 0;
                
                // 计算画布中心点
                const centerX = 600 / 2;
                const centerY = 600 / 2;
                const spawnRadius = 80;
                
                lines.forEach((line, index) => {
                    // 匹配格式: count * (param1, param2, param3, param4, param5, param6, param7, param8)
                    const match = line.trim().match(/(\d+)\s*\*\s*\(([^)]+)\)/);
                    
                    if (match) {
                        const count = parseInt(match[1]);
                        const params = match[2].split(',').map(p => parseFloat(p.trim()));
                        
                        if (params.length === 8 && params.every(p => !isNaN(p))) {
                            const swarmParams = new SwarmParameters(
                                params[0], params[1], params[2],
                                params[3], params[4], params[5],
                                params[6], params[7]
                            );
                            
                            // 生成个体
                            for (let i = 0; i < count; i++) {
                                const angle = Math.random() * 2 * Math.PI;
                                const radius = Math.random() * spawnRadius;
                                
                                const x = centerX + Math.cos(angle) * radius;
                                const y = centerY + Math.sin(angle) * radius;
                                
                                individuals.push(new SwarmIndividual(
                                    x, y,
                                    (Math.random() - 0.5) * 2,
                                    (Math.random() - 0.5) * 2,
                                    swarmParams
                                ));
                            }
                            
                            totalParsed += count;
                        } else {
                            throw new Error(`Line ${index + 1} parameter format error: requires 8 numeric parameters / 第 ${index + 1} 行参数格式错误：需要8个数值参数`);
                        }
                    } else {
                        throw new Error(`Line ${index + 1} format error: should be "count * (param1, param2, ...param8)" / 第 ${index + 1} 行格式错误：应为 "数量 * (参数1, 参数2, ...参数8)"`);
                    }
                });
                
                if (individuals.length === 0) {
                    throw new Error('No valid parameter lines found / 没有找到有效的参数行');
                }
                
                updatePopulationDisplay();
                
                // 如果没有运行，开始模拟
                if (!isRunning) {
                    startSimulation();
                }
                
                showParseStatus(`✅ Parse successful! Created ${totalParsed} particles`, 'success');
                console.log(`📝 Custom parameters parsed successfully: ${totalParsed} particles`);
                
            } catch (error) {
                console.error('❌ Parameter parsing failed:', error);
                showParseStatus(`❌ Parse failed: ${error.message}`, 'error');
            }
        }
        
        // 清空参数输入
        function clearParameters() {
            document.getElementById('parameterInput').value = '';
            showParseStatus('Input cleared', 'info');
            setTimeout(() => {
                document.getElementById('parseStatus').style.display = 'none';
            }, 2000);
        }
        
        // 显示解析状态
        function showParseStatus(message, type) {
            const statusDiv = document.getElementById('parseStatus');
            statusDiv.textContent = message;
            statusDiv.className = `parse-status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // 同步到Unity - 显示确认对话框
        async function syncToUnity() {
            if (individuals.length === 0) {
                showSyncStatus('Please select a preset or input parameters first! / 请先选择预设或输入参数！', 'error');
                return;
            }
            
            // 显示确认对话框
            showSyncConfirmDialog();
        }
        
        // 显示同步确认对话框
        function showSyncConfirmDialog() {
            const overlay = document.getElementById('syncConfirmOverlay');
            const statsDiv = document.getElementById('creationStats');
            
            // 统计当前创造的信息
            const populationStats = new Map();
            individuals.forEach(individual => {
                const paramStr = individual.parameters.toString();
                if (populationStats.has(paramStr)) {
                    populationStats.set(paramStr, populationStats.get(paramStr) + 1);
                } else {
                    populationStats.set(paramStr, 1);
                }
            });
            
            // 构建统计信息
            let statsText = `Total Individuals: ${individuals.length}\n`;
            statsText += `Population Groups: ${populationStats.size}\n\n`;
            
            let groupIndex = 1;
            populationStats.forEach((count, params) => {
                statsText += `Group ${groupIndex}: ${count} particles\n`;
                statsText += `Parameters: ${params}\n\n`;
                groupIndex++;
            });
            
            statsDiv.textContent = statsText;
            
            // 清空之前的名字输入
            document.getElementById('creationName').value = '';
            
            // 显示对话框
            overlay.classList.remove('hidden');
            
            console.log('🎯 Sync confirmation dialog shown');
        }
        
        // 取消同步
        function cancelSync() {
            const overlay = document.getElementById('syncConfirmOverlay');
            overlay.classList.add('hidden');
            console.log('❌ Sync cancelled by user');
        }
        
        // 确认同步
        async function confirmSync() {
            const creationName = document.getElementById('creationName').value.trim();
            const overlay = document.getElementById('syncConfirmOverlay');
            
            // 隐藏确认对话框
            overlay.classList.add('hidden');
            
            // 开始同步过程
            showSyncStatus('🚀 Syncing to Unity... / 正在同步到Unity...', 'info');
            
            try {
                // 收集种群数据
                const populationStats = new Map();
                
                individuals.forEach(individual => {
                    const paramStr = individual.parameters.toString();
                    if (populationStats.has(paramStr)) {
                        populationStats.set(paramStr, populationStats.get(paramStr) + 1);
                    } else {
                        populationStats.set(paramStr, 1);
                    }
                });
                
                const populations = [];
                populationStats.forEach((count, paramStr) => {
                    // 从字符串中解析参数
                    const match = paramStr.match(/\(([^)]+)\)/);
                    if (match) {
                        const params = match[1].split(',').map(p => parseFloat(p.trim()));
                        populations.push({
                            count: count,
                            parameters: {
                                neighborhoodRadius: params[0],
                                normalSpeed: params[1],
                                maxSpeed: params[2],
                                c1: params[3],
                                c2: params[4],
                                c3: params[5],
                                c4: params[6],
                                c5: params[7],
                                color: `rgb(${Math.floor((params[3] / 1.0) * 0.8 * 255)}, ${Math.floor((params[4] / 1.0) * 0.8 * 255)}, ${Math.floor((params[5] / 100.0) * 0.8 * 255)})`
                            }
                        });
                    }
                });
                
                const swarmData = {
                    sessionId: 'web_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    timestamp: new Date().toISOString(),
                    populations: populations,
                    totalIndividuals: individuals.length,
                    userAgent: navigator.userAgent,
                    source: 'SwarmChemistry Web Cloud',
                    creationName: creationName || 'Unnamed Creation'
                };
                
                console.log('📤 Sending data to server:', swarmData);
                
                const response = await fetch(SYNC_CONFIG.serverUrl + '/swarm-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(swarmData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 显示数字纪念碑
                    showSyncResult(swarmData, result);
                    console.log('✅ Sync successful:', result);
                } else {
                    throw new Error(result.message || 'Sync failed');
                }
                
            } catch (error) {
                console.error('❌ Sync failed:', error);
                showSyncStatus(`❌ Sync failed: ${error.message}`, 'error');
            }
        }
        
        // 显示同步结果（数字纪念碑）
        function showSyncResult(swarmData, result) {
            const overlay = document.getElementById('syncResultOverlay');
            const monumentContent = document.getElementById('monumentContent');
            
            // 构建纪念碑内容
            const creationName = swarmData.creationName || 'Unnamed Creation';
            const timestamp = new Date(swarmData.timestamp).toLocaleDateString();
            const time = new Date(swarmData.timestamp).toLocaleTimeString();
            
            let monumentText = '';
            if (creationName !== 'Unnamed Creation') {
                monumentText += `<div class="creation-name">"${creationName}"</div>`;
            }
            
            monumentText += `
                <p>Created on ${timestamp} at ${time}</p>
                <p>Total Consciousness Units: ${swarmData.totalIndividuals}</p>
                <p>Population Groups: ${swarmData.populations.length}</p>
                <p>Data ID: ${result.dataId}</p>
                <p>Session: ${swarmData.sessionId}</p>
                <br>
                <p style="font-style: italic; color: #7d5fb8;">
                    "Your consciousness has been deployed into the living world.<br>
                    It will evolve, interact, and create new possibilities<br>
                    alongside other digital life forms."
                </p>
            `;
            
            monumentContent.innerHTML = monumentText;
            
            // 隐藏普通状态消息
            document.getElementById('syncStatus').style.display = 'none';
            
            // 显示纪念碑
            overlay.classList.remove('hidden');
            
            console.log('🏛️ Digital monument displayed for:', creationName);
        }
        
        // 关闭同步结果
        function closeSyncResult() {
            const overlay = document.getElementById('syncResultOverlay');
            overlay.classList.add('hidden');
            console.log('🏛️ Digital monument closed');
        }
        
        // 创造另一个
        function createAnother() {
            closeSyncResult();
            resetView(); // 重置到初始状态
            console.log('🔄 Starting new creation...');
        }
        
        // 显示同步状态
        function showSyncStatus(message, type) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.textContent = message;
            statusDiv.className = `sync-status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        console.log('🌐 SwarmChemistry Cloud Edition loaded');
        console.log('🔗 API endpoint:', SYNC_CONFIG.serverUrl);
        
        // 直播控制功能
        let isLivestreamPlaying = false;
        const LIVE_URL = 'https://player.livepush.io/live/em2skFpl0x-JHsX3';
        
        // 开始观看直播
        function startLivestream() {
            const overlay = document.getElementById('livestreamOverlay');
            const iframe = document.getElementById('bilibiliFrame');
            
            // 直接设置iframe的src为实际的直播链接
            iframe.src = LIVE_URL;
            
            overlay.classList.add('hidden');
            isLivestreamPlaying = true;
            
            console.log('🎥 直播已开始，链接：', LIVE_URL);
        }
        
        // 添加滑入滑出动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html> 