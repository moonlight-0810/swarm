<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾¤ä½“åŒ–å­¦ - SwarmChemistry äº‘ç«¯ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            overflow-x: auto;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            align-items: start;
        }
        
        .canvas-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .controls-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            height: fit-content;
            max-height: 850px;
            overflow-y: auto;
        }
        
        canvas {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: #000;
            display: block;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .canvas-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .control-group h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
        
        button:hover {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .population-display {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 10px;
            white-space: pre-line;
            border: 1px solid rgba(255,255,255,0.1);
            line-height: 1.4;
        }
        
        /* ç½‘ç»œåŒæ­¥æ ·å¼ */
        .sync-button {
            background: linear-gradient(145deg, #4CAF50, #45a049) !important;
            border-color: #4CAF50 !important;
            font-weight: bold;
            font-size: 16px;
            padding: 12px 24px;
        }
        
        .sync-button:hover {
            background: linear-gradient(145deg, #5CBF60, #4CAF50) !important;
        }
        
        .sync-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }
        
        .sync-status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #4CAF50;
        }
        
        .sync-status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            color: #f44336;
        }
        
        .sync-status.info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
            color: #2196F3;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .controls-section {
                max-height: none;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .preset-buttons {
                grid-template-columns: 1fr;
            }
            
            canvas {
                max-width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ ç¾¤ä½“åŒ–å­¦ - SwarmChemistry</h1>
            <p>ğŸŒ äº‘ç«¯ç‰ˆ - åˆ›ä½œç²’å­è¡Œä¸ºï¼ŒåŒæ­¥åˆ°Unityä½“éªŒ</p>
        </div>
        
        <div class="main-layout">
            <div class="canvas-section">
                <canvas id="swarmCanvas" width="800" height="600"></canvas>
                <div class="canvas-controls">
                    <button onclick="startSimulation()">â–¶ï¸ å¼€å§‹</button>
                    <button onclick="pauseSimulation()">â¸ï¸ æš‚åœ</button>
                    <button onclick="clearCanvas()">ğŸ—‘ï¸ æ¸…ç©º</button>
                    <button onclick="resetView()">ğŸ”„ é‡ç½®è§†å›¾</button>
                </div>
            </div>
            
            <div class="controls-section">
                <div class="control-group">
                    <h3>ğŸ¯ ç»å…¸é¢„è®¾</h3>
                    <div class="preset-buttons">
                        <button onclick="loadPreset('schooling')">ğŸŸ é±¼ç¾¤æ¸¸æ³³</button>
                        <button onclick="loadPreset('flocking')">ğŸ¦… é¸Ÿç¾¤é£è¡Œ</button>
                        <button onclick="loadPreset('swarming')">ğŸ èœ‚ç¾¤èšé›†</button>
                        <button onclick="loadPreset('herding')">ğŸ‘ ç¾Šç¾¤æ”¾ç‰§</button>
                        <button onclick="loadPreset('hunting')">ğŸº ç‹¼ç¾¤ç‹©çŒ</button>
                        <button onclick="loadPreset('migration')">ğŸ¦‹ è´è¶è¿å¾™</button>
                        <button onclick="loadPreset('dancing')">ğŸ’ƒ ç¾¤ä½“èˆè¹ˆ</button>
                        <button onclick="loadPreset('spiral')">ğŸŒ€ èºæ—‹è¿åŠ¨</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>ğŸ”¬ å¤æ‚è¡Œä¸º</h3>
                    <div class="preset-buttons">
                        <button onclick="loadPreset('ecosystem')">ğŸŒ¿ ç”Ÿæ€ç³»ç»Ÿ</button>
                        <button onclick="loadPreset('competition')">âš”ï¸ ç«äº‰æ¨¡å¼</button>
                        <button onclick="loadPreset('cooperation')">ğŸ¤ åˆä½œæ¨¡å¼</button>
                        <button onclick="loadPreset('chaos')">ğŸŒªï¸ æ··æ²Œç³»ç»Ÿ</button>
                        <button onclick="loadPreset('emergence')">âœ¨ æ¶Œç°è¡Œä¸º</button>
                        <button onclick="loadPreset('phase_transition')">ğŸ”„ ç›¸å˜ç°è±¡</button>
                        <button onclick="loadPreset('collective_intelligence')">ğŸ§  é›†ä½“æ™ºèƒ½</button>
                        <button onclick="loadPreset('self_organization')">ğŸ—ï¸ è‡ªç»„ç»‡</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>ğŸ¨ è‰ºæœ¯æ•ˆæœ</h3>
                    <div class="preset-buttons">
                        <button onclick="loadPreset('galaxy')">ğŸŒŒ æ˜Ÿç³»æ—‹è½¬</button>
                        <button onclick="loadPreset('fireworks')">ğŸ† çƒŸèŠ±ç»½æ”¾</button>
                        <button onclick="loadPreset('aurora')">ğŸŒˆ æå…‰èˆåŠ¨</button>
                        <button onclick="loadPreset('mandala')">ğŸ•¸ï¸ æ›¼é™€ç½—</button>
                        <button onclick="loadPreset('fractal')">ğŸ”º åˆ†å½¢å›¾æ¡ˆ</button>
                        <button onclick="loadPreset('wave')">ğŸŒŠ æ³¢æµªæ•ˆæœ</button>
                        <button onclick="loadPreset('crystal')">ğŸ’ æ™¶ä½“ç”Ÿé•¿</button>
                        <button onclick="loadPreset('plasma')">âš¡ ç­‰ç¦»å­ä½“</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>ğŸš€ åŒæ­¥åˆ°Unity</h3>
                    <button class="sync-button" onclick="syncToUnity()">ğŸš€ åŒæ­¥åˆ°Unity</button>
                    <div id="syncStatus" class="sync-status" style="display: none;"></div>
                </div>
                
                <div class="control-group">
                    <h3>ğŸ“Š å½“å‰ç§ç¾¤</h3>
                    <div id="populationDisplay" class="population-display">
                        ç‚¹å‡»é¢„è®¾æŒ‰é’®æ¥ç”Ÿæˆç²’å­ç§ç¾¤...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let canvas, ctx;
        let populations = [];
        let animationId;
        let isRunning = false;
        
        // åŒæ­¥é…ç½® - ä½¿ç”¨å½“å‰åŸŸå
        const SYNC_CONFIG = {
            serverUrl: window.location.origin + '/api',
            enabled: true
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('swarmCanvas');
            ctx = canvas.getContext('2d');
            
            // è®¾ç½®é«˜DPIæ”¯æŒ
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            console.log('ğŸ® SwarmChemistry äº‘ç«¯ç‰ˆåˆå§‹åŒ–å®Œæˆ');
            console.log('ğŸŒ æœåŠ¡å™¨åœ°å€:', SYNC_CONFIG.serverUrl);
        });
        
        // é¢„è®¾é…ç½®
        const presets = {
            schooling: [
                { count: 80, params: [120, 8, 15, 0.8, 0.6, 0.4, 0.1, 0.7] },
                { count: 60, params: [100, 6, 12, 0.7, 0.5, 0.5, 0.2, 0.6] }
            ],
            flocking: [
                { count: 100, params: [150, 10, 20, 0.6, 0.8, 0.3, 0.15, 0.8] },
                { count: 50, params: [180, 12, 25, 0.5, 0.9, 0.2, 0.1, 0.9] }
            ],
            swarming: [
                { count: 120, params: [80, 5, 12, 0.9, 0.4, 0.6, 0.3, 0.5] },
                { count: 80, params: [60, 4, 10, 0.8, 0.3, 0.7, 0.4, 0.4] }
            ],
            herding: [
                { count: 90, params: [200, 15, 30, 0.7, 0.7, 0.2, 0.05, 0.8] },
                { count: 40, params: [250, 18, 35, 0.6, 0.8, 0.1, 0.03, 0.9] }
            ],
            hunting: [
                { count: 30, params: [300, 20, 40, 0.5, 0.9, 0.1, 0.2, 0.95] },
                { count: 150, params: [80, 8, 15, 0.8, 0.3, 0.8, 0.4, 0.6] }
            ],
            migration: [
                { count: 200, params: [100, 12, 25, 0.4, 0.9, 0.1, 0.05, 0.85] }
            ],
            dancing: [
                { count: 60, params: [120, 8, 20, 0.6, 0.4, 0.3, 0.8, 0.7] },
                { count: 40, params: [100, 10, 18, 0.7, 0.3, 0.4, 0.9, 0.6] },
                { count: 30, params: [80, 6, 15, 0.8, 0.2, 0.5, 0.7, 0.5] }
            ],
            spiral: [
                { count: 100, params: [150, 10, 20, 0.3, 0.2, 0.1, 0.9, 0.8] },
                { count: 80, params: [120, 8, 16, 0.4, 0.3, 0.2, 0.8, 0.7] }
            ],
            ecosystem: [
                { count: 80, params: [100, 8, 15, 0.7, 0.6, 0.4, 0.2, 0.7] },
                { count: 60, params: [150, 12, 20, 0.5, 0.8, 0.2, 0.1, 0.8] },
                { count: 40, params: [200, 15, 25, 0.6, 0.7, 0.3, 0.15, 0.75] },
                { count: 30, params: [80, 6, 12, 0.9, 0.4, 0.6, 0.3, 0.6] }
            ],
            competition: [
                { count: 70, params: [120, 10, 18, 0.8, 0.3, 0.7, 0.4, 0.6] },
                { count: 70, params: [130, 11, 19, 0.7, 0.4, 0.8, 0.3, 0.7] },
                { count: 60, params: [110, 9, 17, 0.9, 0.2, 0.6, 0.5, 0.5] }
            ],
            cooperation: [
                { count: 100, params: [180, 12, 22, 0.6, 0.8, 0.2, 0.1, 0.85] },
                { count: 80, params: [160, 10, 20, 0.7, 0.7, 0.3, 0.15, 0.8] }
            ],
            chaos: [
                { count: 50, params: [80, 15, 30, 0.3, 0.2, 0.1, 0.9, 0.4] },
                { count: 60, params: [100, 18, 35, 0.2, 0.3, 0.2, 0.8, 0.3] },
                { count: 70, params: [120, 20, 40, 0.4, 0.1, 0.3, 0.7, 0.5] },
                { count: 40, params: [60, 12, 25, 0.1, 0.4, 0.1, 0.95, 0.2] }
            ],
            emergence: [
                { count: 150, params: [100, 8, 16, 0.5, 0.5, 0.3, 0.4, 0.6] },
                { count: 100, params: [120, 10, 18, 0.6, 0.4, 0.4, 0.3, 0.7] },
                { count: 50, params: [80, 6, 14, 0.7, 0.6, 0.2, 0.5, 0.5] }
            ],
            phase_transition: [
                { count: 120, params: [150, 5, 10, 0.9, 0.8, 0.1, 0.05, 0.3] },
                { count: 80, params: [200, 15, 30, 0.3, 0.2, 0.8, 0.6, 0.9] }
            ],
            collective_intelligence: [
                { count: 200, params: [120, 8, 16, 0.6, 0.7, 0.3, 0.2, 0.75] },
                { count: 100, params: [100, 10, 18, 0.7, 0.6, 0.4, 0.25, 0.7] },
                { count: 50, params: [80, 6, 14, 0.8, 0.5, 0.5, 0.3, 0.65] }
            ],
            self_organization: [
                { count: 100, params: [100, 8, 16, 0.5, 0.6, 0.4, 0.3, 0.7] },
                { count: 80, params: [120, 10, 18, 0.6, 0.5, 0.5, 0.25, 0.75] },
                { count: 60, params: [80, 6, 14, 0.7, 0.4, 0.6, 0.35, 0.65] },
                { count: 40, params: [60, 4, 12, 0.8, 0.3, 0.7, 0.4, 0.6] }
            ],
            galaxy: [
                { count: 150, params: [200, 5, 15, 0.2, 0.1, 0.05, 0.8, 0.9] },
                { count: 100, params: [180, 8, 18, 0.3, 0.2, 0.1, 0.7, 0.85] },
                { count: 50, params: [160, 12, 22, 0.4, 0.3, 0.15, 0.6, 0.8] }
            ],
            fireworks: [
                { count: 80, params: [50, 20, 40, 0.1, 0.05, 0.02, 0.95, 0.3] },
                { count: 60, params: [60, 18, 35, 0.15, 0.1, 0.05, 0.9, 0.4] },
                { count: 40, params: [70, 15, 30, 0.2, 0.15, 0.1, 0.85, 0.5] }
            ],
            aurora: [
                { count: 120, params: [300, 3, 8, 0.6, 0.9, 0.05, 0.4, 0.95] },
                { count: 100, params: [280, 4, 10, 0.5, 0.8, 0.1, 0.5, 0.9] },
                { count: 80, params: [250, 5, 12, 0.7, 0.7, 0.15, 0.3, 0.85] }
            ],
            mandala: [
                { count: 60, params: [120, 6, 12, 0.8, 0.2, 0.3, 0.6, 0.4] },
                { count: 80, params: [100, 8, 16, 0.7, 0.3, 0.4, 0.5, 0.5] },
                { count: 100, params: [80, 10, 20, 0.6, 0.4, 0.5, 0.4, 0.6] },
                { count: 40, params: [60, 4, 8, 0.9, 0.1, 0.2, 0.7, 0.3] }
            ],
            fractal: [
                { count: 100, params: [80, 6, 12, 0.5, 0.3, 0.2, 0.8, 0.4] },
                { count: 80, params: [100, 8, 16, 0.4, 0.4, 0.3, 0.7, 0.5] },
                { count: 60, params: [120, 10, 20, 0.3, 0.5, 0.4, 0.6, 0.6] },
                { count: 40, params: [60, 4, 8, 0.6, 0.2, 0.1, 0.9, 0.3] }
            ],
            wave: [
                { count: 150, params: [200, 8, 16, 0.3, 0.8, 0.1, 0.6, 0.85] },
                { count: 100, params: [180, 10, 18, 0.4, 0.7, 0.2, 0.5, 0.8] }
            ],
            crystal: [
                { count: 80, params: [60, 2, 6, 0.9, 0.8, 0.7, 0.1, 0.2] },
                { count: 60, params: [80, 3, 8, 0.8, 0.7, 0.6, 0.2, 0.3] },
                { count: 40, params: [100, 4, 10, 0.7, 0.6, 0.5, 0.3, 0.4] }
            ],
            plasma: [
                { count: 200, params: [150, 12, 25, 0.2, 0.1, 0.05, 0.9, 0.8] },
                { count: 150, params: [120, 15, 30, 0.3, 0.2, 0.1, 0.8, 0.7] },
                { count: 100, params: [100, 18, 35, 0.4, 0.3, 0.15, 0.7, 0.6] }
            ]
        };
        
        // åŠ è½½é¢„è®¾
        function loadPreset(presetName) {
            if (!presets[presetName]) {
                console.error('æœªæ‰¾åˆ°é¢„è®¾:', presetName);
                return;
            }
            
            populations = [];
            const presetData = presets[presetName];
            
            presetData.forEach((pop, index) => {
                const population = {
                    count: pop.count,
                    parameters: {
                        neighborhoodRadius: pop.params[0],
                        normalSpeed: pop.params[1],
                        maxSpeed: pop.params[2],
                        c1: pop.params[3],
                        c2: pop.params[4],
                        c3: pop.params[5],
                        c4: pop.params[6],
                        c5: pop.params[7],
                        color: generateRandomColor()
                    },
                    individuals: []
                };
                
                // ç”Ÿæˆä¸ªä½“
                for (let i = 0; i < pop.count; i++) {
                    population.individuals.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        vx: (Math.random() - 0.5) * 4,
                        vy: (Math.random() - 0.5) * 4,
                        color: population.parameters.color
                    });
                }
                
                populations.push(population);
            });
            
            updatePopulationDisplay();
            
            if (isRunning) {
                startSimulation();
            }
            
            console.log(`ğŸ¯ åŠ è½½é¢„è®¾: ${presetName}, ç§ç¾¤æ•°: ${populations.length}`);
        }
        
        // ç”Ÿæˆéšæœºé¢œè‰²
        function generateRandomColor() {
            const hue = Math.floor(Math.random() * 360);
            const saturation = Math.floor(Math.random() * 40) + 60;
            const lightness = Math.floor(Math.random() * 30) + 50;
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }
        
        // æ›´æ–°ç§ç¾¤æ˜¾ç¤º
        function updatePopulationDisplay() {
            const display = document.getElementById('populationDisplay');
            if (populations.length === 0) {
                display.textContent = 'ç‚¹å‡»é¢„è®¾æŒ‰é’®æ¥ç”Ÿæˆç²’å­ç§ç¾¤...';
                return;
            }
            
            let text = `æ€»ç§ç¾¤æ•°: ${populations.length}\n`;
            text += `æ€»ç²’å­æ•°: ${populations.reduce((sum, pop) => sum + pop.count, 0)}\n\n`;
            
            populations.forEach((pop, index) => {
                const params = pop.parameters;
                text += `ç§ç¾¤ ${index + 1}: ${pop.count} ä¸ªç²’å­\n`;
                text += `  é‚»åŸŸåŠå¾„: ${params.neighborhoodRadius.toFixed(1)}\n`;
                text += `  æ­£å¸¸é€Ÿåº¦: ${params.normalSpeed.toFixed(1)}\n`;
                text += `  æœ€å¤§é€Ÿåº¦: ${params.maxSpeed.toFixed(1)}\n`;
                text += `  èšé›†åŠ›: ${params.c1.toFixed(2)}\n`;
                text += `  å¯¹é½åŠ›: ${params.c2.toFixed(2)}\n`;
                text += `  åˆ†ç¦»åŠ›: ${params.c3.toFixed(2)}\n`;
                text += `  éšæœºæ€§: ${params.c4.toFixed(2)}\n`;
                text += `  é€Ÿåº¦è°ƒèŠ‚: ${params.c5.toFixed(2)}\n\n`;
            });
            
            display.textContent = text;
        }
        
        // å¼€å§‹æ¨¡æ‹Ÿ
        function startSimulation() {
            if (populations.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¢„è®¾ï¼');
                return;
            }
            
            isRunning = true;
            animate();
        }
        
        // æš‚åœæ¨¡æ‹Ÿ
        function pauseSimulation() {
            isRunning = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }
        
        // æ¸…ç©ºç”»å¸ƒ
        function clearCanvas() {
            pauseSimulation();
            populations = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updatePopulationDisplay();
        }
        
        // é‡ç½®è§†å›¾
        function resetView() {
            if (populations.length > 0) {
                populations.forEach(pop => {
                    pop.individuals.forEach(individual => {
                        individual.x = Math.random() * canvas.width;
                        individual.y = Math.random() * canvas.height;
                        individual.vx = (Math.random() - 0.5) * 4;
                        individual.vy = (Math.random() - 0.5) * 4;
                    });
                });
            }
        }
        
        // åŠ¨ç”»å¾ªç¯
        function animate() {
            if (!isRunning) return;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            populations.forEach(population => {
                updatePopulation(population);
                drawPopulation(population);
            });
            
            animationId = requestAnimationFrame(animate);
        }
        
        // æ›´æ–°ç§ç¾¤
        function updatePopulation(population) {
            const params = population.parameters;
            
            population.individuals.forEach(individual => {
                let fx = 0, fy = 0;
                let neighbors = 0;
                let avgVx = 0, avgVy = 0;
                let avgX = 0, avgY = 0;
                let sepX = 0, sepY = 0;
                
                // è®¡ç®—é‚»å±…å½±å“
                population.individuals.forEach(other => {
                    if (other === individual) return;
                    
                    const dx = other.x - individual.x;
                    const dy = other.y - individual.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < params.neighborhoodRadius && dist > 0) {
                        neighbors++;
                        avgVx += other.vx;
                        avgVy += other.vy;
                        avgX += other.x;
                        avgY += other.y;
                        
                        // åˆ†ç¦»åŠ›
                        const sepForce = params.c3 / (dist * dist);
                        sepX -= dx * sepForce;
                        sepY -= dy * sepForce;
                    }
                });
                
                if (neighbors > 0) {
                    // å¯¹é½åŠ›
                    avgVx /= neighbors;
                    avgVy /= neighbors;
                    fx += (avgVx - individual.vx) * params.c2;
                    fy += (avgVy - individual.vy) * params.c2;
                    
                    // èšé›†åŠ›
                    avgX /= neighbors;
                    avgY /= neighbors;
                    fx += (avgX - individual.x) * params.c1 * 0.01;
                    fy += (avgY - individual.y) * params.c1 * 0.01;
                }
                
                // åˆ†ç¦»åŠ›
                fx += sepX;
                fy += sepY;
                
                // éšæœºåŠ›
                fx += (Math.random() - 0.5) * params.c4 * 2;
                fy += (Math.random() - 0.5) * params.c4 * 2;
                
                // æ›´æ–°é€Ÿåº¦
                individual.vx += fx * 0.1;
                individual.vy += fy * 0.1;
                
                // é€Ÿåº¦é™åˆ¶
                const speed = Math.sqrt(individual.vx * individual.vx + individual.vy * individual.vy);
                if (speed > params.maxSpeed) {
                    individual.vx = (individual.vx / speed) * params.maxSpeed;
                    individual.vy = (individual.vy / speed) * params.maxSpeed;
                }
                
                // æ›´æ–°ä½ç½®
                individual.x += individual.vx;
                individual.y += individual.vy;
                
                // è¾¹ç•Œå¤„ç†
                if (individual.x < 0) individual.x = canvas.width;
                if (individual.x > canvas.width) individual.x = 0;
                if (individual.y < 0) individual.y = canvas.height;
                if (individual.y > canvas.height) individual.y = 0;
            });
        }
        
        // ç»˜åˆ¶ç§ç¾¤
        function drawPopulation(population) {
            ctx.fillStyle = population.parameters.color;
            
            population.individuals.forEach(individual => {
                ctx.beginPath();
                ctx.arc(individual.x, individual.y, 2, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        // åŒæ­¥åˆ°Unity
        async function syncToUnity() {
            if (populations.length === 0) {
                showSyncStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¢„è®¾ï¼', 'error');
                return;
            }
            
            showSyncStatus('ğŸš€ æ­£åœ¨åŒæ­¥åˆ°Unity...', 'info');
            
            try {
                const swarmData = {
                    sessionId: 'web_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    timestamp: new Date().toISOString(),
                    populations: populations.map(pop => ({
                        count: pop.count,
                        parameters: pop.parameters
                    })),
                    totalIndividuals: populations.reduce((sum, pop) => sum + pop.count, 0),
                    userAgent: navigator.userAgent,
                    source: 'SwarmChemistry Web Cloud'
                };
                
                console.log('ğŸ“¤ å‘é€æ•°æ®åˆ°æœåŠ¡å™¨:', swarmData);
                
                const response = await fetch(SYNC_CONFIG.serverUrl + '/swarm-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(swarmData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSyncStatus(`âœ… åŒæ­¥æˆåŠŸï¼æ•°æ®ID: ${result.dataId}`, 'success');
                    console.log('âœ… åŒæ­¥æˆåŠŸ:', result);
                } else {
                    throw new Error(result.message || 'åŒæ­¥å¤±è´¥');
                }
                
            } catch (error) {
                console.error('âŒ åŒæ­¥å¤±è´¥:', error);
                showSyncStatus(`âŒ åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
        function showSyncStatus(message, type) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.textContent = message;
            statusDiv.className = `sync-status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        console.log('ğŸŒ SwarmChemistry äº‘ç«¯ç‰ˆåŠ è½½å®Œæˆ');
        console.log('ğŸ”— APIç«¯ç‚¹:', SYNC_CONFIG.serverUrl);
    </script>
</body>
</html> 