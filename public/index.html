<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾¤ä½“åŒ–å­¦ - SwarmChemistry äº‘ç«¯ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            overflow-x: auto;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            align-items: start;
        }
        
        .canvas-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .controls-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            height: fit-content;
            max-height: 1200px;
            overflow-y: auto;
        }
        
        canvas {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: #000;
            display: block;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .canvas-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .control-group h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
        
        button:hover {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .population-display {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 10px;
            white-space: pre-line;
            border: 1px solid rgba(255,255,255,0.1);
            line-height: 1.4;
        }
        
        /* ç½‘ç»œåŒæ­¥æ ·å¼ */
        .sync-button {
            background: linear-gradient(145deg, #4CAF50, #45a049) !important;
            border-color: #4CAF50 !important;
            font-weight: bold;
            font-size: 16px;
            padding: 12px 24px;
        }
        
        .sync-button:hover {
            background: linear-gradient(145deg, #5CBF60, #4CAF50) !important;
        }
        
        .sync-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }
        
        .sync-status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #4CAF50;
        }
        
        .sync-status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            color: #f44336;
        }
        
        .sync-status.info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
            color: #2196F3;
        }
        
        /* å‚æ•°è¾“å…¥æ ·å¼ */
        .parameter-input {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.4;
            resize: vertical;
            backdrop-filter: blur(10px);
        }
        
        .parameter-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .parameter-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }
        
        .parameter-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .parse-status {
            margin-top: 10px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }
        
        .parse-status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #4CAF50;
        }
        
        .parse-status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            color: #f44336;
        }
        
        .parse-status.info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
            color: #2196F3;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1600px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .controls-section {
                max-height: none;
            }
            
            canvas {
                max-width: 100%;
                height: auto;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .preset-buttons {
                grid-template-columns: 1fr;
            }
            
            canvas {
                max-width: 100%;
                height: auto;
            }
        }
        
        .parse-status.info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
            color: #2196F3;
        }
        
        /* å‚æ•°è°ƒè¯•å™¨æ ·å¼ */
        .parameter-debugger {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .population-selector {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .population-selector label {
            font-weight: 500;
            color: #fff;
        }
        
        .population-selector select {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: #333;
            padding: 8px 12px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }
        
        .population-selector select option {
            background: #fff;
            color: #333;
        }
        
        .population-selector select:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
        }
        
        .population-info {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .parameter-sliders {
            display: grid;
            gap: 15px;
        }
        
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .slider-group label {
            font-size: 13px;
            font-weight: 500;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .slider-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(145deg, #4CAF50, #45a049);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .slider-group input[type="range"]::-webkit-slider-thumb:hover {
            background: linear-gradient(145deg, #5CBF60, #4CAF50);
            transform: scale(1.1);
        }
        
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(145deg, #4CAF50, #45a049);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .slider-value {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            color: #4CAF50;
            font-weight: bold;
            min-width: 60px;
            text-align: right;
        }
        
        .debugger-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .debugger-controls button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ ç¾¤ä½“åŒ–å­¦ - SwarmChemistry</h1>
            <p>ğŸŒ äº‘ç«¯ç‰ˆ - åˆ›ä½œç²’å­è¡Œä¸ºï¼ŒåŒæ­¥åˆ°Unityä½“éªŒ</p>
        </div>
        
        <div class="main-layout">
            <div class="canvas-section">
                <canvas id="swarmCanvas" width="1200" height="900"></canvas>
                <div class="canvas-controls">
                    <button onclick="startSimulation()">â–¶ï¸ å¼€å§‹</button>
                    <button onclick="pauseSimulation()">â¸ï¸ æš‚åœ</button>
                    <button onclick="clearCanvas()">ğŸ—‘ï¸ æ¸…ç©º</button>
                    <button onclick="resetView()">ğŸ”„ é‡ç½®è§†å›¾</button>
                </div>
            </div>
            
            <div class="controls-section">
                <div class="control-group">
                    <h3>ğŸš€ åŒæ­¥åˆ°Unity</h3>
                    <button class="sync-button" onclick="syncToUnity()">ğŸš€ åŒæ­¥åˆ°Unity</button>
                    <div id="syncStatus" class="sync-status" style="display: none;"></div>
                </div>
                
                <div class="control-group">
                    <h3>ğŸ“ è‡ªå®šä¹‰å‚æ•°</h3>
                    <textarea id="parameterInput" class="parameter-input" placeholder="è¾“å…¥å‚æ•°æ ¼å¼ï¼Œä¾‹å¦‚ï¼š
48 * (150.39, 15.89, 23.54, 0.74, 0.45, 62.65, 0.33, 0.13)
152 * (217.14, 12.13, 12.42, 0.59, 0.98, 14.06, 0.04, 0.65)
14 * (248.54, 5.85, 22.26, 0.43, 0.11, 17.14, 0.06, 0.68)
31 * (141.53, 2.91, 4.86, 0.92, 0.03, 21.87, 0.28, 0.2)"></textarea>
                    <div class="parameter-controls">
                        <button onclick="parseCustomParameters()">ğŸ” è§£æå‚æ•°</button>
                        <button onclick="clearParameters()">ğŸ—‘ï¸ æ¸…ç©ºè¾“å…¥</button>
                    </div>
                    <div id="parseStatus" class="parse-status" style="display: none;"></div>
                </div>
                
                <div class="control-group">
                    <h3>ğŸ›ï¸ å‚æ•°è°ƒè¯•å™¨</h3>
                    <div class="parameter-debugger">
                        <div class="population-selector">
                            <label for="populationSelect">é€‰æ‹©ç§ç¾¤:</label>
                            <select id="populationSelect" onchange="selectPopulation()">
                                <option value="">è¯·é€‰æ‹©ç§ç¾¤...</option>
                            </select>
                            <span id="populationInfo" class="population-info"></span>
                        </div>
                        
                        <div id="parameterSliders" class="parameter-sliders" style="display: none;">
                            <div class="slider-group">
                                <label>é‚»åŸŸåŠå¾„ (Neighborhood Radius):</label>
                                <input type="range" id="slider_neighborhoodRadius" min="10" max="400" step="0.1" oninput="updateParameter('neighborhoodRadius', this.value)">
                                <span id="value_neighborhoodRadius" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>æ­£å¸¸é€Ÿåº¦ (Normal Speed):</label>
                                <input type="range" id="slider_normalSpeed" min="0" max="25" step="0.01" oninput="updateParameter('normalSpeed', this.value)">
                                <span id="value_normalSpeed" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>æœ€å¤§é€Ÿåº¦ (Max Speed):</label>
                                <input type="range" id="slider_maxSpeed" min="0" max="50" step="0.01" oninput="updateParameter('maxSpeed', this.value)">
                                <span id="value_maxSpeed" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>èšé›†åŠ› C1 (Cohesion):</label>
                                <input type="range" id="slider_c1" min="0" max="1" step="0.01" oninput="updateParameter('c1', this.value)">
                                <span id="value_c1" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>å¯¹é½åŠ› C2 (Alignment):</label>
                                <input type="range" id="slider_c2" min="0" max="1" step="0.01" oninput="updateParameter('c2', this.value)">
                                <span id="value_c2" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>åˆ†ç¦»åŠ› C3 (Separation):</label>
                                <input type="range" id="slider_c3" min="0" max="100" step="0.01" oninput="updateParameter('c3', this.value)">
                                <span id="value_c3" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>éšæœºæ€§ C4 (Randomness):</label>
                                <input type="range" id="slider_c4" min="0" max="1" step="0.01" oninput="updateParameter('c4', this.value)">
                                <span id="value_c4" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>é€Ÿåº¦è°ƒèŠ‚ C5 (Speed Control):</label>
                                <input type="range" id="slider_c5" min="0" max="1" step="0.01" oninput="updateParameter('c5', this.value)">
                                <span id="value_c5" class="slider-value">0</span>
                            </div>
                            
                            <div class="debugger-controls">
                                <button onclick="resetSelectedPopulation()">ğŸ”„ é‡ç½®å‚æ•°</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>ğŸŒŠ ç»å…¸SwarmChemistryé¢„è®¾ (ç¬¬ä¸€ç»„)</h3>
                    <div class="preset-buttons">
                        <button onclick="loadPreset('uzushio')">ğŸŒ€ Uzushio</button>
                        <button onclick="loadPreset('insurmountable_wall')">ğŸ§± Insurmountable Wall</button>
                        <button onclick="loadPreset('cell_with_two_nuclei')">ğŸ”¬ Cell with Two Nuclei</button>
                        <button onclick="loadPreset('multicellularity')">ğŸ§¬ Multicellularity</button>
                        <button onclick="loadPreset('jelly_fish')">ğŸ Jelly Fish</button>
                        <button onclick="loadPreset('no_wait_this_way')">â†©ï¸ No, Wait - This Way</button>
                        <button onclick="loadPreset('recombining_blobs')">ğŸ«§ Recombining Blobs</button>
                        <button onclick="loadPreset('playing_catch')">âš¾ Playing Catch</button>
                        <button onclick="loadPreset('pulsating_eye')">ğŸ‘ï¸ Pulsating Eye</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>ğŸ”¬ ç»å…¸SwarmChemistryé¢„è®¾ (ç¬¬äºŒç»„)</h3>
                    <div class="preset-buttons">
                        <button onclick="loadPreset('chaos_cells')">ğŸŒªï¸ Chaos Cells</button>
                        <button onclick="loadPreset('aggressive_predator')">ğŸ¦ˆ Aggressive Predator</button>
                        <button onclick="loadPreset('fast_walker_slow_follower')">ğŸš¶â€â™‚ï¸ Fast Walker & Slow Follower</button>
                        <button onclick="loadPreset('swinger')">ğŸ­ Swinger</button>
                        <button onclick="loadPreset('rotary')">âš™ï¸ Rotary</button>
                        <button onclick="loadPreset('wedding_ring')">ğŸ’ Wedding Ring</button>
                        <button onclick="loadPreset('turbulent_runner')">ğŸƒâ€â™‚ï¸ Turbulent Runner</button>
                        <button onclick="loadPreset('blobs')">ğŸŸ¢ Blobs</button>
                        <button onclick="loadPreset('linear_oscillator')">ğŸ“Š Linear Oscillator</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>ğŸ“Š å½“å‰ç§ç¾¤</h3>
                    <div id="populationDisplay" class="population-display">
                        ç‚¹å‡»é¢„è®¾æŒ‰é’®æ¥ç”Ÿæˆç²’å­ç§ç¾¤...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // SwarmChemistry äº‘ç«¯ç‰ˆ - ä¸åŸå§‹Javaç‰ˆæœ¬å®Œå…¨ä¸€è‡´çš„ç®—æ³•å®ç°
        
        // å…¨å±€å˜é‡
        let canvas, ctx;
        let individuals = [];
        let animationId;
        let isRunning = false;
        let mouseX = -1, mouseY = -1;
        let mouseInfluence = false;
        
        // åŒæ­¥é…ç½® - ä½¿ç”¨å½“å‰åŸŸå
        const SYNC_CONFIG = {
            serverUrl: window.location.origin + '/api',
            enabled: true
        };
        
        // SwarmParametersç±» - ä¸åŸå§‹ç‰ˆæœ¬å®Œå…¨ä¸€è‡´
        class SwarmParameters {
            constructor(neighborhoodRadius = 50, normalSpeed = 2, maxSpeed = 5, 
                        c1 = 0.5, c2 = 0.5, c3 = 10, c4 = 0.1, c5 = 0.5) {
                this.neighborhoodRadius = neighborhoodRadius;
                this.normalSpeed = normalSpeed;
                this.maxSpeed = maxSpeed;
                this.c1 = c1; // èšé›†åŠ›
                this.c2 = c2; // å¯¹é½åŠ›
                this.c3 = c3; // åˆ†ç¦»åŠ›
                this.c4 = c4; // éšæœºæ€§
                this.c5 = c5; // é€Ÿåº¦è°ƒèŠ‚
            }
            
            // æ ¹æ®Javaç‰ˆæœ¬çš„é¢œè‰²è®¡ç®—è§„åˆ™
            getColor() {
                const r = Math.floor((this.c1 / 1.0) * 0.8 * 255);
                const g = Math.floor((this.c2 / 1.0) * 0.8 * 255);
                const b = Math.floor((this.c3 / 100.0) * 0.8 * 255);
                return `rgb(${r}, ${g}, ${b})`;
            }
            
            clone() {
                return new SwarmParameters(
                    this.neighborhoodRadius, this.normalSpeed, this.maxSpeed,
                    this.c1, this.c2, this.c3, this.c4, this.c5
                );
            }
            
            toString() {
                return `(${this.neighborhoodRadius.toFixed(2)}, ${this.normalSpeed.toFixed(2)}, ${this.maxSpeed.toFixed(2)}, ${this.c1.toFixed(2)}, ${this.c2.toFixed(2)}, ${this.c3.toFixed(2)}, ${this.c4.toFixed(2)}, ${this.c5.toFixed(2)})`;
            }
        }
        
        // SwarmIndividualç±» - ä¸åŸå§‹ç‰ˆæœ¬å®Œå…¨ä¸€è‡´
        class SwarmIndividual {
            constructor(x, y, dx = 0, dy = 0, parameters) {
                this.x = x;
                this.y = y;
                this.dx = dx;
                this.dy = dy;
                this.dx2 = dx; // ç”¨äºé€Ÿåº¦è°ƒèŠ‚çš„ä¸´æ—¶å˜é‡
                this.dy2 = dy;
                this.parameters = parameters;
            }
            
            // åŠ é€Ÿåº¦è®¡ç®—
            accelerate(ax, ay, maxSpeed) {
                this.dx2 += ax;
                this.dy2 += ay;
                
                // é™åˆ¶æœ€å¤§é€Ÿåº¦
                const speed = Math.sqrt(this.dx2 * this.dx2 + this.dy2 * this.dy2);
                if (speed > maxSpeed) {
                    this.dx2 = (this.dx2 / speed) * maxSpeed;
                    this.dy2 = (this.dy2 / speed) * maxSpeed;
                }
            }
            
            // ç§»åŠ¨
            move() {
                this.dx = this.dx2;
                this.dy = this.dy2;
                
                this.x += this.dx;
                this.y += this.dy;
            }
            
            // è¾¹ç•Œå¤„ç†
            wrapAround(width, height) {
                if (this.x < 0) this.x = width;
                if (this.x > width) this.x = 0;
                if (this.y < 0) this.y = height;
                if (this.y > height) this.y = 0;
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('swarmCanvas');
            ctx = canvas.getContext('2d');
            
            // è®¾ç½®é«˜DPIæ”¯æŒ
            const dpr = window.devicePixelRatio || 1;
            const displayWidth = 1200;
            const displayHeight = 900;
            
            canvas.width = displayWidth * dpr;
            canvas.height = displayHeight * dpr;
            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';
            ctx.scale(dpr, dpr);
            
            setupEventListeners();
            initializeSwarm();
            animate();
            
            console.log('ğŸ® SwarmChemistry äº‘ç«¯ç‰ˆåˆå§‹åŒ–å®Œæˆ');
            console.log('ğŸ–¼ï¸ ç”»å¸ƒå°ºå¯¸: 1200x900');
            console.log('ğŸŒ æœåŠ¡å™¨åœ°å€:', SYNC_CONFIG.serverUrl);
        });
        
        // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
        function setupEventListeners() {
            // é¼ æ ‡äº‹ä»¶
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
            });
            
            canvas.addEventListener('mouseenter', () => {
                mouseInfluence = true;
            });
            
            canvas.addEventListener('mouseleave', () => {
                mouseInfluence = false;
            });
            
            // é”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', (e) => {
                if (e.key === ' ') {
                    e.preventDefault();
                    togglePlayPause();
                }
            });
        }
        
        // ç§ç¾¤åˆå§‹åŒ– - ä¸åŸå§‹ç‰ˆæœ¬å®Œå…¨ä¸€è‡´
        function initializeSwarm() {
            individuals = [];
            
            // åˆ›å»ºå¤šä¸ªä¸åŒå‚æ•°çš„ç§ç¾¤ - ä½¿ç”¨åŸå§‹é»˜è®¤å‚æ•°
            const populations = [
                { count: 49, params: new SwarmParameters(184.07, 12.64, 38.49, 0.67, 0.31, 63.78, 0.11, 0.21) },
                { count: 67, params: new SwarmParameters(177.92, 15.66, 11.05, 0.85, 0.41, 51.77, 0.09, 0.86) },
                { count: 58, params: new SwarmParameters(177.92, 15.66, 11.05, 0.85, 0.41, 51.77, 0.03, 0.86) },
                { count: 10, params: new SwarmParameters(298.48, 0.65, 19.27, 0.84, 0.11, 83.18, 0.24, 0.5) },
                { count: 37, params: new SwarmParameters(81.6, 18.34, 27.3, 0.94, 0.17, 3.41, 0.2, 0.9) },
                { count: 1, params: new SwarmParameters(274.4, 3.33, 7.42, 0.9, 0.19, 7.37, 0.43, 0.17) },
                { count: 12, params: new SwarmParameters(203.64, 3.33, 7.42, 0.9, 0.19, 7.37, 0.43, 0.17) }
            ];
            
            // è®¡ç®—ç”»å¸ƒä¸­å¿ƒç‚¹ - é€‚åº”æ–°å°ºå¯¸
            const centerX = 1200 / 2;
            const centerY = 900 / 2;
            const spawnRadius = 80; // ç¨å¾®å¢å¤§ç”ŸæˆåŠå¾„
            
            populations.forEach(pop => {
                for (let i = 0; i < pop.count; i++) {
                    // åœ¨åœ†å½¢åŒºåŸŸå†…éšæœºç”Ÿæˆä½ç½®
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * spawnRadius;
                    
                    const x = centerX + Math.cos(angle) * radius;
                    const y = centerY + Math.sin(angle) * radius;
                    
                    const individual = new SwarmIndividual(
                        x, y,
                        (Math.random() - 0.5) * 2, // åˆå§‹é€Ÿåº¦
                        (Math.random() - 0.5) * 2,
                        pop.params.clone()
                    );
                    individuals.push(individual);
                }
            });
            
            updatePopulationDisplay();
        }
        
        // æ ¸å¿ƒç¾¤ä½“è¡Œä¸ºç®—æ³• - ä¸Javaç‰ˆæœ¬å®Œå…¨ä¸€è‡´
        function simulateSwarmBehavior() {
            const mouseAgent = mouseInfluence ? {
                x: mouseX,
                y: mouseY,
                dx: 0,
                dy: 0
            } : null;
            
            individuals.forEach(individual => {
                const neighbors = findNeighbors(individual, mouseAgent);
                const params = individual.parameters;
                
                let ax = 0, ay = 0;
                
                if (neighbors.length === 0) {
                    // æ— é‚»å±…æ—¶éšæœºç§»åŠ¨ - ä¸Javaç‰ˆæœ¬ä¸€è‡´
                    ax = Math.random() - 0.5;
                    ay = Math.random() - 0.5;
                } else {
                    // è®¡ç®—é‚»å±…ä¸­å¿ƒå’Œå¹³å‡é€Ÿåº¦
                    let centerX = 0, centerY = 0;
                    let avgDx = 0, avgDy = 0;
                    
                    neighbors.forEach(neighbor => {
                        centerX += neighbor.x;
                        centerY += neighbor.y;
                        avgDx += neighbor.dx || 0;
                        avgDy += neighbor.dy || 0;
                    });
                    
                    centerX /= neighbors.length;
                    centerY /= neighbors.length;
                    avgDx /= neighbors.length;
                    avgDy /= neighbors.length;
                    
                    // c1: èšé›†è¡Œä¸º - ä¸Javaç‰ˆæœ¬å®Œå…¨ä¸€è‡´
                    ax += (centerX - individual.x) * params.c1;
                    ay += (centerY - individual.y) * params.c1;
                    
                    // c2: å¯¹é½è¡Œä¸º - ä¸Javaç‰ˆæœ¬å®Œå…¨ä¸€è‡´
                    ax += (avgDx - individual.dx) * params.c2;
                    ay += (avgDy - individual.dy) * params.c2;
                    
                    // c3: åˆ†ç¦»è¡Œä¸º - ä¸Javaç‰ˆæœ¬å®Œå…¨ä¸€è‡´
                    neighbors.forEach(neighbor => {
                        const dx = individual.x - neighbor.x;
                        const dy = individual.y - neighbor.y;
                        let distSq = dx * dx + dy * dy;
                        
                        if (distSq === 0) distSq = 0.001; // ä¸Javaç‰ˆæœ¬ä¸€è‡´çš„å¤„ç†
                        ax += (dx / distSq) * params.c3;
                        ay += (dy / distSq) * params.c3;
                    });
                    
                    // c4: éšæœºæ€§ - ä¸Javaç‰ˆæœ¬å®Œå…¨ä¸€è‡´
                    if (Math.random() < params.c4) {
                        ax += Math.random() * 10 - 5;
                        ay += Math.random() * 10 - 5;
                    }
                }
                
                // ä½¿ç”¨åŸå§‹æœ€å¤§é€Ÿåº¦å‚æ•°
                individual.accelerate(ax, ay, params.maxSpeed);
                
                // c5: é€Ÿåº¦è°ƒèŠ‚ - ä¸Javaç‰ˆæœ¬å®Œå…¨ä¸€è‡´
                const currentSpeed = Math.sqrt(individual.dx2 * individual.dx2 + individual.dy2 * individual.dy2);
                if (currentSpeed === 0) {
                    // é¿å…é™¤é›¶é”™è¯¯
                    individual.accelerate(0, 0, params.maxSpeed);
                } else {
                    const speedDiff = params.normalSpeed - currentSpeed;
                    individual.accelerate(
                        (individual.dx2 / currentSpeed) * speedDiff * params.c5,
                        (individual.dy2 / currentSpeed) * speedDiff * params.c5,
                        params.maxSpeed
                    );
                }
            });
        }
        
        // æŸ¥æ‰¾é‚»å±… - ä¸Javaç‰ˆæœ¬å®Œå…¨ä¸€è‡´
        function findNeighbors(individual, mouseAgent = null) {
            const neighbors = [];
            const radiusSq = individual.parameters.neighborhoodRadius * individual.parameters.neighborhoodRadius;
            
            // æŸ¥æ‰¾å…¶ä»–ä¸ªä½“é‚»å±…
            individuals.forEach(other => {
                if (other !== individual) {
                    const dx = individual.x - other.x;
                    const dy = individual.y - other.y;
                    const distSq = dx * dx + dy * dy;
                    
                    if (distSq < radiusSq) {
                        neighbors.push(other);
                    }
                }
            });
            
            // é¼ æ ‡å½±å“ - ä¸Javaç‰ˆæœ¬ä¸€è‡´çš„æƒé‡
            if (mouseAgent) {
                const dx = individual.x - mouseAgent.x;
                const dy = individual.y - mouseAgent.y;
                const distSq = dx * dx + dy * dy;
                
                if (distSq < radiusSq) {
                    // Javaç‰ˆæœ¬ä½¿ç”¨weightOfMouseCursor = 20
                    for (let i = 0; i < 20; i++) {
                        neighbors.push(mouseAgent);
                    }
                }
            }
            
            return neighbors;
        }
        
        // æ›´æ–°
        function update() {
            if (!isRunning) return;
            
            simulateSwarmBehavior();
            
            individuals.forEach(individual => {
                individual.move();
                individual.wrapAround(1200, 900); // ä½¿ç”¨å›ºå®šç”»å¸ƒå°ºå¯¸
            });
        }
        
        // æ¸²æŸ“
        function render() {
            // å®Œå…¨æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, 1200, 900); // ä½¿ç”¨å›ºå®šç”»å¸ƒå°ºå¯¸
            
            // ç»˜åˆ¶ä¸ªä½“
            individuals.forEach(individual => {
                const color = individual.parameters.getColor();
                
                // ç»˜åˆ¶ä¸ªä½“
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(individual.x, individual.y, 3, 0, Math.PI * 2);
                ctx.fill();
                
                // ç»˜åˆ¶æ–¹å‘æŒ‡ç¤º
                const speed = Math.sqrt(individual.dx * individual.dx + individual.dy * individual.dy);
                if (speed > 0.05) {
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(individual.x, individual.y);
                    ctx.lineTo(
                        individual.x + (individual.dx / speed) * 6,
                        individual.y + (individual.dy / speed) * 6
                    );
                    ctx.stroke();
                }
            });
            
            // ç»˜åˆ¶é¼ æ ‡å½±å“èŒƒå›´
            if (mouseInfluence && mouseX >= 0) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(mouseX, mouseY, 50, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
        
        // åŠ¨ç”»å¾ªç¯
        function animate() {
            update();
            render();
            requestAnimationFrame(animate);
        }
        
        // å‚æ•°è°ƒè¯•å™¨ç›¸å…³å˜é‡
        let currentPopulations = [];
        let selectedPopulationIndex = -1;
        let originalParameters = null;
        
        // ç»Ÿè®¡å’Œæ˜¾ç¤ºç§ç¾¤ä¿¡æ¯
        function updatePopulationDisplay() {
            const populationStats = new Map();
            
            individuals.forEach(individual => {
                const paramStr = individual.parameters.toString();
                if (populationStats.has(paramStr)) {
                    populationStats.set(paramStr, populationStats.get(paramStr) + 1);
                } else {
                    populationStats.set(paramStr, 1);
                }
            });
            
            let displayText = `æ€»ç§ç¾¤æ•°: ${populationStats.size}\n`;
            displayText += `æ€»ç²’å­æ•°: ${individuals.length}\n\n`;
            
            // æ„å»ºå‚æ•°è¾“å…¥æ çš„åŒæ­¥æ–‡æœ¬
            let parameterText = '';
            
            // æ›´æ–°ç§ç¾¤åˆ—è¡¨ç”¨äºè°ƒè¯•å™¨
            currentPopulations = [];
            
            let index = 1;
            populationStats.forEach((count, params) => {
                displayText += `ç§ç¾¤ ${index}: ${count} * ${params}\n`;
                parameterText += `${count} * ${params}\n`;
                
                // è§£æå‚æ•°ç”¨äºè°ƒè¯•å™¨
                const match = params.match(/\(([^)]+)\)/);
                if (match) {
                    const paramValues = match[1].split(',').map(p => parseFloat(p.trim()));
                    currentPopulations.push({
                        index: index,
                        count: count,
                        parameters: {
                            neighborhoodRadius: paramValues[0],
                            normalSpeed: paramValues[1],
                            maxSpeed: paramValues[2],
                            c1: paramValues[3],
                            c2: paramValues[4],
                            c3: paramValues[5],
                            c4: paramValues[6],
                            c5: paramValues[7]
                        }
                    });
                }
                index++;
            });
            
            document.getElementById('populationDisplay').textContent = displayText;
            
            // å®æ—¶åŒæ­¥åˆ°å‚æ•°è¾“å…¥æ 
            const parameterInput = document.getElementById('parameterInput');
            if (parameterInput && individuals.length > 0) {
                parameterInput.value = parameterText.trim();
                
                // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
                showParseStatus(`âœ… å·²åŒæ­¥å½“å‰ç”»å¸ƒç§ç¾¤å‚æ•° (${individuals.length}ä¸ªç²’å­)`, 'success');
                setTimeout(() => {
                    const statusDiv = document.getElementById('parseStatus');
                    if (statusDiv) statusDiv.style.display = 'none';
                }, 3000);
            }
            
            // æ›´æ–°è°ƒè¯•å™¨çš„ç§ç¾¤é€‰æ‹©å™¨
            updatePopulationSelector();
        }
        
        // æ›´æ–°ç§ç¾¤é€‰æ‹©å™¨
        function updatePopulationSelector() {
            const selector = document.getElementById('populationSelect');
            if (!selector) return;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            selector.innerHTML = '<option value="">è¯·é€‰æ‹©ç§ç¾¤...</option>';
            
            // æ·»åŠ ç§ç¾¤é€‰é¡¹
            currentPopulations.forEach((pop, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `ç§ç¾¤ ${pop.index} (${pop.count} ä¸ªç²’å­)`;
                selector.appendChild(option);
            });
            
            // å¦‚æœä¹‹å‰æœ‰é€‰ä¸­çš„ç§ç¾¤ï¼Œå°è¯•ä¿æŒé€‰ä¸­çŠ¶æ€
            if (selectedPopulationIndex >= 0 && selectedPopulationIndex < currentPopulations.length) {
                selector.value = selectedPopulationIndex;
            } else {
                selectedPopulationIndex = -1;
                document.getElementById('parameterSliders').style.display = 'none';
            }
        }
        
        // é€‰æ‹©ç§ç¾¤
        function selectPopulation() {
            const selector = document.getElementById('populationSelect');
            const index = parseInt(selector.value);
            
            if (isNaN(index) || index < 0 || index >= currentPopulations.length) {
                selectedPopulationIndex = -1;
                document.getElementById('parameterSliders').style.display = 'none';
                document.getElementById('populationInfo').textContent = '';
                return;
            }
            
            selectedPopulationIndex = index;
            const population = currentPopulations[index];
            originalParameters = { ...population.parameters };
            
            // æ˜¾ç¤ºç§ç¾¤ä¿¡æ¯
            document.getElementById('populationInfo').textContent = 
                `${population.count} ä¸ªç²’å­`;
            
            // æ›´æ–°æ»‘å—å€¼
            updateSliders(population.parameters);
            
            // æ˜¾ç¤ºæ»‘å—åŒºåŸŸ
            document.getElementById('parameterSliders').style.display = 'block';
        }
        
        // æ›´æ–°æ»‘å—æ˜¾ç¤º
        function updateSliders(params) {
            const paramNames = ['neighborhoodRadius', 'normalSpeed', 'maxSpeed', 'c1', 'c2', 'c3', 'c4', 'c5'];
            
            paramNames.forEach(name => {
                const slider = document.getElementById(`slider_${name}`);
                const valueSpan = document.getElementById(`value_${name}`);
                
                if (slider && valueSpan) {
                    slider.value = params[name];
                    valueSpan.textContent = params[name].toFixed(2);
                }
            });
        }
        
        // æ›´æ–°å•ä¸ªå‚æ•°
        function updateParameter(paramName, value) {
            if (selectedPopulationIndex < 0) return;
            
            const numValue = parseFloat(value);
            const valueSpan = document.getElementById(`value_${paramName}`);
            if (valueSpan) {
                valueSpan.textContent = numValue.toFixed(2);
            }
            
            // æ›´æ–°å½“å‰ç§ç¾¤å‚æ•°
            currentPopulations[selectedPopulationIndex].parameters[paramName] = numValue;
            
            // å®æ—¶åº”ç”¨åˆ°ä¸ªä½“
            applyParameterChanges();
        }
        
        // åº”ç”¨å‚æ•°æ›´æ”¹
        function applyParameterChanges() {
            if (selectedPopulationIndex < 0) return;
            
            const targetParams = currentPopulations[selectedPopulationIndex].parameters;
            const targetParamStr = `(${targetParams.neighborhoodRadius.toFixed(2)}, ${targetParams.normalSpeed.toFixed(2)}, ${targetParams.maxSpeed.toFixed(2)}, ${targetParams.c1.toFixed(2)}, ${targetParams.c2.toFixed(2)}, ${targetParams.c3.toFixed(2)}, ${targetParams.c4.toFixed(2)}, ${targetParams.c5.toFixed(2)})`;
            
            // æ‰¾åˆ°å¯¹åº”çš„ä¸ªä½“å¹¶æ›´æ–°å‚æ•°
            individuals.forEach(individual => {
                const currentParamStr = individual.parameters.toString();
                
                // æ£€æŸ¥æ˜¯å¦å±äºå½“å‰é€‰ä¸­çš„ç§ç¾¤
                let isTargetPopulation = false;
                currentPopulations.forEach((pop, index) => {
                    if (index === selectedPopulationIndex) {
                        const popParamStr = `(${pop.parameters.neighborhoodRadius.toFixed(2)}, ${pop.parameters.normalSpeed.toFixed(2)}, ${pop.parameters.maxSpeed.toFixed(2)}, ${pop.parameters.c1.toFixed(2)}, ${pop.parameters.c2.toFixed(2)}, ${pop.parameters.c3.toFixed(2)}, ${pop.parameters.c4.toFixed(2)}, ${pop.parameters.c5.toFixed(2)})`;
                        
                        // ä½¿ç”¨åŸå§‹å‚æ•°è¿›è¡ŒåŒ¹é…
                        if (originalParameters) {
                            const originalParamStr = `(${originalParameters.neighborhoodRadius.toFixed(2)}, ${originalParameters.normalSpeed.toFixed(2)}, ${originalParameters.maxSpeed.toFixed(2)}, ${originalParameters.c1.toFixed(2)}, ${originalParameters.c2.toFixed(2)}, ${originalParameters.c3.toFixed(2)}, ${originalParameters.c4.toFixed(2)}, ${originalParameters.c5.toFixed(2)})`;
                            if (currentParamStr === originalParamStr) {
                                isTargetPopulation = true;
                            }
                        }
                    }
                });
                
                if (isTargetPopulation) {
                    // æ›´æ–°ä¸ªä½“å‚æ•°
                    individual.parameters.neighborhoodRadius = targetParams.neighborhoodRadius;
                    individual.parameters.normalSpeed = targetParams.normalSpeed;
                    individual.parameters.maxSpeed = targetParams.maxSpeed;
                    individual.parameters.c1 = targetParams.c1;
                    individual.parameters.c2 = targetParams.c2;
                    individual.parameters.c3 = targetParams.c3;
                    individual.parameters.c4 = targetParams.c4;
                    individual.parameters.c5 = targetParams.c5;
                }
            });
            
            // æ›´æ–°æ˜¾ç¤º
            updatePopulationDisplay();
        }
        
        // é‡ç½®é€‰ä¸­ç§ç¾¤å‚æ•°
        function resetSelectedPopulation() {
            if (selectedPopulationIndex < 0 || !originalParameters) return;
            
            // æ¢å¤åŸå§‹å‚æ•°
            currentPopulations[selectedPopulationIndex].parameters = { ...originalParameters };
            
            // æ›´æ–°æ»‘å—æ˜¾ç¤º
            updateSliders(originalParameters);
            
            // åº”ç”¨æ›´æ”¹
            applyParameterChanges();
        }
        
        // é¢„è®¾é…ç½® - ç»å…¸SwarmChemistryé¢„è®¾
        const presets = {
            uzushio: [
                { count: 49, params: [184.07, 12.64, 38.49, 0.67, 0.31, 63.78, 0.11, 0.21] },
                { count: 67, params: [177.92, 15.66, 11.05, 0.85, 0.41, 51.77, 0.09, 0.86] },
                { count: 58, params: [177.92, 15.66, 11.05, 0.85, 0.41, 51.77, 0.03, 0.86] },
                { count: 10, params: [298.48, 0.65, 19.27, 0.84, 0.11, 83.18, 0.24, 0.5] },
                { count: 37, params: [81.6, 18.34, 27.3, 0.94, 0.17, 3.41, 0.2, 0.9] },
                { count: 1, params: [274.4, 3.33, 7.42, 0.9, 0.19, 7.37, 0.43, 0.17] },
                { count: 12, params: [203.64, 3.33, 7.42, 0.9, 0.19, 7.37, 0.43, 0.17] }
            ],
            insurmountable_wall: [
                { count: 42, params: [52.57, 9.91, 20.42, 0.32, 0.76, 1.8, 0.01, 0.64] },
                { count: 25, params: [84.87, 8.82, 24.98, 0.91, 0.44, 40.97, 0.18, 0.6] },
                { count: 45, params: [220.42, 4.65, 7.53, 0.96, 0.35, 46.18, 0.25, 1.0] },
                { count: 49, params: [279.64, 10.29, 35.95, 0.37, 0.49, 38.09, 0.32, 0.89] }
            ],
            cell_with_two_nuclei: [
                { count: 41, params: [249.84, 4.85, 28.73, 0.34, 0.45, 14.44, 0.09, 0.82] },
                { count: 26, params: [277.87, 15.02, 35.48, 0.68, 0.05, 82.96, 0.46, 0.9] },
                { count: 30, params: [277.87, 15.02, 24.44, 0.68, 0.05, 82.96, 0.43, 0.9] },
                { count: 28, params: [110.8, 16.12, 38.6, 0.18, 0.34, 14.3, 0.01, 0.01] },
                { count: 48, params: [83.79, 13.29, 7.54, 0.08, 0.79, 1.07, 0.15, 0.45] },
                { count: 74, params: [269.64, 6.62, 34.69, 0.36, 0.5, 30.2, 0.03, 0.23] }
            ],
            multicellularity: [
                { count: 99, params: [19.8, 15.73, 2.61, 0.85, 0.64, 10.51, 0.17, 0.06] },
                { count: 48, params: [300.0, 14.63, 0.0, 0.48, 0.81, 90.27, 0.25, 0.78] },
                { count: 37, params: [275.18, 16.9, 7.05, 0.48, 0.81, 90.27, 0.17, 0.85] },
                { count: 8, params: [159.59, 2.09, 24.19, 0.96, 0.59, 76.03, 0.01, 0.07] },
                { count: 42, params: [73.07, 1.82, 2.36, 0.27, 0.61, 40.55, 0.22, 0.86] }
            ],
            jelly_fish: [
                { count: 134, params: [262.65, 12.01, 25.87, 0.97, 1.0, 56.35, 0.26, 0.61] },
                { count: 67, params: [288.17, 6.19, 23.37, 0.95, 1.0, 1.31, 0.1, 0.9] },
                { count: 68, params: [150.5, 12.97, 15.87, 0.46, 0.39, 57.95, 0.17, 0.48] }
            ],
            no_wait_this_way: [
                { count: 60, params: [262.68, 2.82, 38.32, 0.21, 0.01, 54.93, 0.11, 0.19] },
                { count: 40, params: [78.58, 5.7, 33.23, 0.89, 0.18, 45.44, 0.04, 0.05] },
                { count: 40, params: [257.27, 14.96, 35.66, 0.2, 0.8, 47.81, 0.13, 0.13] }
            ],
            recombining_blobs: [
                { count: 132, params: [45.91, 10.82, 21.11, 0.86, 0.13, 42.48, 0.32, 0.74] },
                { count: 84, params: [113.26, 3.41, 25.71, 0.4, 0.39, 49.53, 0.13, 0.24] }
            ],
            playing_catch: [
                { count: 76, params: [84.06, 0.09, 9.89, 0.33, 0.32, 15.66, 0.22, 0.68] },
                { count: 100, params: [158.86, 18.4, 24.98, 0.3, 0.3, 1.72, 0.06, 0.37] }
            ],
            pulsating_eye: [
                { count: 102, params: [293.86, 17.06, 38.3, 0.81, 0.05, 0.83, 0.2, 0.9] },
                { count: 124, params: [226.18, 19.27, 24.57, 0.95, 0.84, 13.09, 0.07, 0.8] },
                { count: 74, params: [49.98, 8.44, 4.39, 0.92, 0.14, 96.92, 0.13, 0.51] }
            ],
            chaos_cells: [
                { count: 144, params: [109.03, 6.71, 12.7, 0.47, 0.6, 61.43, 0.02, 0.21] },
                { count: 89, params: [117.15, 16.33, 31.88, 0.39, 0.13, 12.96, 0.48, 0.8] },
                { count: 67, params: [76.3, 8.59, 26.57, 0.7, 0.64, 28.39, 0.3, 0.35] }
            ],
            aggressive_predator: [
                { count: 18, params: [211.92, 12.59, 19.37, 0.09, 0.21, 57.92, 0.0, 0.95] },
                { count: 41, params: [257.27, 14.96, 35.66, 0.2, 0.8, 47.81, 0.13, 0.13] },
                { count: 35, params: [262.68, 2.82, 38.32, 0.21, 0.01, 54.93, 0.11, 0.19] },
                { count: 31, params: [78.58, 5.7, 33.23, 0.89, 0.18, 45.44, 0.04, 0.05] },
                { count: 7, params: [194.21, 12.88, 21.68, 0.97, 0.19, 99.21, 0.5, 0.13] }
            ],
            fast_walker_slow_follower: [
                { count: 67, params: [216.35, 11.75, 7.7, 0.83, 0.97, 97.31, 0.02, 0.38] },
                { count: 29, params: [254.64, 7.28, 7.0, 0.95, 0.11, 22.41, 0.43, 0.31] },
                { count: 13, params: [105.4, 3.55, 5.24, 0.34, 0.18, 23.53, 0.39, 0.24] }
            ],
            swinger: [
                { count: 48, params: [150.39, 15.89, 23.54, 0.74, 0.45, 62.65, 0.33, 0.13] },
                { count: 152, params: [217.14, 12.13, 12.42, 0.59, 0.98, 14.06, 0.04, 0.65] },
                { count: 14, params: [248.54, 5.85, 22.26, 0.43, 0.11, 17.14, 0.06, 0.68] },
                { count: 31, params: [141.53, 2.91, 4.86, 0.92, 0.03, 21.87, 0.28, 0.2] }
            ],
            rotary: [
                { count: 29, params: [122.13, 19.19, 17.98, 0.65, 0.44, 19.88, 0.46, 0.2] },
                { count: 51, params: [299.13, 0.79, 38.71, 0.25, 0.18, 86.49, 0.38, 0.43] },
                { count: 10, params: [252.92, 19.99, 10.21, 0.23, 0.17, 1.22, 0.28, 0.92] }
            ],
            wedding_ring: [
                { count: 24, params: [220.51, 13.88, 3.47, 0.46, 0.38, 6.23, 0.19, 0.68] },
                { count: 13, params: [64.07, 1.4, 19.7, 0.88, 0.27, 0.36, 0.47, 0.72] },
                { count: 35, params: [117.53, 7.31, 21.72, 0.3, 0.5, 98.69, 0.03, 0.29] }
            ],
            turbulent_runner: [
                { count: 131, params: [177.1, 9.71, 30.06, 0.8, 0.43, 19.65, 0.45, 0.91] },
                { count: 169, params: [277.3, 14.67, 37.71, 0.68, 0.23, 77.01, 0.02, 0.31] }
            ],
            blobs: [
                { count: 300, params: [20.8, 1.95, 20.75, 0.95, 0.99, 9.31, 0.05, 0.68] }
            ],
            linear_oscillator: [
                { count: 133, params: [214.41, 17.93, 35.14, 0.64, 0.13, 0.29, 0.08, 0.97] },
                { count: 24, params: [253.6, 7.19, 15.51, 0.82, 0.33, 32.65, 0.34, 0.56] }
            ]
        };
        
        // åŠ è½½é¢„è®¾
        function loadPreset(presetName) {
            if (!presets[presetName]) {
                console.error('æœªæ‰¾åˆ°é¢„è®¾:', presetName);
                return;
            }
            
            individuals = [];
            const presetData = presets[presetName];
            
            // è®¡ç®—ç”»å¸ƒä¸­å¿ƒç‚¹ - é€‚åº”æ–°å°ºå¯¸
            const centerX = 1200 / 2;
            const centerY = 900 / 2;
            const spawnRadius = 80;
            
            presetData.forEach((pop, index) => {
                const params = new SwarmParameters(
                    pop.params[0], pop.params[1], pop.params[2],
                    pop.params[3], pop.params[4], pop.params[5],
                    pop.params[6], pop.params[7]
                );
                
                // ç”Ÿæˆä¸ªä½“
                for (let i = 0; i < pop.count; i++) {
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * spawnRadius;
                    
                    const x = centerX + Math.cos(angle) * radius;
                    const y = centerY + Math.sin(angle) * radius;
                    
                    individuals.push(new SwarmIndividual(
                        x, y,
                        (Math.random() - 0.5) * 2,
                        (Math.random() - 0.5) * 2,
                        params
                    ));
                }
            });
            
            updatePopulationDisplay();
            
            if (!isRunning) {
                startSimulation();
            }
            
            console.log(`ğŸ¯ åŠ è½½é¢„è®¾: ${presetName}, æ€»ç²’å­æ•°: ${individuals.length}`);
        }
        
        // æ§åˆ¶å‡½æ•°
        function startSimulation() {
            isRunning = true;
        }
        
        function pauseSimulation() {
            isRunning = false;
        }
        
        function clearCanvas() {
            pauseSimulation();
            individuals = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updatePopulationDisplay();
        }
        
        function resetView() {
            initializeSwarm();
        }
        
        function togglePlayPause() {
            if (isRunning) {
                pauseSimulation();
            } else {
                startSimulation();
            }
        }
        
        // è§£æè‡ªå®šä¹‰å‚æ•°
        function parseCustomParameters() {
            const input = document.getElementById('parameterInput').value.trim();
            
            if (!input) {
                showParseStatus('è¯·è¾“å…¥å‚æ•°ï¼', 'error');
                return;
            }
            
            showParseStatus('ğŸ” æ­£åœ¨è§£æå‚æ•°...', 'info');
            
            try {
                const lines = input.split('\n').filter(line => line.trim());
                individuals = [];
                let totalParsed = 0;
                
                // è®¡ç®—ç”»å¸ƒä¸­å¿ƒç‚¹
                const centerX = 1200 / 2;
                const centerY = 900 / 2;
                const spawnRadius = 80;
                
                lines.forEach((line, index) => {
                    // åŒ¹é…æ ¼å¼: count * (param1, param2, param3, param4, param5, param6, param7, param8)
                    const match = line.trim().match(/(\d+)\s*\*\s*\(([^)]+)\)/);
                    
                    if (match) {
                        const count = parseInt(match[1]);
                        const params = match[2].split(',').map(p => parseFloat(p.trim()));
                        
                        if (params.length === 8 && params.every(p => !isNaN(p))) {
                            const swarmParams = new SwarmParameters(
                                params[0], params[1], params[2],
                                params[3], params[4], params[5],
                                params[6], params[7]
                            );
                            
                            // ç”Ÿæˆä¸ªä½“
                            for (let i = 0; i < count; i++) {
                                const angle = Math.random() * 2 * Math.PI;
                                const radius = Math.random() * spawnRadius;
                                
                                const x = centerX + Math.cos(angle) * radius;
                                const y = centerY + Math.sin(angle) * radius;
                                
                                individuals.push(new SwarmIndividual(
                                    x, y,
                                    (Math.random() - 0.5) * 2,
                                    (Math.random() - 0.5) * 2,
                                    swarmParams
                                ));
                            }
                            
                            totalParsed += count;
                        } else {
                            throw new Error(`ç¬¬ ${index + 1} è¡Œå‚æ•°æ ¼å¼é”™è¯¯ï¼šéœ€è¦8ä¸ªæ•°å€¼å‚æ•°`);
                        }
                    } else {
                        throw new Error(`ç¬¬ ${index + 1} è¡Œæ ¼å¼é”™è¯¯ï¼šåº”ä¸º "æ•°é‡ * (å‚æ•°1, å‚æ•°2, ...å‚æ•°8)"`);
                    }
                });
                
                if (individuals.length === 0) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å‚æ•°è¡Œ');
                }
                
                updatePopulationDisplay();
                
                // å¦‚æœæ²¡æœ‰è¿è¡Œï¼Œå¼€å§‹æ¨¡æ‹Ÿ
                if (!isRunning) {
                    startSimulation();
                }
                
                showParseStatus(`âœ… è§£ææˆåŠŸï¼åˆ›å»ºäº† ${totalParsed} ä¸ªç²’å­`, 'success');
                console.log(`ğŸ“ è‡ªå®šä¹‰å‚æ•°è§£ææˆåŠŸ: ${totalParsed} ä¸ªç²’å­`);
                
            } catch (error) {
                console.error('âŒ å‚æ•°è§£æå¤±è´¥:', error);
                showParseStatus(`âŒ è§£æå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ¸…ç©ºå‚æ•°è¾“å…¥
        function clearParameters() {
            document.getElementById('parameterInput').value = '';
            showParseStatus('è¾“å…¥å·²æ¸…ç©º', 'info');
            setTimeout(() => {
                document.getElementById('parseStatus').style.display = 'none';
            }, 2000);
        }
        
        // æ˜¾ç¤ºè§£æçŠ¶æ€
        function showParseStatus(message, type) {
            const statusDiv = document.getElementById('parseStatus');
            statusDiv.textContent = message;
            statusDiv.className = `parse-status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // åŒæ­¥åˆ°Unity
        async function syncToUnity() {
            if (individuals.length === 0) {
                showSyncStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¢„è®¾æˆ–è¾“å…¥å‚æ•°ï¼', 'error');
                return;
            }
            
            showSyncStatus('ğŸš€ æ­£åœ¨åŒæ­¥åˆ°Unity...', 'info');
            
            try {
                // æ”¶é›†ç§ç¾¤æ•°æ®
                const populationStats = new Map();
                
                individuals.forEach(individual => {
                    const paramStr = individual.parameters.toString();
                    if (populationStats.has(paramStr)) {
                        populationStats.set(paramStr, populationStats.get(paramStr) + 1);
                    } else {
                        populationStats.set(paramStr, 1);
                    }
                });
                
                const populations = [];
                populationStats.forEach((count, paramStr) => {
                    // ä»å­—ç¬¦ä¸²ä¸­è§£æå‚æ•°
                    const match = paramStr.match(/\(([^)]+)\)/);
                    if (match) {
                        const params = match[1].split(',').map(p => parseFloat(p.trim()));
                        populations.push({
                            count: count,
                            parameters: {
                                neighborhoodRadius: params[0],
                                normalSpeed: params[1],
                                maxSpeed: params[2],
                                c1: params[3],
                                c2: params[4],
                                c3: params[5],
                                c4: params[6],
                                c5: params[7],
                                color: `rgb(${Math.floor((params[3] / 1.0) * 0.8 * 255)}, ${Math.floor((params[4] / 1.0) * 0.8 * 255)}, ${Math.floor((params[5] / 100.0) * 0.8 * 255)})`
                            }
                        });
                    }
                });
                
                const swarmData = {
                    sessionId: 'web_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    timestamp: new Date().toISOString(),
                    populations: populations,
                    totalIndividuals: individuals.length,
                    userAgent: navigator.userAgent,
                    source: 'SwarmChemistry Web Cloud'
                };
                
                console.log('ğŸ“¤ å‘é€æ•°æ®åˆ°æœåŠ¡å™¨:', swarmData);
                
                const response = await fetch(SYNC_CONFIG.serverUrl + '/swarm-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(swarmData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSyncStatus(`âœ… åŒæ­¥æˆåŠŸï¼æ•°æ®ID: ${result.dataId}`, 'success');
                    console.log('âœ… åŒæ­¥æˆåŠŸ:', result);
                } else {
                    throw new Error(result.message || 'åŒæ­¥å¤±è´¥');
                }
                
            } catch (error) {
                console.error('âŒ åŒæ­¥å¤±è´¥:', error);
                showSyncStatus(`âŒ åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
        function showSyncStatus(message, type) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.textContent = message;
            statusDiv.className = `sync-status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        console.log('ğŸŒ SwarmChemistry äº‘ç«¯ç‰ˆåŠ è½½å®Œæˆ');
        console.log('ğŸ”— APIç«¯ç‚¹:', SYNC_CONFIG.serverUrl);
    </script>
</body>
</html> 