<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>群体化学 - SwarmChemistry 云端版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            overflow-x: auto;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            align-items: start;
        }
        
        .canvas-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .controls-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            height: fit-content;
            max-height: 1200px;
            overflow-y: auto;
        }
        
        canvas {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: #000;
            display: block;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .canvas-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .control-group h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
        
        button:hover {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .population-display {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 10px;
            white-space: pre-line;
            border: 1px solid rgba(255,255,255,0.1);
            line-height: 1.4;
        }
        
        /* 网络同步样式 */
        .sync-button {
            background: linear-gradient(145deg, #4CAF50, #45a049) !important;
            border-color: #4CAF50 !important;
            font-weight: bold;
            font-size: 16px;
            padding: 12px 24px;
        }
        
        .sync-button:hover {
            background: linear-gradient(145deg, #5CBF60, #4CAF50) !important;
        }
        
        .sync-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }
        
        .sync-status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #4CAF50;
        }
        
        .sync-status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            color: #f44336;
        }
        
        .sync-status.info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
            color: #2196F3;
        }
        
        /* 参数输入样式 */
        .parameter-input {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.4;
            resize: vertical;
            backdrop-filter: blur(10px);
        }
        
        .parameter-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .parameter-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }
        
        .parameter-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .parse-status {
            margin-top: 10px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }
        
        .parse-status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #4CAF50;
        }
        
        .parse-status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            color: #f44336;
        }
        
        .parse-status.info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
            color: #2196F3;
        }
        
        /* 响应式设计 */
        @media (max-width: 1600px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .controls-section {
                max-height: none;
            }
            
            canvas {
                max-width: 100%;
                height: auto;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .preset-buttons {
                grid-template-columns: 1fr;
            }
            
            canvas {
                max-width: 100%;
                height: auto;
            }
        }
        
        .parse-status.info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
            color: #2196F3;
        }
        
        /* 参数调试器样式 */
        .parameter-debugger {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .population-selector {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .population-selector label {
            font-weight: 500;
            color: #fff;
        }
        
        .population-selector select {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: #333;
            padding: 8px 12px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }
        
        .population-selector select option {
            background: #fff;
            color: #333;
        }
        
        .population-selector select:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
        }
        
        .population-info {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .parameter-sliders {
            display: grid;
            gap: 15px;
        }
        
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .slider-group label {
            font-size: 13px;
            font-weight: 500;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .slider-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(145deg, #4CAF50, #45a049);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .slider-group input[type="range"]::-webkit-slider-thumb:hover {
            background: linear-gradient(145deg, #5CBF60, #4CAF50);
            transform: scale(1.1);
        }
        
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(145deg, #4CAF50, #45a049);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .slider-value {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            color: #4CAF50;
            font-weight: bold;
            min-width: 60px;
            text-align: right;
        }
        
        .debugger-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .debugger-controls button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🐝 群体化学 - SwarmChemistry</h1>
            <p>🌐 云端版 - 创作粒子行为，同步到Unity体验</p>
        </div>
        
        <div class="main-layout">
            <div class="canvas-section">
                <canvas id="swarmCanvas" width="1200" height="900"></canvas>
                <div class="canvas-controls">
                    <button onclick="startSimulation()">▶️ 开始</button>
                    <button onclick="pauseSimulation()">⏸️ 暂停</button>
                    <button onclick="clearCanvas()">🗑️ 清空</button>
                    <button onclick="resetView()">🔄 重置视图</button>
                </div>
            </div>
            
            <div class="controls-section">
                <div class="control-group">
                    <h3>🚀 同步到Unity</h3>
                    <button class="sync-button" onclick="syncToUnity()">🚀 同步到Unity</button>
                    <div id="syncStatus" class="sync-status" style="display: none;"></div>
                </div>
                
                <div class="control-group">
                    <h3>📝 自定义参数</h3>
                    <textarea id="parameterInput" class="parameter-input" placeholder="输入参数格式，例如：
48 * (150.39, 15.89, 23.54, 0.74, 0.45, 62.65, 0.33, 0.13)
152 * (217.14, 12.13, 12.42, 0.59, 0.98, 14.06, 0.04, 0.65)
14 * (248.54, 5.85, 22.26, 0.43, 0.11, 17.14, 0.06, 0.68)
31 * (141.53, 2.91, 4.86, 0.92, 0.03, 21.87, 0.28, 0.2)"></textarea>
                    <div class="parameter-controls">
                        <button onclick="parseCustomParameters()">🔍 解析参数</button>
                        <button onclick="clearParameters()">🗑️ 清空输入</button>
                    </div>
                    <div id="parseStatus" class="parse-status" style="display: none;"></div>
                </div>
                
                <div class="control-group">
                    <h3>🎛️ 参数调试器</h3>
                    <div class="parameter-debugger">
                        <div class="population-selector">
                            <label for="populationSelect">选择种群:</label>
                            <select id="populationSelect" onchange="selectPopulation()">
                                <option value="">请选择种群...</option>
                            </select>
                            <span id="populationInfo" class="population-info"></span>
                        </div>
                        
                        <div id="parameterSliders" class="parameter-sliders" style="display: none;">
                            <div class="slider-group">
                                <label>邻域半径 (Neighborhood Radius):</label>
                                <input type="range" id="slider_neighborhoodRadius" min="10" max="400" step="0.1" oninput="updateParameter('neighborhoodRadius', this.value)">
                                <span id="value_neighborhoodRadius" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>正常速度 (Normal Speed):</label>
                                <input type="range" id="slider_normalSpeed" min="0" max="25" step="0.01" oninput="updateParameter('normalSpeed', this.value)">
                                <span id="value_normalSpeed" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>最大速度 (Max Speed):</label>
                                <input type="range" id="slider_maxSpeed" min="0" max="50" step="0.01" oninput="updateParameter('maxSpeed', this.value)">
                                <span id="value_maxSpeed" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>聚集力 C1 (Cohesion):</label>
                                <input type="range" id="slider_c1" min="0" max="1" step="0.01" oninput="updateParameter('c1', this.value)">
                                <span id="value_c1" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>对齐力 C2 (Alignment):</label>
                                <input type="range" id="slider_c2" min="0" max="1" step="0.01" oninput="updateParameter('c2', this.value)">
                                <span id="value_c2" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>分离力 C3 (Separation):</label>
                                <input type="range" id="slider_c3" min="0" max="100" step="0.01" oninput="updateParameter('c3', this.value)">
                                <span id="value_c3" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>随机性 C4 (Randomness):</label>
                                <input type="range" id="slider_c4" min="0" max="1" step="0.01" oninput="updateParameter('c4', this.value)">
                                <span id="value_c4" class="slider-value">0</span>
                            </div>
                            
                            <div class="slider-group">
                                <label>速度调节 C5 (Speed Control):</label>
                                <input type="range" id="slider_c5" min="0" max="1" step="0.01" oninput="updateParameter('c5', this.value)">
                                <span id="value_c5" class="slider-value">0</span>
                            </div>
                            
                            <div class="debugger-controls">
                                <button onclick="resetSelectedPopulation()">🔄 重置参数</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>🌊 经典SwarmChemistry预设 (第一组)</h3>
                    <div class="preset-buttons">
                        <button onclick="loadPreset('uzushio')">🌀 Uzushio</button>
                        <button onclick="loadPreset('insurmountable_wall')">🧱 Insurmountable Wall</button>
                        <button onclick="loadPreset('cell_with_two_nuclei')">🔬 Cell with Two Nuclei</button>
                        <button onclick="loadPreset('multicellularity')">🧬 Multicellularity</button>
                        <button onclick="loadPreset('jelly_fish')">🎐 Jelly Fish</button>
                        <button onclick="loadPreset('no_wait_this_way')">↩️ No, Wait - This Way</button>
                        <button onclick="loadPreset('recombining_blobs')">🫧 Recombining Blobs</button>
                        <button onclick="loadPreset('playing_catch')">⚾ Playing Catch</button>
                        <button onclick="loadPreset('pulsating_eye')">👁️ Pulsating Eye</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>🔬 经典SwarmChemistry预设 (第二组)</h3>
                    <div class="preset-buttons">
                        <button onclick="loadPreset('chaos_cells')">🌪️ Chaos Cells</button>
                        <button onclick="loadPreset('aggressive_predator')">🦈 Aggressive Predator</button>
                        <button onclick="loadPreset('fast_walker_slow_follower')">🚶‍♂️ Fast Walker & Slow Follower</button>
                        <button onclick="loadPreset('swinger')">🎭 Swinger</button>
                        <button onclick="loadPreset('rotary')">⚙️ Rotary</button>
                        <button onclick="loadPreset('wedding_ring')">💍 Wedding Ring</button>
                        <button onclick="loadPreset('turbulent_runner')">🏃‍♂️ Turbulent Runner</button>
                        <button onclick="loadPreset('blobs')">🟢 Blobs</button>
                        <button onclick="loadPreset('linear_oscillator')">📊 Linear Oscillator</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>📊 当前种群</h3>
                    <div id="populationDisplay" class="population-display">
                        点击预设按钮来生成粒子种群...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // SwarmChemistry 云端版 - 与原始Java版本完全一致的算法实现
        
        // 全局变量
        let canvas, ctx;
        let individuals = [];
        let animationId;
        let isRunning = false;
        let mouseX = -1, mouseY = -1;
        let mouseInfluence = false;
        
        // 同步配置 - 使用当前域名
        const SYNC_CONFIG = {
            serverUrl: window.location.origin + '/api',
            enabled: true
        };
        
        // SwarmParameters类 - 与原始版本完全一致
        class SwarmParameters {
            constructor(neighborhoodRadius = 50, normalSpeed = 2, maxSpeed = 5, 
                        c1 = 0.5, c2 = 0.5, c3 = 10, c4 = 0.1, c5 = 0.5) {
                this.neighborhoodRadius = neighborhoodRadius;
                this.normalSpeed = normalSpeed;
                this.maxSpeed = maxSpeed;
                this.c1 = c1; // 聚集力
                this.c2 = c2; // 对齐力
                this.c3 = c3; // 分离力
                this.c4 = c4; // 随机性
                this.c5 = c5; // 速度调节
            }
            
            // 根据Java版本的颜色计算规则
            getColor() {
                const r = Math.floor((this.c1 / 1.0) * 0.8 * 255);
                const g = Math.floor((this.c2 / 1.0) * 0.8 * 255);
                const b = Math.floor((this.c3 / 100.0) * 0.8 * 255);
                return `rgb(${r}, ${g}, ${b})`;
            }
            
            clone() {
                return new SwarmParameters(
                    this.neighborhoodRadius, this.normalSpeed, this.maxSpeed,
                    this.c1, this.c2, this.c3, this.c4, this.c5
                );
            }
            
            toString() {
                return `(${this.neighborhoodRadius.toFixed(2)}, ${this.normalSpeed.toFixed(2)}, ${this.maxSpeed.toFixed(2)}, ${this.c1.toFixed(2)}, ${this.c2.toFixed(2)}, ${this.c3.toFixed(2)}, ${this.c4.toFixed(2)}, ${this.c5.toFixed(2)})`;
            }
        }
        
        // SwarmIndividual类 - 与原始版本完全一致
        class SwarmIndividual {
            constructor(x, y, dx = 0, dy = 0, parameters) {
                this.x = x;
                this.y = y;
                this.dx = dx;
                this.dy = dy;
                this.dx2 = dx; // 用于速度调节的临时变量
                this.dy2 = dy;
                this.parameters = parameters;
            }
            
            // 加速度计算
            accelerate(ax, ay, maxSpeed) {
                this.dx2 += ax;
                this.dy2 += ay;
                
                // 限制最大速度
                const speed = Math.sqrt(this.dx2 * this.dx2 + this.dy2 * this.dy2);
                if (speed > maxSpeed) {
                    this.dx2 = (this.dx2 / speed) * maxSpeed;
                    this.dy2 = (this.dy2 / speed) * maxSpeed;
                }
            }
            
            // 移动
            move() {
                this.dx = this.dx2;
                this.dy = this.dy2;
                
                this.x += this.dx;
                this.y += this.dy;
            }
            
            // 边界处理
            wrapAround(width, height) {
                if (this.x < 0) this.x = width;
                if (this.x > width) this.x = 0;
                if (this.y < 0) this.y = height;
                if (this.y > height) this.y = 0;
            }
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('swarmCanvas');
            ctx = canvas.getContext('2d');
            
            // 设置高DPI支持
            const dpr = window.devicePixelRatio || 1;
            const displayWidth = 1200;
            const displayHeight = 900;
            
            canvas.width = displayWidth * dpr;
            canvas.height = displayHeight * dpr;
            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';
            ctx.scale(dpr, dpr);
            
            setupEventListeners();
            initializeSwarm();
            animate();
            
            console.log('🎮 SwarmChemistry 云端版初始化完成');
            console.log('🖼️ 画布尺寸: 1200x900');
            console.log('🌐 服务器地址:', SYNC_CONFIG.serverUrl);
        });
        
        // 事件监听器设置
        function setupEventListeners() {
            // 鼠标事件
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
            });
            
            canvas.addEventListener('mouseenter', () => {
                mouseInfluence = true;
            });
            
            canvas.addEventListener('mouseleave', () => {
                mouseInfluence = false;
            });
            
            // 键盘事件
            document.addEventListener('keydown', (e) => {
                if (e.key === ' ') {
                    e.preventDefault();
                    togglePlayPause();
                }
            });
        }
        
        // 种群初始化 - 与原始版本完全一致
        function initializeSwarm() {
            individuals = [];
            
            // 创建多个不同参数的种群 - 使用原始默认参数
            const populations = [
                { count: 49, params: new SwarmParameters(184.07, 12.64, 38.49, 0.67, 0.31, 63.78, 0.11, 0.21) },
                { count: 67, params: new SwarmParameters(177.92, 15.66, 11.05, 0.85, 0.41, 51.77, 0.09, 0.86) },
                { count: 58, params: new SwarmParameters(177.92, 15.66, 11.05, 0.85, 0.41, 51.77, 0.03, 0.86) },
                { count: 10, params: new SwarmParameters(298.48, 0.65, 19.27, 0.84, 0.11, 83.18, 0.24, 0.5) },
                { count: 37, params: new SwarmParameters(81.6, 18.34, 27.3, 0.94, 0.17, 3.41, 0.2, 0.9) },
                { count: 1, params: new SwarmParameters(274.4, 3.33, 7.42, 0.9, 0.19, 7.37, 0.43, 0.17) },
                { count: 12, params: new SwarmParameters(203.64, 3.33, 7.42, 0.9, 0.19, 7.37, 0.43, 0.17) }
            ];
            
            // 计算画布中心点 - 适应新尺寸
            const centerX = 1200 / 2;
            const centerY = 900 / 2;
            const spawnRadius = 80; // 稍微增大生成半径
            
            populations.forEach(pop => {
                for (let i = 0; i < pop.count; i++) {
                    // 在圆形区域内随机生成位置
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * spawnRadius;
                    
                    const x = centerX + Math.cos(angle) * radius;
                    const y = centerY + Math.sin(angle) * radius;
                    
                    const individual = new SwarmIndividual(
                        x, y,
                        (Math.random() - 0.5) * 2, // 初始速度
                        (Math.random() - 0.5) * 2,
                        pop.params.clone()
                    );
                    individuals.push(individual);
                }
            });
            
            updatePopulationDisplay();
        }
        
        // 核心群体行为算法 - 与Java版本完全一致
        function simulateSwarmBehavior() {
            const mouseAgent = mouseInfluence ? {
                x: mouseX,
                y: mouseY,
                dx: 0,
                dy: 0
            } : null;
            
            individuals.forEach(individual => {
                const neighbors = findNeighbors(individual, mouseAgent);
                const params = individual.parameters;
                
                let ax = 0, ay = 0;
                
                if (neighbors.length === 0) {
                    // 无邻居时随机移动 - 与Java版本一致
                    ax = Math.random() - 0.5;
                    ay = Math.random() - 0.5;
                } else {
                    // 计算邻居中心和平均速度
                    let centerX = 0, centerY = 0;
                    let avgDx = 0, avgDy = 0;
                    
                    neighbors.forEach(neighbor => {
                        centerX += neighbor.x;
                        centerY += neighbor.y;
                        avgDx += neighbor.dx || 0;
                        avgDy += neighbor.dy || 0;
                    });
                    
                    centerX /= neighbors.length;
                    centerY /= neighbors.length;
                    avgDx /= neighbors.length;
                    avgDy /= neighbors.length;
                    
                    // c1: 聚集行为 - 与Java版本完全一致
                    ax += (centerX - individual.x) * params.c1;
                    ay += (centerY - individual.y) * params.c1;
                    
                    // c2: 对齐行为 - 与Java版本完全一致
                    ax += (avgDx - individual.dx) * params.c2;
                    ay += (avgDy - individual.dy) * params.c2;
                    
                    // c3: 分离行为 - 与Java版本完全一致
                    neighbors.forEach(neighbor => {
                        const dx = individual.x - neighbor.x;
                        const dy = individual.y - neighbor.y;
                        let distSq = dx * dx + dy * dy;
                        
                        if (distSq === 0) distSq = 0.001; // 与Java版本一致的处理
                        ax += (dx / distSq) * params.c3;
                        ay += (dy / distSq) * params.c3;
                    });
                    
                    // c4: 随机性 - 与Java版本完全一致
                    if (Math.random() < params.c4) {
                        ax += Math.random() * 10 - 5;
                        ay += Math.random() * 10 - 5;
                    }
                }
                
                // 使用原始最大速度参数
                individual.accelerate(ax, ay, params.maxSpeed);
                
                // c5: 速度调节 - 与Java版本完全一致
                const currentSpeed = Math.sqrt(individual.dx2 * individual.dx2 + individual.dy2 * individual.dy2);
                if (currentSpeed === 0) {
                    // 避免除零错误
                    individual.accelerate(0, 0, params.maxSpeed);
                } else {
                    const speedDiff = params.normalSpeed - currentSpeed;
                    individual.accelerate(
                        (individual.dx2 / currentSpeed) * speedDiff * params.c5,
                        (individual.dy2 / currentSpeed) * speedDiff * params.c5,
                        params.maxSpeed
                    );
                }
            });
        }
        
        // 查找邻居 - 与Java版本完全一致
        function findNeighbors(individual, mouseAgent = null) {
            const neighbors = [];
            const radiusSq = individual.parameters.neighborhoodRadius * individual.parameters.neighborhoodRadius;
            
            // 查找其他个体邻居
            individuals.forEach(other => {
                if (other !== individual) {
                    const dx = individual.x - other.x;
                    const dy = individual.y - other.y;
                    const distSq = dx * dx + dy * dy;
                    
                    if (distSq < radiusSq) {
                        neighbors.push(other);
                    }
                }
            });
            
            // 鼠标影响 - 与Java版本一致的权重
            if (mouseAgent) {
                const dx = individual.x - mouseAgent.x;
                const dy = individual.y - mouseAgent.y;
                const distSq = dx * dx + dy * dy;
                
                if (distSq < radiusSq) {
                    // Java版本使用weightOfMouseCursor = 20
                    for (let i = 0; i < 20; i++) {
                        neighbors.push(mouseAgent);
                    }
                }
            }
            
            return neighbors;
        }
        
        // 更新
        function update() {
            if (!isRunning) return;
            
            simulateSwarmBehavior();
            
            individuals.forEach(individual => {
                individual.move();
                individual.wrapAround(1200, 900); // 使用固定画布尺寸
            });
        }
        
        // 渲染
        function render() {
            // 完全清空画布
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, 1200, 900); // 使用固定画布尺寸
            
            // 绘制个体
            individuals.forEach(individual => {
                const color = individual.parameters.getColor();
                
                // 绘制个体
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(individual.x, individual.y, 3, 0, Math.PI * 2);
                ctx.fill();
                
                // 绘制方向指示
                const speed = Math.sqrt(individual.dx * individual.dx + individual.dy * individual.dy);
                if (speed > 0.05) {
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(individual.x, individual.y);
                    ctx.lineTo(
                        individual.x + (individual.dx / speed) * 6,
                        individual.y + (individual.dy / speed) * 6
                    );
                    ctx.stroke();
                }
            });
            
            // 绘制鼠标影响范围
            if (mouseInfluence && mouseX >= 0) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(mouseX, mouseY, 50, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
        
        // 动画循环
        function animate() {
            update();
            render();
            requestAnimationFrame(animate);
        }
        
        // 参数调试器相关变量
        let currentPopulations = [];
        let selectedPopulationIndex = -1;
        let originalParameters = null;
        
        // 统计和显示种群信息
        function updatePopulationDisplay() {
            const populationStats = new Map();
            
            individuals.forEach(individual => {
                const paramStr = individual.parameters.toString();
                if (populationStats.has(paramStr)) {
                    populationStats.set(paramStr, populationStats.get(paramStr) + 1);
                } else {
                    populationStats.set(paramStr, 1);
                }
            });
            
            let displayText = `总种群数: ${populationStats.size}\n`;
            displayText += `总粒子数: ${individuals.length}\n\n`;
            
            // 构建参数输入栏的同步文本
            let parameterText = '';
            
            // 更新种群列表用于调试器
            currentPopulations = [];
            
            let index = 1;
            populationStats.forEach((count, params) => {
                displayText += `种群 ${index}: ${count} * ${params}\n`;
                parameterText += `${count} * ${params}\n`;
                
                // 解析参数用于调试器
                const match = params.match(/\(([^)]+)\)/);
                if (match) {
                    const paramValues = match[1].split(',').map(p => parseFloat(p.trim()));
                    currentPopulations.push({
                        index: index,
                        count: count,
                        parameters: {
                            neighborhoodRadius: paramValues[0],
                            normalSpeed: paramValues[1],
                            maxSpeed: paramValues[2],
                            c1: paramValues[3],
                            c2: paramValues[4],
                            c3: paramValues[5],
                            c4: paramValues[6],
                            c5: paramValues[7]
                        }
                    });
                }
                index++;
            });
            
            document.getElementById('populationDisplay').textContent = displayText;
            
            // 实时同步到参数输入栏
            const parameterInput = document.getElementById('parameterInput');
            if (parameterInput && individuals.length > 0) {
                parameterInput.value = parameterText.trim();
                
                // 显示同步状态
                showParseStatus(`✅ 已同步当前画布种群参数 (${individuals.length}个粒子)`, 'success');
                setTimeout(() => {
                    const statusDiv = document.getElementById('parseStatus');
                    if (statusDiv) statusDiv.style.display = 'none';
                }, 3000);
            }
            
            // 更新调试器的种群选择器
            updatePopulationSelector();
        }
        
        // 更新种群选择器
        function updatePopulationSelector() {
            const selector = document.getElementById('populationSelect');
            if (!selector) return;
            
            // 清空现有选项
            selector.innerHTML = '<option value="">请选择种群...</option>';
            
            // 添加种群选项
            currentPopulations.forEach((pop, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `种群 ${pop.index} (${pop.count} 个粒子)`;
                selector.appendChild(option);
            });
            
            // 如果之前有选中的种群，尝试保持选中状态
            if (selectedPopulationIndex >= 0 && selectedPopulationIndex < currentPopulations.length) {
                selector.value = selectedPopulationIndex;
            } else {
                selectedPopulationIndex = -1;
                document.getElementById('parameterSliders').style.display = 'none';
            }
        }
        
        // 选择种群
        function selectPopulation() {
            const selector = document.getElementById('populationSelect');
            const index = parseInt(selector.value);
            
            if (isNaN(index) || index < 0 || index >= currentPopulations.length) {
                selectedPopulationIndex = -1;
                document.getElementById('parameterSliders').style.display = 'none';
                document.getElementById('populationInfo').textContent = '';
                return;
            }
            
            selectedPopulationIndex = index;
            const population = currentPopulations[index];
            originalParameters = { ...population.parameters };
            
            // 显示种群信息
            document.getElementById('populationInfo').textContent = 
                `${population.count} 个粒子`;
            
            // 更新滑块值
            updateSliders(population.parameters);
            
            // 显示滑块区域
            document.getElementById('parameterSliders').style.display = 'block';
        }
        
        // 更新滑块显示
        function updateSliders(params) {
            const paramNames = ['neighborhoodRadius', 'normalSpeed', 'maxSpeed', 'c1', 'c2', 'c3', 'c4', 'c5'];
            
            paramNames.forEach(name => {
                const slider = document.getElementById(`slider_${name}`);
                const valueSpan = document.getElementById(`value_${name}`);
                
                if (slider && valueSpan) {
                    slider.value = params[name];
                    valueSpan.textContent = params[name].toFixed(2);
                }
            });
        }
        
        // 更新单个参数
        function updateParameter(paramName, value) {
            if (selectedPopulationIndex < 0) return;
            
            const numValue = parseFloat(value);
            const valueSpan = document.getElementById(`value_${paramName}`);
            if (valueSpan) {
                valueSpan.textContent = numValue.toFixed(2);
            }
            
            // 更新当前种群参数
            currentPopulations[selectedPopulationIndex].parameters[paramName] = numValue;
            
            // 实时应用到个体
            applyParameterChanges();
        }
        
        // 应用参数更改
        function applyParameterChanges() {
            if (selectedPopulationIndex < 0) return;
            
            const targetParams = currentPopulations[selectedPopulationIndex].parameters;
            const targetParamStr = `(${targetParams.neighborhoodRadius.toFixed(2)}, ${targetParams.normalSpeed.toFixed(2)}, ${targetParams.maxSpeed.toFixed(2)}, ${targetParams.c1.toFixed(2)}, ${targetParams.c2.toFixed(2)}, ${targetParams.c3.toFixed(2)}, ${targetParams.c4.toFixed(2)}, ${targetParams.c5.toFixed(2)})`;
            
            // 找到对应的个体并更新参数
            individuals.forEach(individual => {
                const currentParamStr = individual.parameters.toString();
                
                // 检查是否属于当前选中的种群
                let isTargetPopulation = false;
                currentPopulations.forEach((pop, index) => {
                    if (index === selectedPopulationIndex) {
                        const popParamStr = `(${pop.parameters.neighborhoodRadius.toFixed(2)}, ${pop.parameters.normalSpeed.toFixed(2)}, ${pop.parameters.maxSpeed.toFixed(2)}, ${pop.parameters.c1.toFixed(2)}, ${pop.parameters.c2.toFixed(2)}, ${pop.parameters.c3.toFixed(2)}, ${pop.parameters.c4.toFixed(2)}, ${pop.parameters.c5.toFixed(2)})`;
                        
                        // 使用原始参数进行匹配
                        if (originalParameters) {
                            const originalParamStr = `(${originalParameters.neighborhoodRadius.toFixed(2)}, ${originalParameters.normalSpeed.toFixed(2)}, ${originalParameters.maxSpeed.toFixed(2)}, ${originalParameters.c1.toFixed(2)}, ${originalParameters.c2.toFixed(2)}, ${originalParameters.c3.toFixed(2)}, ${originalParameters.c4.toFixed(2)}, ${originalParameters.c5.toFixed(2)})`;
                            if (currentParamStr === originalParamStr) {
                                isTargetPopulation = true;
                            }
                        }
                    }
                });
                
                if (isTargetPopulation) {
                    // 更新个体参数
                    individual.parameters.neighborhoodRadius = targetParams.neighborhoodRadius;
                    individual.parameters.normalSpeed = targetParams.normalSpeed;
                    individual.parameters.maxSpeed = targetParams.maxSpeed;
                    individual.parameters.c1 = targetParams.c1;
                    individual.parameters.c2 = targetParams.c2;
                    individual.parameters.c3 = targetParams.c3;
                    individual.parameters.c4 = targetParams.c4;
                    individual.parameters.c5 = targetParams.c5;
                }
            });
            
            // 更新显示
            updatePopulationDisplay();
        }
        
        // 重置选中种群参数
        function resetSelectedPopulation() {
            if (selectedPopulationIndex < 0 || !originalParameters) return;
            
            // 恢复原始参数
            currentPopulations[selectedPopulationIndex].parameters = { ...originalParameters };
            
            // 更新滑块显示
            updateSliders(originalParameters);
            
            // 应用更改
            applyParameterChanges();
        }
        
        // 预设配置 - 经典SwarmChemistry预设
        const presets = {
            uzushio: [
                { count: 49, params: [184.07, 12.64, 38.49, 0.67, 0.31, 63.78, 0.11, 0.21] },
                { count: 67, params: [177.92, 15.66, 11.05, 0.85, 0.41, 51.77, 0.09, 0.86] },
                { count: 58, params: [177.92, 15.66, 11.05, 0.85, 0.41, 51.77, 0.03, 0.86] },
                { count: 10, params: [298.48, 0.65, 19.27, 0.84, 0.11, 83.18, 0.24, 0.5] },
                { count: 37, params: [81.6, 18.34, 27.3, 0.94, 0.17, 3.41, 0.2, 0.9] },
                { count: 1, params: [274.4, 3.33, 7.42, 0.9, 0.19, 7.37, 0.43, 0.17] },
                { count: 12, params: [203.64, 3.33, 7.42, 0.9, 0.19, 7.37, 0.43, 0.17] }
            ],
            insurmountable_wall: [
                { count: 42, params: [52.57, 9.91, 20.42, 0.32, 0.76, 1.8, 0.01, 0.64] },
                { count: 25, params: [84.87, 8.82, 24.98, 0.91, 0.44, 40.97, 0.18, 0.6] },
                { count: 45, params: [220.42, 4.65, 7.53, 0.96, 0.35, 46.18, 0.25, 1.0] },
                { count: 49, params: [279.64, 10.29, 35.95, 0.37, 0.49, 38.09, 0.32, 0.89] }
            ],
            cell_with_two_nuclei: [
                { count: 41, params: [249.84, 4.85, 28.73, 0.34, 0.45, 14.44, 0.09, 0.82] },
                { count: 26, params: [277.87, 15.02, 35.48, 0.68, 0.05, 82.96, 0.46, 0.9] },
                { count: 30, params: [277.87, 15.02, 24.44, 0.68, 0.05, 82.96, 0.43, 0.9] },
                { count: 28, params: [110.8, 16.12, 38.6, 0.18, 0.34, 14.3, 0.01, 0.01] },
                { count: 48, params: [83.79, 13.29, 7.54, 0.08, 0.79, 1.07, 0.15, 0.45] },
                { count: 74, params: [269.64, 6.62, 34.69, 0.36, 0.5, 30.2, 0.03, 0.23] }
            ],
            multicellularity: [
                { count: 99, params: [19.8, 15.73, 2.61, 0.85, 0.64, 10.51, 0.17, 0.06] },
                { count: 48, params: [300.0, 14.63, 0.0, 0.48, 0.81, 90.27, 0.25, 0.78] },
                { count: 37, params: [275.18, 16.9, 7.05, 0.48, 0.81, 90.27, 0.17, 0.85] },
                { count: 8, params: [159.59, 2.09, 24.19, 0.96, 0.59, 76.03, 0.01, 0.07] },
                { count: 42, params: [73.07, 1.82, 2.36, 0.27, 0.61, 40.55, 0.22, 0.86] }
            ],
            jelly_fish: [
                { count: 134, params: [262.65, 12.01, 25.87, 0.97, 1.0, 56.35, 0.26, 0.61] },
                { count: 67, params: [288.17, 6.19, 23.37, 0.95, 1.0, 1.31, 0.1, 0.9] },
                { count: 68, params: [150.5, 12.97, 15.87, 0.46, 0.39, 57.95, 0.17, 0.48] }
            ],
            no_wait_this_way: [
                { count: 60, params: [262.68, 2.82, 38.32, 0.21, 0.01, 54.93, 0.11, 0.19] },
                { count: 40, params: [78.58, 5.7, 33.23, 0.89, 0.18, 45.44, 0.04, 0.05] },
                { count: 40, params: [257.27, 14.96, 35.66, 0.2, 0.8, 47.81, 0.13, 0.13] }
            ],
            recombining_blobs: [
                { count: 132, params: [45.91, 10.82, 21.11, 0.86, 0.13, 42.48, 0.32, 0.74] },
                { count: 84, params: [113.26, 3.41, 25.71, 0.4, 0.39, 49.53, 0.13, 0.24] }
            ],
            playing_catch: [
                { count: 76, params: [84.06, 0.09, 9.89, 0.33, 0.32, 15.66, 0.22, 0.68] },
                { count: 100, params: [158.86, 18.4, 24.98, 0.3, 0.3, 1.72, 0.06, 0.37] }
            ],
            pulsating_eye: [
                { count: 102, params: [293.86, 17.06, 38.3, 0.81, 0.05, 0.83, 0.2, 0.9] },
                { count: 124, params: [226.18, 19.27, 24.57, 0.95, 0.84, 13.09, 0.07, 0.8] },
                { count: 74, params: [49.98, 8.44, 4.39, 0.92, 0.14, 96.92, 0.13, 0.51] }
            ],
            chaos_cells: [
                { count: 144, params: [109.03, 6.71, 12.7, 0.47, 0.6, 61.43, 0.02, 0.21] },
                { count: 89, params: [117.15, 16.33, 31.88, 0.39, 0.13, 12.96, 0.48, 0.8] },
                { count: 67, params: [76.3, 8.59, 26.57, 0.7, 0.64, 28.39, 0.3, 0.35] }
            ],
            aggressive_predator: [
                { count: 18, params: [211.92, 12.59, 19.37, 0.09, 0.21, 57.92, 0.0, 0.95] },
                { count: 41, params: [257.27, 14.96, 35.66, 0.2, 0.8, 47.81, 0.13, 0.13] },
                { count: 35, params: [262.68, 2.82, 38.32, 0.21, 0.01, 54.93, 0.11, 0.19] },
                { count: 31, params: [78.58, 5.7, 33.23, 0.89, 0.18, 45.44, 0.04, 0.05] },
                { count: 7, params: [194.21, 12.88, 21.68, 0.97, 0.19, 99.21, 0.5, 0.13] }
            ],
            fast_walker_slow_follower: [
                { count: 67, params: [216.35, 11.75, 7.7, 0.83, 0.97, 97.31, 0.02, 0.38] },
                { count: 29, params: [254.64, 7.28, 7.0, 0.95, 0.11, 22.41, 0.43, 0.31] },
                { count: 13, params: [105.4, 3.55, 5.24, 0.34, 0.18, 23.53, 0.39, 0.24] }
            ],
            swinger: [
                { count: 48, params: [150.39, 15.89, 23.54, 0.74, 0.45, 62.65, 0.33, 0.13] },
                { count: 152, params: [217.14, 12.13, 12.42, 0.59, 0.98, 14.06, 0.04, 0.65] },
                { count: 14, params: [248.54, 5.85, 22.26, 0.43, 0.11, 17.14, 0.06, 0.68] },
                { count: 31, params: [141.53, 2.91, 4.86, 0.92, 0.03, 21.87, 0.28, 0.2] }
            ],
            rotary: [
                { count: 29, params: [122.13, 19.19, 17.98, 0.65, 0.44, 19.88, 0.46, 0.2] },
                { count: 51, params: [299.13, 0.79, 38.71, 0.25, 0.18, 86.49, 0.38, 0.43] },
                { count: 10, params: [252.92, 19.99, 10.21, 0.23, 0.17, 1.22, 0.28, 0.92] }
            ],
            wedding_ring: [
                { count: 24, params: [220.51, 13.88, 3.47, 0.46, 0.38, 6.23, 0.19, 0.68] },
                { count: 13, params: [64.07, 1.4, 19.7, 0.88, 0.27, 0.36, 0.47, 0.72] },
                { count: 35, params: [117.53, 7.31, 21.72, 0.3, 0.5, 98.69, 0.03, 0.29] }
            ],
            turbulent_runner: [
                { count: 131, params: [177.1, 9.71, 30.06, 0.8, 0.43, 19.65, 0.45, 0.91] },
                { count: 169, params: [277.3, 14.67, 37.71, 0.68, 0.23, 77.01, 0.02, 0.31] }
            ],
            blobs: [
                { count: 300, params: [20.8, 1.95, 20.75, 0.95, 0.99, 9.31, 0.05, 0.68] }
            ],
            linear_oscillator: [
                { count: 133, params: [214.41, 17.93, 35.14, 0.64, 0.13, 0.29, 0.08, 0.97] },
                { count: 24, params: [253.6, 7.19, 15.51, 0.82, 0.33, 32.65, 0.34, 0.56] }
            ]
        };
        
        // 加载预设
        function loadPreset(presetName) {
            if (!presets[presetName]) {
                console.error('未找到预设:', presetName);
                return;
            }
            
            individuals = [];
            const presetData = presets[presetName];
            
            // 计算画布中心点 - 适应新尺寸
            const centerX = 1200 / 2;
            const centerY = 900 / 2;
            const spawnRadius = 80;
            
            presetData.forEach((pop, index) => {
                const params = new SwarmParameters(
                    pop.params[0], pop.params[1], pop.params[2],
                    pop.params[3], pop.params[4], pop.params[5],
                    pop.params[6], pop.params[7]
                );
                
                // 生成个体
                for (let i = 0; i < pop.count; i++) {
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * spawnRadius;
                    
                    const x = centerX + Math.cos(angle) * radius;
                    const y = centerY + Math.sin(angle) * radius;
                    
                    individuals.push(new SwarmIndividual(
                        x, y,
                        (Math.random() - 0.5) * 2,
                        (Math.random() - 0.5) * 2,
                        params
                    ));
                }
            });
            
            updatePopulationDisplay();
            
            if (!isRunning) {
                startSimulation();
            }
            
            console.log(`🎯 加载预设: ${presetName}, 总粒子数: ${individuals.length}`);
        }
        
        // 控制函数
        function startSimulation() {
            isRunning = true;
        }
        
        function pauseSimulation() {
            isRunning = false;
        }
        
        function clearCanvas() {
            pauseSimulation();
            individuals = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updatePopulationDisplay();
        }
        
        function resetView() {
            initializeSwarm();
        }
        
        function togglePlayPause() {
            if (isRunning) {
                pauseSimulation();
            } else {
                startSimulation();
            }
        }
        
        // 解析自定义参数
        function parseCustomParameters() {
            const input = document.getElementById('parameterInput').value.trim();
            
            if (!input) {
                showParseStatus('请输入参数！', 'error');
                return;
            }
            
            showParseStatus('🔍 正在解析参数...', 'info');
            
            try {
                const lines = input.split('\n').filter(line => line.trim());
                individuals = [];
                let totalParsed = 0;
                
                // 计算画布中心点
                const centerX = 1200 / 2;
                const centerY = 900 / 2;
                const spawnRadius = 80;
                
                lines.forEach((line, index) => {
                    // 匹配格式: count * (param1, param2, param3, param4, param5, param6, param7, param8)
                    const match = line.trim().match(/(\d+)\s*\*\s*\(([^)]+)\)/);
                    
                    if (match) {
                        const count = parseInt(match[1]);
                        const params = match[2].split(',').map(p => parseFloat(p.trim()));
                        
                        if (params.length === 8 && params.every(p => !isNaN(p))) {
                            const swarmParams = new SwarmParameters(
                                params[0], params[1], params[2],
                                params[3], params[4], params[5],
                                params[6], params[7]
                            );
                            
                            // 生成个体
                            for (let i = 0; i < count; i++) {
                                const angle = Math.random() * 2 * Math.PI;
                                const radius = Math.random() * spawnRadius;
                                
                                const x = centerX + Math.cos(angle) * radius;
                                const y = centerY + Math.sin(angle) * radius;
                                
                                individuals.push(new SwarmIndividual(
                                    x, y,
                                    (Math.random() - 0.5) * 2,
                                    (Math.random() - 0.5) * 2,
                                    swarmParams
                                ));
                            }
                            
                            totalParsed += count;
                        } else {
                            throw new Error(`第 ${index + 1} 行参数格式错误：需要8个数值参数`);
                        }
                    } else {
                        throw new Error(`第 ${index + 1} 行格式错误：应为 "数量 * (参数1, 参数2, ...参数8)"`);
                    }
                });
                
                if (individuals.length === 0) {
                    throw new Error('没有找到有效的参数行');
                }
                
                updatePopulationDisplay();
                
                // 如果没有运行，开始模拟
                if (!isRunning) {
                    startSimulation();
                }
                
                showParseStatus(`✅ 解析成功！创建了 ${totalParsed} 个粒子`, 'success');
                console.log(`📝 自定义参数解析成功: ${totalParsed} 个粒子`);
                
            } catch (error) {
                console.error('❌ 参数解析失败:', error);
                showParseStatus(`❌ 解析失败: ${error.message}`, 'error');
            }
        }
        
        // 清空参数输入
        function clearParameters() {
            document.getElementById('parameterInput').value = '';
            showParseStatus('输入已清空', 'info');
            setTimeout(() => {
                document.getElementById('parseStatus').style.display = 'none';
            }, 2000);
        }
        
        // 显示解析状态
        function showParseStatus(message, type) {
            const statusDiv = document.getElementById('parseStatus');
            statusDiv.textContent = message;
            statusDiv.className = `parse-status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // 同步到Unity
        async function syncToUnity() {
            if (individuals.length === 0) {
                showSyncStatus('请先选择一个预设或输入参数！', 'error');
                return;
            }
            
            showSyncStatus('🚀 正在同步到Unity...', 'info');
            
            try {
                // 收集种群数据
                const populationStats = new Map();
                
                individuals.forEach(individual => {
                    const paramStr = individual.parameters.toString();
                    if (populationStats.has(paramStr)) {
                        populationStats.set(paramStr, populationStats.get(paramStr) + 1);
                    } else {
                        populationStats.set(paramStr, 1);
                    }
                });
                
                const populations = [];
                populationStats.forEach((count, paramStr) => {
                    // 从字符串中解析参数
                    const match = paramStr.match(/\(([^)]+)\)/);
                    if (match) {
                        const params = match[1].split(',').map(p => parseFloat(p.trim()));
                        populations.push({
                            count: count,
                            parameters: {
                                neighborhoodRadius: params[0],
                                normalSpeed: params[1],
                                maxSpeed: params[2],
                                c1: params[3],
                                c2: params[4],
                                c3: params[5],
                                c4: params[6],
                                c5: params[7],
                                color: `rgb(${Math.floor((params[3] / 1.0) * 0.8 * 255)}, ${Math.floor((params[4] / 1.0) * 0.8 * 255)}, ${Math.floor((params[5] / 100.0) * 0.8 * 255)})`
                            }
                        });
                    }
                });
                
                const swarmData = {
                    sessionId: 'web_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    timestamp: new Date().toISOString(),
                    populations: populations,
                    totalIndividuals: individuals.length,
                    userAgent: navigator.userAgent,
                    source: 'SwarmChemistry Web Cloud'
                };
                
                console.log('📤 发送数据到服务器:', swarmData);
                
                const response = await fetch(SYNC_CONFIG.serverUrl + '/swarm-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(swarmData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSyncStatus(`✅ 同步成功！数据ID: ${result.dataId}`, 'success');
                    console.log('✅ 同步成功:', result);
                } else {
                    throw new Error(result.message || '同步失败');
                }
                
            } catch (error) {
                console.error('❌ 同步失败:', error);
                showSyncStatus(`❌ 同步失败: ${error.message}`, 'error');
            }
        }
        
        // 显示同步状态
        function showSyncStatus(message, type) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.textContent = message;
            statusDiv.className = `sync-status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        console.log('🌐 SwarmChemistry 云端版加载完成');
        console.log('🔗 API端点:', SYNC_CONFIG.serverUrl);
    </script>
</body>
</html> 